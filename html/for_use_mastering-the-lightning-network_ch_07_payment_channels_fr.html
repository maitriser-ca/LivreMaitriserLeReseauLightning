<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Canaux de paiement</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-2">
<h2 id="payment_channels">Canaux de paiement</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>Dans ce chapitre, nous allons plonger dans les canaux de paiement et voir comment ils sont construits. Nous commencerons par le nœud d&#8217;Alice ouvrant un canal vers le nœud de Bob, en nous appuyant sur les exemples présentés au début de ce livre.</p>
</div>
<div class="paragraph pagebreak-after data-line-7">
<p>Les messages échangés par les nœuds d&#8217;Alice et de Bob sont définis dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">"BOLT #2: Peer Protocol for Channel Management"</a>. Les transactions créées par les nœuds d&#8217;Alice et de Bob sont définies dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md">"BOLT #3: Bitcoin Transaction and Script Formats"</a>. Dans ce chapitre, nous nous concentrons sur les parties "Channel open and close" et "Channel state machine" de l&#8217;architecture du protocole Lightning, mises en évidence par un contour au centre (couche pair-à-pair) de <a href="#LN_protocol_channel_highlight">Canaux de paiement dans la suite de protocoles Lightning</a>.</p>
</div>
<div id="LN_protocol_channel_highlight" class="imageblock data-line-11">
<div class="content">
<img src="images/mtln_0701.png" alt="Canaux de paiement dans la suite de protocoles Lightning">
</div>
<div class="title">Figure 1. Canaux de paiement dans la suite de protocoles Lightning</div>
</div>
<div class="sect2 data-line-13">
<h3 id="_une_manière_différente_dutiliser_le_système_bitcoin">Une manière différente d&#8217;utiliser le système Bitcoin</h3>
<div class="paragraph data-line-15">
<p>Le Lightning Network est souvent décrit comme un "protocole Bitcoin de couche 2", ce qui le rend distinct de Bitcoin. Une autre façon de décrire Lightning est comme une "façon plus intelligente d&#8217;utiliser Bitcoin" ou simplement comme une "application au-dessus de Bitcoin". Explorons cela.</p>
</div>
<div class="paragraph data-line-17">
<p>Historiquement, les transactions Bitcoin sont diffusées à tout le monde et enregistrées sur la blockchain Bitcoin pour être considérées comme valides. Comme nous le verrons, cependant, si quelqu&#8217;un détient une transaction Bitcoin présignée qui dépense une sortie multisig 2-de-2 qui lui donne la capacité exclusive de dépenser ces bitcoins, il possède effectivement ce Bitcoin même s&#8217;il ne diffuse pas la transaction.</p>
</div>
<div class="paragraph data-line-19">
<p>Vous pouvez considérer la transaction Bitcoin présignée comme un chèque postdaté, qui peut être encaissé à tout moment. Contrairement au système bancaire traditionnel, cependant, cette transaction n&#8217;est pas une "promesse" de paiement (également connue sous le nom de reconnaissance de dette), mais un instrument au porteur vérifiable qui équivaut à des espèces. Tant que les bitcoins référencés dans la transaction n&#8217;ont pas déjà été dépensés au moment du remboursement (ou au moment où vous essayez "d&#8217;encaisser" le chèque), le système Bitcoin garantit que cette transaction présignée pourra être diffusée et enregistrée à tout moment. Ceci n&#8217;est vrai, bien sûr, que s&#8217;il s&#8217;agit de la seule transaction présignée. Au sein du Lightning Network, deux transactions pré-signées ou plus existent en même temps ; par conséquent, nous avons besoin d&#8217;un mécanisme plus sophistiqué pour conserver la fonctionnalité d&#8217;un tel instrument au porteur vérifiable, comme vous l&#8217;apprendrez également dans ce chapitre.</p>
</div>
<div class="paragraph data-line-21">
<p>Le Lightning Network est simplement une manière différente et créative d&#8217;utiliser Bitcoin. Sur le Lightning Network, une combinaison de transactions enregistrées (sur la chaîne) et présignées mais retenues (hors chaîne) forme une "couche" de paiements qui est un moyen plus rapide, moins cher et plus privé d&#8217;utiliser Bitcoin. Vous pouvez voir cette relation entre les transactions Bitcoin sur la chaîne et hors chaîne dans <a href="#on_off_chain">Canal de paiement Lightning composé de transactions sur la chaîne et hors chaîne</a>.</p>
</div>
<div id="on_off_chain" class="imageblock data-line-25">
<div class="content">
<img src="images/mtln_0702.png" alt="Canal de paiement Lightning composé de transactions sur la chaîne et hors chaîne">
</div>
<div class="title">Figure 2. Canal de paiement Lightning composé de transactions sur la chaîne et hors chaîne</div>
</div>
<div class="paragraph data-line-27">
<p>Lightning c&#8217;est Bitcoin. C&#8217;est juste une façon différente d&#8217;utiliser le système Bitcoin.</p>
</div>
</div>
<div class="sect2 data-line-29">
<h3 id="_propriété_et_contrôle_de_bitcoin">Propriété et contrôle de Bitcoin</h3>
<div class="paragraph data-line-31">
<p>Avant de comprendre les canaux de paiement, nous devons prendre un peu de recul et comprendre comment la propriété et le contrôle fonctionnent dans Bitcoin.</p>
</div>
<div class="paragraph data-line-33">
<p>Quand quelqu&#8217;un dit qu&#8217;il "possède" des bitcoins, cela signifie généralement qu&#8217;il connaît la clé privée d&#8217;une adresse Bitcoin qui a des sorties de transaction non dépensées (voir <a href="#bitcoin_fundamentals_review">[bitcoin_fundamentals_review]</a>). La clé privée leur permet de signer une transaction pour dépenser ces bitcoins en les transférant à une adresse différente. Dans Bitcoin, la "propriété" de bitcoins peut être définie comme la <em>capacité à dépenser</em> ces bitcoins.</p>
</div>
<div class="paragraph data-line-35">
<p>Gardez à l&#8217;esprit que le terme "propriété" tel qu&#8217;il est utilisé dans Bitcoin est distinct du terme "propriété" utilisé dans un sens juridique. Un voleur qui a les clés privées et peut dépenser des bitcoins est un <em>propriétaire de facto</em> de ces bitcoins même s&#8217;il n&#8217;en est pas le propriétaire légitime.</p>
</div>
<div class="admonitionblock tip data-line-38">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-39">
<p>La propriété de Bitcoin concerne uniquement le contrôle des clés et la possibilité de dépenser les bitcoins avec ces clés. Comme le dit le dicton populaire de Bitcoin : "Vos clés, vos pièces, pas vos clés, pas vos pièces."</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-42">
<h4 id="_diversité_de_propriété_indépendante_et_multisig">Diversité de propriété (indépendante) et Multisig</h4>
<div class="paragraph data-line-44">
<p>La propriété et le contrôle des clés privées ne sont pas toujours entre les mains d&#8217;une seule personne. C&#8217;est là que les choses deviennent intéressantes et compliquées. Nous savons que plusieurs personnes peuvent connaître la même clé privée, soit par vol, soit parce que le détenteur d&#8217;origine de la clé en fait une copie et la donne à quelqu&#8217;un d&#8217;autre. Toutes ces personnes sont-elles propriétaires ? Dans la pratique, c&#8217;est le cas, car n&#8217;importe quelle personne connaissant la clé privée peut dépenser les bitcoins sans l&#8217;approbation de toute autre personne.</p>
</div>
<div class="paragraph data-line-46">
<p>Bitcoin a également des adresses multisignatures où plusieurs clés privées sont nécessaires pour signer avant de dépenser (voir <a href="#multisig">[multisig]</a>). D&#8217;un point de vue pratique, la propriété d&#8217;une adresse multisignature dépend du quorum (<em>K</em>) et du total (<em>N</em>) définis dans le schéma <em>K</em>-de-<em>N</em>. Un schéma multisignature 1-de-10 permettrait à 1 (<em>K</em>) des 10 (<em>N</em>) signataires de dépenser un montant en bitcoins bloqué à cette adresse. Ceci est similaire au scénario où 10 personnes ont une copie de la même clé privée et chacune d&#8217;entre elles peut le dépenser indépendamment.</p>
</div>
</div>
<div class="sect3 data-line-48">
<h4 id="_copropriété_sans_contrôle_indépendant">Copropriété sans contrôle indépendant</h4>
<div class="paragraph data-line-50">
<p>Il y a aussi le scénario où <em>personne</em> n&#8217;a le quorum. Dans un schéma 2-de-2 comme celui utilisé dans le Lightning Network, aucun signataire ne peut dépenser les bitcoins sans obtenir une signature de l&#8217;autre partie. À qui appartiennent les bitcoins dans ce cas ? Personne n&#8217;a vraiment la propriété car personne n&#8217;a le contrôle. Ils possèdent chacun l&#8217;équivalent d&#8217;une part de vote dans la décision, mais les deux votes sont nécessaires. Un problème clé (jeu de mots) avec un schéma 2-de-2, à la fois dans Bitcoin et dans la loi, est ce qui se produit si l&#8217;une des parties n&#8217;est pas disponible, ou s&#8217;il y a une impasse de vote et qu&#8217;une partie refuse de coopérer.</p>
</div>
</div>
<div class="sect3 data-line-52">
<h4 id="_éviter_les_bitcoins_verrouillés_et_non_dépensables">Éviter les bitcoins "verrouillés" et non dépensables</h4>
<div class="paragraph data-line-54">
<p>Si l&#8217;un des deux signataires d&#8217;un multisig 2-de-2 ne peut ou ne veut pas signer, les fonds deviennent non dépensables. Non seulement ce scénario peut se produire accidentellement (perte des clés), mais il peut être utilisé comme une forme de chantage par l&#8217;une ou l&#8217;autre des parties : "Je ne signerai que si vous me versez une partie des fonds".</p>
</div>
<div class="paragraph data-line-56">
<p>Les canaux de paiement dans Lightning sont basés sur une adresse multisig 2-de-2, avec les deux partenaires de canal en tant que signataires dans le multisig. À l&#8217;heure actuelle, les canaux ne sont financés que par l&#8217;un des deux partenaires de canal : lorsque vous choisissez "d&#8217;ouvrir" un canal, vous déposez des fonds dans l&#8217;adresse multisig 2-de-2 avec une transaction. Une fois que cette transaction est minée et que les fonds sont dans le multisig, vous ne pouvez pas les récupérer sans la coopération de votre partenaire de canal, car vous avez besoin de leur signature (également) pour dépenser les bitcoins.</p>
</div>
<div class="paragraph data-line-58">
<p>Dans la section suivante, en examinant comment ouvrir (créer) un canal Lightning, nous verrons comment nous pouvons prévenir la perte de fonds ou tout scénario de chantage entre les deux partenaires en mettant en œuvre un protocole d&#8217;équité pour la construction du canal avec l&#8217;aide de transactions présignées qui dépensent la sortie multisig d&#8217;une manière qui donne aux pairs du canal la possibilité exclusive de dépenser l&#8217;une des sorties qui encode la quantité de bitcoins qu&#8217;ils possèdent dans le canal.</p>
</div>
</div>
</div>
<div class="sect2 data-line-61">
<h3 id="_construire_un_canal_de_paiement">Construire un canal de paiement</h3>
<div class="paragraph data-line-63">
<p>Dans <a href="#what_is_payment_channel">[what_is_payment_channel]</a>, nous avons décrit les canaux de paiement comme une <em>relation financière</em> entre deux nœuds Lightning, qui est établie en finançant une adresse multisignature 2-de-2 entre deux partenaires de canal.</p>
</div>
<div class="paragraph data-line-65">
<p>Supposons qu&#8217;Alice veuille construire un canal de paiement lui permettant de se connecter directement au magasin de Bob. Tout d&#8217;abord, les deux nœuds (celui d&#8217;Alice et celui de Bob) doivent établir une connexion Internet l&#8217;un avec l&#8217;autre, afin qu&#8217;ils puissent négocier un canal de paiement.</p>
</div>
<div class="sect3 data-line-67">
<h4 id="_clés_privées_et_publiques_du_nœud">Clés privées et publiques du nœud</h4>
<div class="paragraph data-line-69">
<p>Chaque nœud du Lightning Network est identifié par une <em>clé de nœud publique</em>. La clé publique identifie de manière unique le nœud spécifique et est généralement présentée sous la forme d&#8217;un codage hexadécimal. Par exemple, René Pickhardt exécute actuellement un Lightning Node (ln.rene-pickhardt.de) qui est identifié par la clé publique de nœud suivante :</p>
</div>
<div class="listingblock data-line-71">
<div class="content">
<pre>02a1cebfacb2674143b5ad0df3c22c609e935f7bc0ebe801f37b8e9023d45ea7b8</pre>
</div>
</div>
<div class="paragraph data-line-75">
<p>Chaque nœud génère une clé privée racine lors de sa première initialisation. La clé privée est gardée privée à tout moment (jamais partagée) et stockée en toute sécurité dans le porte-monnaie du nœud. A partir de cette clé privée, le nœud dérive une clé publique qui est l&#8217;identifiant du nœud et est partagée avec le réseau. L&#8217;espace de clés étant énorme, tant que chaque nœud génère aléatoirement la clé privée, il aura une clé publique unique, qui pourra donc l&#8217;identifier de manière unique sur le réseau.</p>
</div>
</div>
<div class="sect3 data-line-77">
<h4 id="_adresse_réseau_du_nœud">Adresse réseau du nœud</h4>
<div class="paragraph data-line-79">
<p>De plus, chaque nœud annonce également une adresse réseau à laquelle il peut être atteint, dans l&#8217;un des nombreux formats possibles :</p>
</div>
<div class="dlist data-line-81">
<dl>
<dt class="hdlist1">TCP/IP</dt>
<dd>
<p>Une adresse IPv4 ou IPv6 et un numéro de port TCP</p>
</dd>
<dt class="hdlist1">TCP/Tor</dt>
<dd>
<p>Une adresse "onion" de Tor et un numéro de port TCP</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-85">
<p>L&#8217;identifiant d&#8217;adresse réseau est écrit sous la forme Address:Port, ce qui est conforme aux normes internationales pour les identifiants de réseau, tels qu&#8217;utilisés, par exemple, sur le Web.</p>
</div>
<div class="paragraph data-line-87">
<p>Par exemple, le nœud de René avec la clé publique de nœud 02a1ceb...45ea7b8 annonce actuellement son adresse réseau comme adresse TCP/IP :</p>
</div>
<div class="listingblock data-line-89">
<div class="content">
<pre>172.16.235.20:9735</pre>
</div>
</div>
<div class="admonitionblock tip data-line-94">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-95">
<p>Le port TCP par défaut pour le Lightning Network est 9735, mais un nœud peut choisir d&#8217;écouter sur n&#8217;importe quel port TCP.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-98">
<h4 id="_identifiants_de_nœud">Identifiants de nœud</h4>
<div class="paragraph data-line-100">
<p>Ensemble, la clé publique du nœud et l&#8217;adresse réseau sont écrites dans le format suivant, séparés par un signe @, comme <em>NodeID@Address:Port</em>.</p>
</div>
<div class="paragraph data-line-102">
<p>Ainsi, l&#8217;identifiant complet du nœud de René serait :</p>
</div>
<div class="listingblock data-line-104">
<div class="content">
<pre>02a1cebfacb2674143b5ad0df3c22c609e935f7bc0ebe801f37b8e9023d45ea7b8
@172.16.235.20:9735</pre>
</div>
</div>
<div class="admonitionblock tip data-line-110">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-111">
<p>L&#8217;alias du nœud de René est ln.rene-pickhardt.de ; cependant, ce nom existe juste pour une meilleure lisibilité. Chaque opérateur de nœud peut annoncer l&#8217;alias qu&#8217;il souhaite, et aucun mécanisme n&#8217;empêche les opérateurs de nœud de sélectionner un alias déjà utilisé. Ainsi pour faire référence à un nœud, il faut utiliser le schéma <em>NodeID@Address:Port</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-114">
<p>L&#8217;identifiant précédent est souvent codé en un code QR, ce qui permet aux utilisateurs de le scanner plus facilement s&#8217;ils souhaitent connecter leur propre nœud au nœud identifié spécifiquement par cette adresse.</p>
</div>
<div class="paragraph data-line-116">
<p>Tout comme les nœuds Bitcoin, les nœuds Lightning annoncent leur présence sur le Lightning Network en "bavardant" leur clé publique de nœud et leur adresse réseau. De cette façon, d&#8217;autres nœuds peuvent les trouver et conserver un inventaire (base de données) de tous les nœuds connus auxquels ils peuvent se connecter et échanger les messages définis dans le protocole de message P2P de Lightning.</p>
</div>
</div>
<div class="sect3 data-line-118">
<h4 id="_connecter_des_nœuds_en_tant_que_pairs_directs">Connecter des nœuds en tant que pairs directs</h4>
<div class="paragraph data-line-120">
<p>Pour que le nœud d&#8217;Alice se connecte au nœud de Bob, elle aura besoin de la clé publique du nœud de Bob, ou de l&#8217;adresse complète contenant la clé publique, l&#8217;adresse IP ou Tor, et le port. Étant donné que Bob gère un magasin, l&#8217;adresse du nœud de Bob peut être récupérée à partir d&#8217;une facture ou d&#8217;une page de paiement de magasin sur le Web. Alice peut scanner un code QR contenant l&#8217;adresse et demander à son nœud de se connecter au nœud de Bob.</p>
</div>
<div class="paragraph data-line-122">
<p>Une fois qu&#8217;Alice s&#8217;est connectée au nœud de Bob, leurs nœuds sont maintenant des pairs directement connectés.</p>
</div>
<div class="admonitionblock tip data-line-125">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-126">
<p>Pour ouvrir un canal de paiement, deux nœuds doivent d&#8217;abord être connectés en tant que pairs directs en ouvrant une connexion sur Internet (ou Tor).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2 data-line-129">
<h3 id="_construire_le_canal">Construire le canal</h3>
<div class="paragraph data-line-131">
<p>Maintenant que les nœuds Lightning d&#8217;Alice et de Bob sont connectés, ils peuvent commencer le processus de construction d&#8217;un canal de paiement. Dans cette section, nous passerons en revue les communications entre leurs nœuds, connus sous le nom de <em>Protocole de pairs Lightning pour la gestion des canaux</em>, et le protocole cryptographique qu&#8217;ils utilisent pour créer des transactions Bitcoin.</p>
</div>
<div class="admonitionblock tip data-line-134">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-135">
<p>Nous décrivons deux protocoles différents dans ce scénario. Tout d&#8217;abord, il existe un <em>protocole de messages</em>, qui établit comment les nœuds Lightning communiquent sur Internet et quels messages ils échangent entre eux. Deuxièmement, il y a le <em>protocole cryptographique</em>, qui établit comment les deux nœuds construisent et signent des <span class="keep-together">transactions</span> Bitcoin.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-139">
<h4 id="peer_protocol_channel_management">Protocole de pairs pour la gestion des canaux</h4>
<div class="paragraph data-line-141">
<p>Le Lightning Peer Protocol for Channel Management est défini dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">BOLT #2: Peer Protocol for Channel Management</a>. Dans ce chapitre, nous examinerons plus en détail les sections "Channel Establishment" et "Channel Closing" du BOLT #2.</p>
</div>
</div>
<div class="sect3 data-line-143">
<h4 id="_flux_des_messages_détablissement_dun_canal">Flux des messages d&#8217;établissement d&#8217;un canal</h4>
<div class="paragraph data-line-145">
<p>L&#8217;établissement d&#8217;un canal est réalisé par l&#8217;échange de six messages entre les nœuds d&#8217;Alice et de Bob (trois par chaque pair) : open_channel, accept_channel, funding_created, funding_signed, funding_locked et funding_locked. Les six messages sont affichés sous la forme d&#8217;une diagramme temps-séquence dans <a href="#funding_message_flow">Le flux des messages d&#8217;établissement d&#8217;un canal</a>.</p>
</div>
<div id="funding_message_flow" class="imageblock data-line-149">
<div class="content">
<img src="images/mtln_0703.png" alt="Le flux des messages d&#8217;établissement d&#8217;un canal">
</div>
<div class="title">Figure 3. Le flux des messages d&#8217;établissement d&#8217;un canal</div>
</div>
<div class="paragraph data-line-151">
<p>Dans <a href="#funding_message_flow">Le flux des messages d&#8217;établissement d&#8217;un canal</a>, les nœuds d&#8217;Alice et de Bob sont représentés par les lignes verticales "A" et "B" de part et d&#8217;autre du diagramme. Un diagramme séquence-temps comme celui-ci montre le temps s&#8217;écoulant vers le bas et les messages circulant d&#8217;un côté à l&#8217;autre entre les deux pairs en communication. Les lignes sont inclinées vers le bas pour représenter le temps écoulé nécessaire pour transmettre chaque message, et la direction du message est indiquée par une flèche à la fin de chaque ligne.</p>
</div>
<div class="paragraph data-line-153">
<p>L&#8217;établissement du canal comporte trois parties. Tout d&#8217;abord, les deux pairs communiquent leurs capacités et leurs attentes, Alice lançant une demande via open_channel et Bob acceptant la demande de canal via accept_channel.</p>
</div>
<div class="paragraph data-line-155">
<p>Deuxièmement, Alice construit les transactions de financement et de remboursement (comme nous le verrons plus loin dans cette section) et envoie funding_created à Bob. Un autre nom pour la transaction de "remboursement" est une transaction "d&#8217;engagement", car elle s&#8217;engage sur la répartition actuelle des soldes dans le canal. Bob répond en renvoyant les signatures nécessaires avec funding_signed. Cette interaction est la base du <em>protocole cryptographique</em> pour sécuriser le canal et empêcher le vol. Alice va maintenant diffuser la transaction de financement (sur la chaîne) pour établir et ancrer le canal de paiement. La transaction devra être confirmée sur la blockchain Bitcoin.</p>
</div>
<div class="admonitionblock tip data-line-158">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-159">
<p>Le nom du message funding_signed peut prêter à confusion. Ce message ne contient pas de signature pour la transaction de financement, mais plutôt la signature de Bob pour la transaction de remboursement qui permet à Alice de réclamer ses bitcoins depuis le multisig.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-162">
<p>Une fois que la transaction a reçu suffisamment de confirmations (comme défini par le champ <code>minimum_depth</code> dans le message <code>accept_channel</code>), Alice et Bob échangent des messages funding_locked, et le canal passe en mode de fonctionnement normal.</p>
</div>
<div class="sect4 data-line-164">
<h5 id="_le_message_open_channel">Le message open_channel</h5>
<div class="paragraph data-line-166">
<p>Le nœud d&#8217;Alice demande un canal de paiement avec le nœud de Bob en envoyant un message open_channel. Le message contient des informations sur les <em>attentes</em> d&#8217;Alice pour la configuration du canal, que Bob peut accepter ou refuser.</p>
</div>
<div class="paragraph data-line-168">
<p>La structure du message open_channel (tiré du BOLT #2) est illustrée dans <a href="#open_channel_message">Le message <code>open_channel</code></a>.</p>
</div>
<div id="open_channel_message" class="exampleblock data-line-172">
<div class="title">Example 1. Le message <code>open_channel</code></div>
<div class="content">
<div class="listingblock data-line-173">
<div class="content">
<pre>[chain_hash:chain_hash]
[32*byte:temporary_channel_id]
[u64:funding_satoshis]
[u64:push_msat]
[u64:dust_limit_satoshis]
[u64:max_htlc_value_in_flight_msat]
[u64:channel_reserve_satoshis]
[u64:htlc_minimum_msat]
[u32:feerate_per_kw]
[u16:to_self_delay]
[u16:max_accepted_htlcs]
[point:funding_pubkey]
[point:revocation_basepoint]
[point:payment_basepoint]
[point:delayed_payment_basepoint]
[point:htlc_basepoint]
[point:first_per_commitment_point]
[byte:channel_flags]
[open_channel_tlvs:tlvs]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-196">
<p>Les champs contenus dans ce message spécifient les paramètres de canal qu&#8217;Alice souhaite, ainsi que divers paramètres de configuration des nœuds d&#8217;Alice qui reflètent les attentes de sécurité pour le fonctionnement du canal.</p>
</div>
<div class="paragraph pagebreak-before data-line-199">
<p>Certains des paramètres de construction du canal sont répertoriés ici :</p>
</div>
<div class="dlist data-line-201">
<dl>
<dt class="hdlist1">chain_hash</dt>
<dd>
<p>Cela identifie quelle blockchain (par exemple, le mainnet Bitcoin) sera utilisée pour ce canal. Il s&#8217;agit généralement du hachage du bloc de genèse de cette blockchain.</p>
</dd>
<dt class="hdlist1">funding_satoshis</dt>
<dd>
<p>Le montant qu&#8217;Alice utilisera pour financer le canal, qui correspond à la capacité totale du canal.</p>
</dd>
<dt class="hdlist1">channel_reserve_satoshis</dt>
<dd>
<p>Le solde minimum, en satoshis, qui est réservé de chaque côté d&#8217;un canal. Nous y reviendrons lorsque nous parlerons des pénalités.</p>
</dd>
<dt class="hdlist1">push_msat</dt>
<dd>
<p>Un montant facultatif qu&#8217;Alice "poussera" immédiatement à Bob en guise de paiement lors du financement du canal. <em>Définir cette valeur sur autre chose que 0 signifie effectivement offrir de l&#8217;argent à votre partenaire de canal et doit être utilisé avec prudence.</em></p>
</dd>
<dt class="hdlist1">to_self_delay</dt>
<dd>
<p>Un paramètre de sécurité très important pour le protocole. La valeur dans le message <code>open_channel</code> est utilisée dans la transaction d&#8217;engagement du répondant, et <code>accept_channel</code> dans celle de l&#8217;initiateur. Cette asymétrie existe pour permettre à chaque partie d&#8217;exprimer combien de temps l&#8217;autre partie doit attendre pour réclamer unilatéralement les fonds dans une transaction d&#8217;engagement. Si Bob ferme à tout moment unilatéralement le canal contre la volonté d&#8217;Alice, il s&#8217;engage à ne pas accéder à ses propres fonds pendant le délai défini ici. Plus cette valeur est élevée, plus Alice a de sécurité, mais plus Bob peut avoir ses fonds bloqués longtemps.</p>
</dd>
<dt class="hdlist1">funding_pubkey</dt>
<dd>
<p>La clé publique qu&#8217;Alice contribuera au multisig 2-de-2 qui ancre ce canal.</p>
</dd>
<dt class="hdlist1">X_basepoint</dt>
<dd>
<p>Clés principales, utilisées pour dériver des clés enfants pour diverses parties de l&#8217;engagement, de la révocation, du paiement routé (HTLC) et des transactions de fermeture. Celles-ci seront utilisés et expliqués dans les chapitres suivants.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip data-line-216">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-217">
<p>Si vous souhaitez comprendre les autres champs et messages du protocole d&#8217;homologue Lightning dont nous ne parlons pas dans ce livre, nous vous suggérons de les rechercher dans les spécifications BOLT. Ces messages et champs sont importants, mais ne peuvent pas être couverts de manière suffisamment détaillée dans le cadre de ce livre. Nous voulons que vous compreniez suffisamment bien les principes fondamentaux pour que vous puissiez compléter ces détails en lisant la spécification complète du protocole (BOLT).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-220">
<h5 id="_le_message_accept_channel">Le message accept_channel</h5>
<div class="paragraph data-line-222">
<p>En réponse au message open_channel d&#8217;Alice, Bob renvoie le message accept_channel illustré dans <a href="#accept_channel_message">Le message <code>accept_channel</code></a>.</p>
</div>
<div id="accept_channel_message" class="exampleblock data-line-226">
<div class="title">Example 2. Le message <code>accept_channel</code></div>
<div class="content">
<div class="listingblock data-line-227">
<div class="content">
<pre>[32*byte:temporary_channel_id]
[u64:dust_limit_satoshis]
[u64:max_htlc_value_in_flight_msat]
[u64:channel_reserve_satoshis]
[u64:htlc_minimum_msat]
[u32:minimum_depth]
[u16:to_self_delay]
[u16:max_accepted_htlcs]
[point:funding_pubkey]
[point:revocation_basepoint]
[point:payment_basepoint]
[point:delayed_payment_basepoint]
[point:htlc_basepoint]
[point:first_per_commitment_point]
[accept_channel_tlvs:tlvs]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-246">
<p>Comme vous pouvez le voir, ceci est similaire au message open_channel et contient les attentes de nœud et les valeurs de configuration de Bob.</p>
</div>
<div class="paragraph data-line-248">
<p>Les deux champs les plus importants dans accept_channel qu&#8217;Alice utilisera pour construire le canal de paiement sont :</p>
</div>
<div class="dlist data-line-250">
<dl>
<dt class="hdlist1">funding_pubkey</dt>
<dd>
<p>La clé publique du nœud de Bob contribuant à l&#8217;adresse multisig 2-de-2 qui ancre le canal.</p>
</dd>
<dt class="hdlist1">minimum_depth</dt>
<dd>
<p>Le nombre de confirmations que le nœud de Bob attend pour la transaction de financement avant de considérer le canal comme "ouvert" et prêt à être utilisé.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3 data-line-254">
<h4 id="_la_transaction_de_financement">La transaction de financement</h4>
<div class="paragraph data-line-256">
<p>Une fois que le nœud d&#8217;Alice reçoit le message accept_channel de Bob, il dispose des informations nécessaires pour construire la <em>transaction de financement</em> qui ancre le canal sur la blockchain Bitcoin. Comme nous l&#8217;avons vu dans les chapitres précédents, un canal de paiement Lightning est ancré par une adresse multisignature 2-de-2. Tout d&#8217;abord, nous devons générer cette adresse multisignature pour nous permettre de construire la transaction de financement (et la transaction de remboursement comme décrit par la suite).</p>
</div>
</div>
<div class="sect3 data-line-258">
<h4 id="_génération_dune_adresse_multisignature">Génération d&#8217;une adresse multisignature</h4>
<div class="paragraph data-line-260">
<p>La transaction de financement envoie une certaine quantité de bitcoin (funding_satoshis du message open_channel) à une sortie multisignature 2-de-2 construite à partir des clés publiques funding_pubkey d&#8217;Alice et Bob.</p>
</div>
<div class="paragraph data-line-262">
<p>Le nœud d&#8217;Alice construit un script multisignature comme illustré ici :</p>
</div>
<pre data-type="programlisting">2 &lt;<em>Alice_funding_pubkey</em>&gt; &lt;<em>Bob_funding_pubkey</em>&gt; 2 CHECKMULTISIG
</pre>
<div class="paragraph data-line-269">
<p>Notez qu&#8217;en pratique, les clés de financement sont <em>triées</em> de manière déterministe (en utilisant l&#8217;ordre lexicographique de la forme compressée sérialisée des clés publiques) avant d&#8217;être placées dans le script "witness". En convenant à l&#8217;avance de cet ordre trié, nous nous assurons que les deux parties construiront une sortie de transaction de financement identique, qui est signée par la signature de transaction d&#8217;engagement échangée.</p>
</div>
<div class="paragraph data-line-272">
<p>Ce script est encodé sous la forme d&#8217;une adresse Bitcoin Pay-to-Witness-Script-Hash (P2WSH), qui ressemble à ceci :</p>
</div>
<div class="listingblock data-line-274">
<div class="content">
<pre>bc1q89ju02heg32yrqdrnqghe6132wek25p6sv6e564znvrvez7tq5zqt4dn02</pre>
</div>
</div>
</div>
<div class="sect3 data-line-277">
<h4 id="_construction_de_la_transaction_de_financement">Construction de la transaction de financement</h4>
<div class="paragraph data-line-279">
<p>Le nœud d&#8217;Alice peut maintenant construire une transaction de financement, en envoyant le montant convenu avec Bob (<code>funding_satoshis</code>) à l&#8217;adresse multisig 2-de-2. Supposons que le <code>funding_satoshis</code> était de 140 000 et qu&#8217;Alice dépense une sortie de 200 000 satoshis et crée 60 000 satoshis de monnaie. La transaction ressemblera à quelque chose comme <a href="#A_B_funding_Tx">Alice construit la transaction de financement</a>.</p>
</div>
<div id="A_B_funding_Tx" class="imageblock data-line-283">
<div class="content">
<img src="images/mtln_0704.png" alt="Alice construit la transaction de financement">
</div>
<div class="title">Figure 4. Alice construit la transaction de financement</div>
</div>
<div class="paragraph data-line-285">
<p>Alice <em>ne diffuse pas</em> cette transaction car cela mettrait ses 140 000 satoshis en danger. Une fois dépensé pour le multisig 2-de-2, il n&#8217;y a aucun moyen pour Alice de récupérer son argent sans la signature de Bob.</p>
</div>
<div class="sidebarblock pagebreak-before less_space data-line-289">
<div class="content">
<div class="title">Canaux de paiement à double financement</div>
<div class="paragraph data-line-290">
<p>Dans l&#8217;implémentation actuelle de Lightning, les canaux sont financés uniquement par le nœud qui initie le canal (Alice dans notre exemple). Des canaux à double financement ont été proposés, mais pas encore mis en œuvre. Dans un canal à double financement, Alice et Bob contribueraient à la transaction de financement. Les canaux à double financement nécessitent un flux de messages et un protocole cryptographique légèrement plus compliqués, ils n&#8217;ont donc pas encore été implémentés mais sont prévus pour une future mise à jour des Lightning BOLT. L&#8217;implémentation <code>c-lightning</code> comprend une version expérimentale d&#8217;une variante de canaux à double financement.</p>
</div>
</div>
</div>
</div>
<div class="sect3 data-line-293">
<h4 id="_détention_de_transactions_signées_sans_diffusion">Détention de transactions signées sans diffusion</h4>
<div class="paragraph data-line-295">
<p>Une caractéristique importante de Bitcoin qui rend Lightning possible est la possibilité de construire et de signer des transactions, mais de ne pas les diffuser. La transaction est <em>valide</em> à tous points de vue, mais tant qu&#8217;elle n&#8217;est pas diffusée et confirmée sur la blockchain Bitcoin, elle n&#8217;est pas reconnue et ses sorties ne sont pas dépensables car elles n&#8217;ont pas été créées sur la blockchain. Nous utiliserons cette capacité plusieurs fois dans le Lightning Network, et le nœud d&#8217;Alice utilise cette capacité lors de la construction de la transaction de financement : la conserver et ne pas encore la diffuser.</p>
</div>
</div>
<div class="sect3 data-line-297">
<h4 id="_remboursement_avant_financement">Remboursement avant financement</h4>
<div class="paragraph data-line-299">
<p>Pour éviter toute perte de fonds, Alice ne peut pas mettre ses bitcoins dans un 2-de-2 tant qu&#8217;elle n&#8217;a pas un moyen d&#8217;obtenir un remboursement si les choses tournent mal. Essentiellement, elle doit planifier la "sortie" du canal avant de conclure cet arrangement.</p>
</div>
<div class="paragraph data-line-301">
<p>Considérez la construction juridique d&#8217;un accord prénuptial, également connu sous le nom de "contrat de mariage". Lorsque deux personnes contractent un mariage, leur argent est lié par la loi (selon la juridiction). Avant de contracter mariage, ils peuvent signer un accord qui précise comment séparer leurs biens s&#8217;ils dissolvent leur mariage par le divorce.</p>
</div>
<div class="paragraph data-line-303">
<p>Nous pouvons créer un accord similaire dans Bitcoin. Par exemple, nous pouvons créer une transaction de remboursement, qui fonctionne comme un contrat de mariage, permettant aux parties de décider comment les fonds de leur canal seront divisés avant que leurs fonds ne soient réellement verrouillés dans l&#8217;adresse de financement multisignature.</p>
</div>
</div>
<div class="sect3 data-line-305">
<h4 id="_construction_de_la_transaction_de_remboursement_présignée">Construction de la transaction de remboursement présignée</h4>
<div class="paragraph data-line-307">
<p>Alice construira la transaction de remboursement immédiatement après avoir construit (mais pas diffusé) la transaction de financement. La transaction de remboursement dépense le <span class="keep-together">multisig</span> 2-of-2 dans le porte-monnaie d&#8217;Alice. Nous appelons cette transaction de remboursement une <em>transaction d&#8217;engagement</em> car elle engage les deux partenaires de canal à répartir équitablement le solde du canal. Étant donné qu&#8217;Alice a financé le canal par elle-même, elle obtient l&#8217;intégralité du solde, et Alice et Bob s&#8217;engagent à rembourser Alice avec cette transaction.</p>
</div>
<div class="paragraph data-line-309">
<p>En pratique, c&#8217;est un peu plus compliqué comme nous le verrons dans les chapitres suivants, mais pour l&#8217;instant gardons les choses simples et supposons que cela ressemble à <a href="#A_B_fund_refund_Tx">Alice construit également la transaction de remboursement</a>.</p>
</div>
<div id="A_B_fund_refund_Tx" class="imageblock data-line-313">
<div class="content">
<img src="images/mtln_0705.png" alt="Alice construit également la transaction de remboursement">
</div>
<div class="title">Figure 5. Alice construit également la transaction de remboursement</div>
</div>
<div class="paragraph data-line-315">
<p>Plus loin dans ce chapitre, nous verrons comment effectuer davantage de transactions d&#8217;engagement pour répartir le solde du canal en différents montants.</p>
</div>
</div>
<div class="sect3 data-line-317">
<h4 id="_enchaînement_des_transactions_sans_diffusion">Enchaînement des transactions sans diffusion</h4>
<div class="paragraph data-line-319">
<p>Alors maintenant, Alice a construit les deux transactions présentées dans <a href="#A_B_fund_refund_Tx">Alice construit également la transaction de remboursement</a>. Mais vous vous demandez peut-être comment cela est possible. Alice n&#8217;a pas diffusé la transaction de financement sur la blockchain Bitcoin. En ce qui concerne tout le monde sur le réseau, cette transaction n&#8217;existe pas. La transaction de remboursement est construite de manière à <em>dépenser</em> l&#8217;une des sorties de la transaction de financement, même si cette sortie n&#8217;existe pas encore non plus. Comment pouvez-vous dépenser une sortie qui n&#8217;a pas été confirmée sur la blockchain Bitcoin ?</p>
</div>
<div class="paragraph data-line-321">
<p>La transaction de remboursement n&#8217;est pas encore une transaction valide. Pour que cela devienne une transaction valide, deux choses doivent se produire :</p>
</div>
<div class="ulist data-line-323">
<ul>
<li class="data-line-323">
<p>La transaction de financement doit être diffusée sur le réseau Bitcoin. (Pour assurer la sécurité du Lightning Network, nous exigerons également qu&#8217;elle soit confirmée par la blockchain Bitcoin, bien que cela ne soit pas strictement nécessaire pour chaîner les <span class="keep-together">transactions</span>.)</p>
</li>
<li class="data-line-324">
<p>L&#8217;entrée de la transaction de remboursement nécessite les signatures d&#8217;Alice et de Bob.</p>
</li>
</ul>
</div>
<div class="paragraph pagebreak-before data-line-327">
<p>Mais même si ces deux choses ne se sont pas produites, et même si le nœud d&#8217;Alice n&#8217;a pas diffusé la transaction de financement, elle peut toujours construire la transaction de remboursement. Elle peut le faire car elle peut calculer le hachage de la transaction de financement et le référencer comme une entrée dans la transaction de remboursement.</p>
</div>
<div class="paragraph data-line-329">
<p>Remarquez comment Alice a calculé 6da3c2...387710 comme hachage de la transaction de financement ? Si et quand la transaction de financement est diffusée, ce hachage sera enregistré comme ID de transaction de la transaction de financement. Par conséquent, la sortie "0" de la transaction de financement (la sortie d&#8217;adresse 2-de-2) sera alors référencée en tant qu&#8217;ID de sortie 6da3c2...387710:0. La transaction de remboursement peut être construite pour dépenser cette sortie de transaction de financement même si elle n&#8217;existe pas encore, car Alice sait quel sera son identifiant une fois confirmé.</p>
</div>
<div class="paragraph data-line-331">
<p>Cela signifie qu&#8217;Alice peut créer une transaction chaînée en référençant une sortie qui n&#8217;existe pas encore, sachant que la référence sera valide si la transaction de financement est confirmée, ce qui rend également la transaction de remboursement valide. Comme nous le verrons dans la section suivante, cette "astuce" consistant à enchaîner les transactions avant leur diffusion nécessite une fonctionnalité très importante de Bitcoin qui a été introduite en août 2017 : <em>Segregated Witness</em>.</p>
</div>
</div>
<div class="sect3 data-line-333">
<h4 id="_résoudre_la_malléabilité_segregated_witness">Résoudre la malléabilité (Segregated Witness)</h4>
<div class="paragraph data-line-335">
<p>Alice doit compter sur le fait que l&#8217;identifiant de la transaction de financement est connu avant la confirmation. Mais avant l&#8217;introduction de Segregated Witness (SegWit) en août 2017, cela ne suffisait pas à protéger Alice. En raison de la façon dont les transactions étaient construites avec les signatures (témoins) incluses dans l&#8217;ID de transaction, il était possible pour un tiers (par exemple, Bob) de diffuser une version alternative d&#8217;une transaction avec un ID de transaction <em>malléé</em> (modifié). C&#8217;est ce qu&#8217;on appelle la <em>malléabilité de transaction</em>, et avant SegWit, ce problème rendait difficile la mise en œuvre sécurisée de canaux de paiement à durée de vie indéfinie.</p>
</div>
<div class="paragraph data-line-337">
<p>Si Bob pouvait modifier la transaction de financement d&#8217;Alice avant qu&#8217;elle ne soit confirmée et produire une réplique qui avait un ID de transaction différent, Bob pourrait rendre la transaction de remboursement d&#8217;Alice invalide et détourner ses bitcoins. Alice serait à la merci de Bob pour obtenir une signature afin de débloquer ses fonds et pourrait facilement être victime de chantage. Bob ne pouvait pas voler les fonds, mais il pouvait empêcher Alice de les récupérer.</p>
</div>
<div class="paragraph data-line-339">
<p>L&#8217;introduction de SegWit a rendu les ID de transaction non confirmés immuables du point de vue des tiers, ce qui signifie qu&#8217;Alice peut être sûre que l&#8217;ID de transaction de la transaction de financement ne changera pas. En conséquence, Alice peut être sûre que si elle obtient la signature de Bob sur la transaction de remboursement, elle a un moyen de récupérer son argent. Elle a maintenant un moyen de mettre en œuvre l&#8217;équivalent Bitcoin d&#8217;un "contrat de mariage" avant de verrouiller ses fonds dans le multisig.</p>
</div>
<div class="admonitionblock tip data-line-342">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-343">
<p>Vous vous êtes peut-être demandé comment Bob pourrait modifier (malléer) une transaction créée et signée par Alice. Bob n&#8217;a certainement pas les clés privées d&#8217;Alice. Cependant, les signatures ECDSA d&#8217;un message ne sont pas uniques. Connaître une signature (qui est incluse dans une transaction valide) permet de produire de nombreuses signatures d&#8217;apparence différente qui sont toujours valides. Avant que SegWit ne supprime les signatures de l&#8217;algorithme de résumé de transaction, Bob pouvait remplacer la signature par une signature valide équivalente qui produisait un ID de transaction différent, brisant la chaîne entre la transaction de financement et la transaction de remboursement.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-346">
<h5 id="_le_message_funding_created">Le message funding_created</h5>
<div class="paragraph data-line-348">
<p>Maintenant qu&#8217;Alice a construit les transactions nécessaires, le flux de messages de construction d&#8217;un canal se poursuit. Alice transmet le message funding_created à Bob. Vous pouvez voir le contenu de ce message ici :</p>
</div>
<div id="funding_created_message" class="listingblock data-line-352">
<div class="title">Le message funding_created</div>
<div class="content">
<pre>[32*byte:temporary_channel_id]
[sha256:funding_txid]
[u16:funding_output_index]
[signature:signature]</pre>
</div>
</div>
<div class="paragraph data-line-359">
<p>Avec ce message, Alice donne à Bob les informations importantes sur la transaction de financement qui ancre le canal de paiement :</p>
</div>
<div class="dlist data-line-361">
<dl>
<dt class="hdlist1">funding_txid</dt>
<dd>
<p>Il s&#8217;agit de l&#8217;ID de transaction (TxID) de la transaction de financement, et est utilisé pour créer l&#8217;ID du canal une fois que le canal est établi.</p>
</dd>
<dt class="hdlist1">funding_output_index</dt>
<dd>
<p>Il s&#8217;agit de l&#8217;indice de sortie, donc Bob sait quelle sortie de la transaction (par exemple, la sortie <code>0</code>) est la sortie multisig 2-de-2 financée par Alice. Ceci est également utilisé pour former l&#8217;ID du canal.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-365">
<p>Enfin, Alice envoie également la signature correspondant à la <code>funding_pubkey</code> d&#8217;Alice et qui est utilisée pour dépenser à partir du multisig 2-de-2. Ceci est nécessaire à Bob car il devra également créer sa propre version d&#8217;une transaction d&#8217;engagement. Cette transaction d&#8217;engagement nécessite une signature d&#8217;Alice, qu&#8217;elle lui fournit. Notez que les transactions d&#8217;engagement d&#8217;Alice et de Bob semblent légèrement différentes, donc les signatures seront différentes. Savoir à quoi ressemble la transaction d&#8217;engagement de l&#8217;autre partie est crucial et fait partie du protocole pour fournir la signature valide.</p>
</div>
<div class="admonitionblock tip data-line-368">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-369">
<p>Dans le protocole Lightning, nous voyons souvent des nœuds envoyer des signatures au lieu de transactions signées entières. En effet, chaque partie peut reconstruire la même transaction et seule la signature est donc nécessaire pour la valider. L&#8217;envoi de la signature seule et non de l&#8217;intégralité de la transaction permet d&#8217;économiser beaucoup de bande passante réseau.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-373">
<h5 id="_le_message_funding_signed">Le message funding_signed</h5>
<div class="paragraph data-line-375">
<p>Après avoir reçu le message funding_created d&#8217;Alice, Bob connaît maintenant l&#8217;ID de la transaction de financement et l&#8217;index de sortie. L&#8217;ID de canal est composé d&#8217;un "ou exclusif" au niveau des bits (bitwise XOR) de l&#8217;ID de transaction de financement et de l&#8217;index de sortie :</p>
</div>
<div class="listingblock data-line-377">
<div class="content">
<pre>channel_id = funding_txid XOR funding_output_index</pre>
</div>
</div>
<div class="paragraph data-line-381">
<p>Plus précisément, un <code>channel_id</code>, qui est la représentation sur 32 octets d&#8217;un UTXO de financement, est généré en effectuant un XOR sur les 2 octets inférieurs du TxID de financement avec l&#8217;index de la sortie de financement.</p>
</div>
<div class="paragraph data-line-383">
<p>Bob devra également envoyer à Alice sa signature pour la transaction de remboursement, basée sur la <code>funding_pubkey</code> de Bob qui a servi à former le multisig 2-de-2. Bien que Bob ait déjà sa transaction de remboursement locale, cela permettra à Alice de compléter la transaction de remboursement avec toutes les signatures nécessaires et de s&#8217;assurer que son argent est remboursable en cas de problème.</p>
</div>
<div class="paragraph data-line-385">
<p>Bob construit un message funding_signed et l&#8217;envoie à Alice. Ici, nous voyons le contenu de ce message :</p>
</div>
<div id="funding_signed_message" class="listingblock data-line-389">
<div class="title">Le message funding_signed</div>
<div class="content">
<pre>[channel_id:channel_id]
[signature:signature]</pre>
</div>
</div>
</div>
</div>
<div class="sect3 data-line-396">
<h4 id="_diffusion_de_la_transaction_de_financement">Diffusion de la transaction de financement</h4>
<div class="paragraph data-line-398">
<p>Après avoir reçu le message funding_signed de Bob, Alice a maintenant les deux signatures nécessaires pour signer la transaction de remboursement. Son "plan de sortie" est désormais sécurisé, et elle peut donc diffuser l&#8217;opération de financement sans craindre de voir ses fonds bloqués. En cas de problème, Alice peut simplement diffuser la transaction de remboursement et récupérer son argent, sans aucune autre aide de Bob.</p>
</div>
<div class="paragraph data-line-400">
<p>Alice envoie maintenant la transaction de financement sur le réseau Bitcoin afin qu&#8217;elle puisse être minée dans la blockchain. Alice et Bob surveilleront cette transaction et attendront le nombre minimum_depth de confirmations (par exemple, six confirmations) sur la blockchain Bitcoin.</p>
</div>
<div class="admonitionblock tip data-line-403">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-404">
<p>Bien sûr, Alice utilisera le protocole Bitcoin pour vérifier que la signature que Bob lui a envoyée est bien valide. Cette étape est très cruciale. Si, pour une raison quelconque, Bob envoyait des données erronées à Alice, son "plan de sortie" serait saboté.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-407">
<h5 id="_le_message_funding_locked">Le message funding_locked</h5>
<div class="paragraph data-line-409">
<p>Dès que la transaction de financement a atteint le nombre requis de confirmations, Alice et Bob s&#8217;envoient le message funding_locked et le canal est prêt à être utilisé.</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-411">
<h3 id="_envoi_de_paiements_au_travers_dun_canal">Envoi de paiements au travers d&#8217;un canal</h3>
<div class="paragraph data-line-413">
<p>Le canal a été mis en place, mais dans son état initial, toute la capacité (140 000 satoshis) est du côté d&#8217;Alice. Cela signifie qu&#8217;Alice peut envoyer des paiements à Bob via le canal, mais Bob n&#8217;a pas encore de fonds à envoyer à Alice.</p>
</div>
<div class="paragraph data-line-415">
<p>Dans les prochaines sections, nous montrerons comment les paiements sont effectués sur le canal de paiement et comment <em>l&#8217;état du canal</em> est mis à jour.</p>
</div>
<div class="paragraph data-line-417">
<p>Supposons qu&#8217;Alice veuille envoyer 70 000 satoshis à Bob pour payer sa facture au Café de Bob.</p>
</div>
<div class="sect3 data-line-419">
<h4 id="_partage_du_solde">Partage du solde</h4>
<div class="paragraph data-line-421">
<p>En principe, envoyer un paiement d&#8217;Alice vers Bob consiste simplement à redistribuer le solde du canal. Avant que le paiement ne soit envoyé, Alice a 140 000 satoshis et Bob n&#8217;en a aucun. Après l&#8217;envoi du paiement de 70 000 satoshis, Alice a 70 000 satoshis <span class="keep-together">et Bob</span> a 70 000 satoshis.</p>
</div>
<div class="paragraph data-line-423">
<p>Par conséquent, tout ce qu&#8217;Alice et Bob ont à faire est de créer et de signer une transaction qui dépense le multisig 2-de-2 vers deux sorties payant Alice et Bob leurs soldes correspondants. Nous appelons cette transaction mise à jour une <em>transaction d&#8217;engagement</em>.</p>
</div>
<div class="paragraph data-line-425">
<p>Alice et Bob exploitent le canal de paiement en <em>faisant avancer l&#8217;état du canal</em> grâce à une série d&#8217;engagements. Chaque engagement met à jour les soldes pour refléter les paiements qui ont traversé le canal. Alice et Bob peuvent initier un nouvel engagement pour mettre à jour le canal.</p>
</div>
<div class="paragraph data-line-427">
<p>Dans <a href="#competing_commitments_1">Multiples transactions d&#8217;engagement</a> nous pouvons voir plusieurs transactions d&#8217;engagement.</p>
</div>
<div class="paragraph data-line-429">
<p>La première transaction d&#8217;engagement affichée dans <a href="#competing_commitments_1">Multiples transactions d&#8217;engagement</a> est la transaction de remboursement qu&#8217;Alice a construite avant de financer le canal. Dans le diagramme, il s&#8217;agit de l&#8217;engagement #0. Après qu&#8217;Alice a payé à Bob 70 000 satoshis, la nouvelle transaction d&#8217;engagement (Commitment #1) a deux sorties payant Alice et Bob leurs soldes respectifs. Nous avons inclus deux transactions d&#8217;engagement ultérieures (Commitment #2 et Commitment #3) qui représentent Alice payant à Bob 10 000 satoshis supplémentaires, puis 20 000 satoshis, respectivement.</p>
</div>
<div class="paragraph data-line-431">
<p>Chaque transaction d&#8217;engagement signée et valide peut être utilisée par l&#8217;un ou l&#8217;autre des partenaires de canal à tout moment pour fermer le canal en la diffusant sur le réseau Bitcoin. Puisqu&#8217;ils ont tous les deux la transaction d&#8217;engagement la plus récente et peuvent l&#8217;utiliser à tout moment, ils peuvent également simplement la conserver et ne pas la diffuser. C&#8217;est leur garantie pour une sortie équitable du canal.</p>
</div>
<div id="competing_commitments_1" class="imageblock data-line-435">
<div class="content">
<img src="images/mtln_0706.png" alt="Multiples transactions d&#8217;engagement">
</div>
<div class="title">Figure 6. Multiples transactions d&#8217;engagement</div>
</div>
</div>
<div class="sect3 data-line-437">
<h4 id="_engagements_concurrents">Engagements concurrents</h4>
<div class="paragraph data-line-439">
<p>Vous vous demandez peut-être comment il est possible pour Alice et Bob d&#8217;avoir plusieurs transactions d&#8217;engagement, toutes tentant de dépenser la même sortie 2-de-2 de la transaction de financement. Ces transactions d&#8217;engagement ne sont-elles pas contradictoires ? N&#8217;est-ce pas une "double-dépense" que le système Bitcoin est censé empêcher ?</p>
</div>
<div class="paragraph data-line-441">
<p>Et c&#8217;est le cas est en effet ! En fait, nous comptons sur la capacité de Bitcoin à <em>empêcher</em> une double dépense pour faire fonctionner Lightning. Peu importe le nombre de transactions d&#8217;engagement qu&#8217;Alice et Bob construisent et signent, une seule d&#8217;entre elles peut être confirmée.</p>
</div>
<div class="paragraph data-line-443">
<p>Tant qu&#8217;Alice et Bob détiennent ces transactions et ne les diffusent pas, la sortie de financement n&#8217;est pas dépensée. Mais si une transaction d&#8217;engagement est diffusée et confirmée, elle dépensera la sortie de financement. Si Alice ou Bob tentent de diffuser plus d&#8217;une transaction d&#8217;engagement, une seule d&#8217;entre elles sera confirmée et les autres seront rejetées comme tentatives (et échecs) de doubles dépenses.</p>
</div>
<div class="paragraph data-line-445">
<p>Si plusieurs transactions d&#8217;engagement sont diffusées, de nombreux facteurs détermineront celle qui sera confirmée en premier : le montant des frais inclus, la vitesse de propagation de ces transactions concurrentes, la topologie du réseau, etc. résultat. Cela ne semble pas très sûr. On pourrait croire que quelqu&#8217;un pourrait tricher.</p>
</div>
</div>
<div class="sect3 data-line-447">
<h4 id="_tricher_avec_les_anciennes_transactions_dengagement">Tricher avec les anciennes transactions d&#8217;engagement</h4>
<div class="paragraph data-line-449">
<p>Examinons plus attentivement les opérations d&#8217;engagement dans <a href="#competing_commitments_1">Multiples transactions d&#8217;engagement</a>. Les quatre transactions d&#8217;engagement sont signées et valides. Mais seul la dernière reflète avec précision les soldes du canal les plus récents. Dans ce scénario particulier, Alice a la possibilité de tricher en diffusant un engagement plus ancien et en le faisant confirmer sur la blockchain Bitcoin. Disons qu&#8217;Alice transmet le Commitment #0 et le fait confirmer : elle fermera effectivement le canal et prendra elle-même tous les 140 000 satoshis. En fait, dans cet exemple particulier, tout engagement autre que l&#8217;Engagement #3 améliore la position d&#8217;Alice et lui permet "d&#8217;annuler" au moins une partie des paiements reflétés dans le canal.</p>
</div>
<div class="paragraph data-line-451">
<p>Dans la section suivante, nous verrons comment le Lightning Network résout ce problème en empêchant les anciennes transactions d&#8217;engagement d&#8217;être utilisées par les partenaires de canal grâce à un mécanisme de révocation et de pénalités. Il existe d&#8217;autres moyens d&#8217;empêcher la transmission d&#8217;anciennes transactions d&#8217;engagement, telles que les canaux eltoo, mais ils nécessitent une mise à niveau de Bitcoin appelée "input rebinding" (voir <a href="#bitcoin_prot_17">[bitcoin_prot_17]</a>).</p>
</div>
</div>
<div class="sect3 data-line-453">
<h4 id="_révoquer_les_anciennes_transactions_dengagement">Révoquer les anciennes transactions d&#8217;engagement</h4>
<div class="paragraph data-line-455">
<p>Les transactions Bitcoin n&#8217;expirent pas et ne peuvent pas être "annulées". Elles ne peuvent pas non plus être arrêtées ou censurées une fois qu&#8217;elles ont été diffusées. Alors, comment "révoquer" une transaction qu&#8217;une autre personne détient et qui a déjà été signée ?</p>
</div>
<div class="paragraph data-line-457">
<p>La solution utilisée dans Lightning est un autre exemple de protocole d&#8217;équité. Au lieu d&#8217;essayer de contrôler la capacité de diffuser une transaction, il existe un <em>mécanisme de pénalité</em> intégré qui garantit qu&#8217;il n&#8217;est pas dans le meilleur intérêt d&#8217;un tricheur potentiel de transmettre un ancien engagement transaction. Ils peuvent toujours le diffuser, mais ils perdront très probablement de l&#8217;argent s&#8217;ils le font.</p>
</div>
<div class="admonitionblock tip data-line-460">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-461">
<p>Le mot "révoquer" est un abus de langage car il implique que les engagements plus anciens sont en quelque sorte rendus invalides et ne peuvent pas être diffusés et confirmés. Mais ce n&#8217;est pas le cas, car les transactions Bitcoin valides ne peuvent pas être révoquées. Au lieu de cela, le protocole Lightning utilise un mécanisme de pénalité pour punir le partenaire de canal qui diffuse un ancien engagement.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-464">
<p>Trois éléments composent le mécanisme de révocation et de pénalités du protocole Lightning :</p>
</div>
<div class="dlist data-line-466">
<dl>
<dt class="hdlist1">Transactions d&#8217;engagement asymétriques</dt>
<dd>
<p>Les transactions d&#8217;engagement d&#8217;Alice sont légèrement différentes de celles détenues par Bob.</p>
</dd>
<dt class="hdlist1">Dépenses différées</dt>
<dd>
<p>le paiement à la partie détentrice de la transaction d&#8217;engagement est différé (temporisé), tandis que le paiement à l&#8217;autre partie peut être réclamé immédiatement.</p>
</dd>
<dt class="hdlist1">Clés de révocation</dt>
<dd>
<p>Utilisées pour débloquer une option de pénalité pour les anciens engagements.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-472">
<p>Examinons successivement ces trois éléments.</p>
</div>
</div>
<div class="sect3 data-line-475">
<h4 id="_transactions_dengagement_asymétriques">Transactions d&#8217;engagement asymétriques</h4>
<div class="paragraph data-line-477">
<p>Alice et Bob détiennent des transactions d&#8217;engagement légèrement différentes. Examinons plus précisément Commitment #2 de <a href="#competing_commitments_1">Multiples transactions d&#8217;engagement</a>, plus en détail dans <a href="#commitment_2">Transaction d&#8217;engagement #2</a>.</p>
</div>
<div id="commitment_2" class="imageblock data-line-481">
<div class="content">
<img src="images/mtln_0707.png" alt="Transaction d&#8217;engagement #2">
</div>
<div class="title">Figure 7. Transaction d&#8217;engagement #2</div>
</div>
<div class="paragraph data-line-483">
<p>Alice et Bob détiennent deux variantes différentes de cette transaction, comme illustré dans <a href="#asymmetric_1">Transactions d&#8217;engagement asymétriques</a>.</p>
</div>
<div id="asymmetric_1" class="imageblock data-line-487">
<div class="content">
<img src="images/mtln_0708.png" alt="Transactions d&#8217;engagement asymétriques">
</div>
<div class="title">Figure 8. Transactions d&#8217;engagement asymétriques</div>
</div>
<div class="paragraph data-line-489">
<p>Par convention, dans le cadre du protocole Lightning, nous appelons les deux partenaires de canal <code>self</code> (soi-même, également appelé <code>local</code>) et <code>remote</code> (distant), selon le côté que nous examinons. Les sorties qui paient chaque partenaire d&#8217;un canal sont appelées <code>to_local</code> et <code>to_remote</code>, respectivement.</p>
</div>
<div class="paragraph data-line-491">
<p>Dans <a href="#asymmetric_1">Transactions d&#8217;engagement asymétriques</a> nous voyons qu&#8217;Alice détient une transaction qui paie 60 000 satoshis <code>to_self</code> (pouvant être dépensés par les clés d&#8217;Alice) et 80 000 satoshis <code>to_remote</code> (pouvant être dépensés par les clés de Bob).</p>
</div>
<div class="paragraph data-line-493">
<p>Bob détient l&#8217;image miroir de cette transaction, où la première sortie est de 80 000 satoshis "to_self" (pouvant être dépensés par les clés de Bob) et de 60 000 satoshis "to_remote" (pouvant être dépensés par les clés d&#8217;Alice).</p>
</div>
</div>
<div class="sect3 data-line-495">
<h4 id="_dépenses_différées_timelocked_pour_to_self">Dépenses différées (timelocked) pour to_self</h4>
<div class="paragraph data-line-497">
<p>L&#8217;utilisation de transactions asymétriques permet au protocole d&#8217;attribuer facilement la <em>pénalité</em> à la partie qui triche. Un invariant selon lequel la partie <em>diffuseur</em> doit toujours attendre garantit que la partie "honnête" a le temps de réfuter la demande et de révoquer ses fonds. Cette asymétrie se manifeste sous la forme de sorties différentes pour chaque partie : la sortie <code>to_local</code> est toujours verrouillée dans le temps et ne peut pas être dépensée immédiatement, alors que la sortie <code>to_remote</code> n&#8217;est pas verrouillée dans le temps et peut être dépensée immédiatement.</p>
</div>
<div class="paragraph data-line-499">
<p>Dans la transaction d&#8217;engagement détenue par Alice, par exemple, la sortie <code>to_local</code> qui la paie est verrouillée dans le temps pour 432 blocs, tandis que la sortie <code>to_remote</code> qui paie Bob peut être dépensée immédiatement (voir <a href="#asymmetric_delayed_1">Transactions d&#8217;engagement asymétriques et différées</a>). La transaction d&#8217;engagement de Bob pour Commitment #2 est l&#8217;image miroir : sa propre sortie (<code>to_local</code>) est verrouillée dans le temps et la sortie <code>to_remote</code> d&#8217;Alice peut être utilisée immédiatement.</p>
</div>
<div id="asymmetric_delayed_1" class="imageblock data-line-503">
<div class="content">
<img src="images/mtln_0709.png" alt="Transactions d&#8217;engagement asymétriques et différées">
</div>
<div class="title">Figure 9. Transactions d&#8217;engagement asymétriques et différées</div>
</div>
<div class="paragraph pagebreak-before data-line-506">
<p>Cela signifie que si Alice ferme le canal en diffusant et en confirmant la transaction d&#8217;engagement qu&#8217;elle détient, elle ne peut pas dépenser son solde durant 432 blocs, mais Bob peut réclamer son solde immédiatement. Si Bob ferme le canal en utilisant la transaction d&#8217;engagement qu&#8217;il détient, il ne peut pas dépenser sa sortie durant 432 blocs alors qu&#8217;Alice peut immédiatement dépenser la sienne.</p>
</div>
<div class="paragraph data-line-508">
<p>Le délai est là pour une raison : pour permettre à la partie <em>distante</em> (remote) d&#8217;exercer une option de pénalité si un ancien engagement (révoqué) devait être diffusé par l&#8217;autre partenaire de canal. Examinons ensuite les clés de révocation et l&#8217;option de pénalité.</p>
</div>
<div class="paragraph data-line-510">
<p>Le délai est négocié par Alice et Bob, lors du flux des messages de construction du canal initial, sous la forme d&#8217;un champ appelé to_self_delay. Pour garantir la sécurité du canal, le délai est adapté à la capacité du canal, ce qui signifie qu&#8217;un canal avec plus de fonds a des délais plus longs dans les sorties to_self dans les engagements. Le nœud d&#8217;Alice inclut un to_self_delay souhaité dans le message open_channel. Si Bob trouve cela acceptable, son nœud inclut la même valeur pour to_self_delay dans le message accept_channel. S&#8217;ils ne sont pas d&#8217;accord, le canal est rejeté (voir <a href="#theShutdownmessage">Le message d&#8217;arrêt (shutdown)</a>).</p>
</div>
</div>
<div class="sect3 data-line-512">
<h4 id="_clés_de_révocation">Clés de révocation</h4>
<div class="paragraph data-line-514">
<p>Comme nous l&#8217;avons vu précédemment, le mot "révocation" est un peu trompeur car il implique que la transaction "révoquée" ne peut pas être utilisée.</p>
</div>
<div class="paragraph data-line-516">
<p>En fait, la transaction révoquée peut être utilisée, mais si elle est utilisée et qu&#8217;elle a été révoquée, l&#8217;un des partenaires du canal peut prendre tous les fonds du canal en créant une transaction de pénalité.</p>
</div>
<div class="paragraph data-line-518">
<p>La façon dont cela fonctionne est que la sortie <code>to_local</code> est non seulement verrouillée dans le temps ("timelocked" en anglais), mais elle a également deux conditions de dépense dans le script : elle peut être dépensée par <em>self</em> après le timelock <em>ou</em> elle peut être dépensée par <em>remote</em> immédiatement avec une clé de révocation pour cet engagement.</p>
</div>
<div class="paragraph data-line-520">
<p>Ainsi, dans notre exemple, chaque côté détient une transaction d&#8217;engagement qui inclut une option de révocation dans la sortie <code>to_local</code>, comme indiqué dans <a href="#asymmetric_delayed_revocable_1">Engagements asymétriques, différés et révocables</a>.</p>
</div>
<div id="asymmetric_delayed_revocable_1" class="imageblock data-line-524">
<div class="content">
<img src="images/mtln_0710.png" alt="Engagements asymétriques, différés et révocables">
</div>
<div class="title">Figure 10. Engagements asymétriques, différés et révocables</div>
</div>
</div>
</div>
<div class="sect2 data-line-527">
<h3 id="commitment_transaction">La transaction d&#8217;engagement</h3>
<div class="paragraph data-line-529">
<p>Maintenant que nous comprenons la structure des transactions d&#8217;engagement et pourquoi nous avons besoin d&#8217;engagements asymétriques, différés et révocables, examinons le Bitcoin Script qui implémente cela.</p>
</div>
<div class="paragraph data-line-531">
<p>La première sortie (<code>to_local</code>) d&#8217;une transaction d&#8217;engagement est définie dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_local-output" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_local-output">BOLT #3: Commitment Transaction, <code>to_local</code> Output</a>, comme suit :</p>
</div>
<div class="listingblock data-line-533">
<div class="content">
<pre>OP_IF
    # Penalty transaction
    &lt;revocationpubkey&gt;
OP_ELSE
    &lt;to_self_delay&gt;
    OP_CHECKSEQUENCEVERIFY
    OP_DROP
    &lt;local_delayedpubkey&gt;
OP_ENDIF
OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-546">
<p>Il s&#8217;agit d&#8217;un script conditionnel (voir <a href="#conditional_scripts">[conditional_scripts]</a>), ce qui signifie que la sortie peut être dépensée si <em>l&#8217;une ou l&#8217;autre</em> des deux conditions est remplie. La première clause permet à la sortie d&#8217;être dépensée par toute personne pouvant signer pour &lt;revocationpubkey&gt;. La deuxième clause est verrouillée durant &lt;to_self_delay&gt; blocs et ne peut être dépensée qu&#8217;après ce nombre de blocs par quiconque étant capable de signer pour &lt;local_delayedpubkey&gt;. Dans notre exemple, nous avions mis le timelock à &lt;to_self_delay&gt; pour 432 blocs, mais il s&#8217;agit d&#8217;un délai configurable qui est négocié par les deux canaux partenaires. La durée de timelock to_self_delay est généralement choisie proportionnellement à la capacité du canal, ce qui signifie que les canaux de plus grande capacité (plus de fonds) ont des timelocks to_self_delay plus longs pour protéger les parties.</p>
</div>
<div class="paragraph data-line-548">
<p>La première clause permet à la sortie d&#8217;être dépensée par toute personne pouvant signer pour &lt;revocationpubkey&gt;. Une exigence critique pour la sécurité de ce script est que la partie distante <em>ne peut pas</em> signer unilatéralement avec la <code>revocationpubkey</code>. Pour comprendre pourquoi cela est important, considérons le scénario dans lequel la partie distante viole un engagement précédemment révoqué. S&#8217;ils peuvent signer avec cette clé, ils peuvent simplement prendre la clause de révocation <em>eux-mêmes</em> et voler tous les fonds du canal. Au lieu de cela, nous dérivons la <code>revocationpubkey</code> pour <em>chaque</em> état en fonction des informations provenant <em>à la fois</em> de la partie elle-même (locale) et distante. Une utilisation intelligente de la cryptographie symétrique et asymétrique est utilisée pour permettre aux deux parties de calculer la clé publique <code>revocationpubkey</code>, mais ne permettre qu&#8217;à la partie honnête de calculer la clé privée compte tenu de ses informations secrètes, comme détaillé dans <a href="#revocation_sidebar">Révocation et dérivations du secret d&#8217;engagement</a>.</p>
</div>
<div id="revocation_sidebar" class="sidebarblock data-line-552">
<div class="content">
<div class="title">Révocation et dérivations du secret d&#8217;engagement</div>
<div class="paragraph data-line-553">
<p>Chaque côté envoie un <code>revocation_basepoint</code> pendant les messages initiaux de négociation du canal ainsi qu&#8217;un <code>first_per_commitment_point</code>. Le <code>revocation_basepoint</code> est statique pendant toute la durée de vie du canal, tandis que chaque nouvel état du canal sera basé sur un nouveau <code>first_per_commitment_point</code>.</p>
</div>
<div class="paragraph data-line-555">
<p>Compte tenu de ces informations, la <code>revocationpubkey</code> pour chaque état de canal est dérivée via les séries suivantes d&#8217;opérations de courbe elliptique et de hachage :</p>
</div>
<div class="listingblock data-line-557">
<div class="content">
<pre>revocationpubkey = revocation_basepoint * sha256(revocation_basepoint || per_commitment_point) + per_commitment_point * sha256(per_commitment_point || revocation_basepoint)</pre>
</div>
</div>
<div class="paragraph data-line-561">
<p>En raison de la propriété commutative des groupes abéliens sur lesquels les courbes elliptiques sont définies, une fois que le <code>per_commitment_secret</code> (la clé privée pour le <code>per_commitment_point</code>) est révélé par la partie distante, self peut dériver la clé privée pour le <code>revocationpubkey</code> avec l&#8217;opération suivante :</p>
</div>
<div class="listingblock data-line-563">
<div class="content">
<pre>revocation_priv = (revocationbase_priv * sha256(revocation_basepoint || per_commitment_point)) + (per_commitment_secret * sha256(per_commitment_point || revocation_basepoint)) mod N</pre>
</div>
</div>
<div class="paragraph data-line-567">
<p>Pour voir pourquoi cela fonctionne en pratique, notez que nous pouvons <em>réordonner</em> (commuter) et étendre le calcul de la clé publique de la formule originale pour <code>revocationpubkey</code> :</p>
</div>
<div class="listingblock data-line-568">
<div class="content">
<pre class="highlight"><code>revocationpubkey = G*(revocationbase_priv * sha256(revocation_basepoint || per_commitment_point) + G*(per_commitment_secret * sha256(per_commitment_point || revocation_basepoint))
                 = revocation_basepoint * sha256(revocation_basepoint || per_commitment_point) + per_commitment_point * sha256(per_commitment_point || revocation_basepoint))</code></pre>
</div>
</div>
<div class="paragraph data-line-573">
<p>En d&#8217;autres termes, <code>revocationbase_priv</code> ne peut être dérivé (et utilisé pour signer pour <code>revocationpubkey</code>) que par la partie qui connaît <em>à la fois</em> <code>revocationbase_priv</code> <em>et</em> <code>per_commitment_secret</code>. Cette petite astuce est ce qui rend sécurisé le système de révocation basé sur la clé publique utilisé dans le Lightning Network.</p>
</div>
</div>
</div>
<div class="admonitionblock tip data-line-578">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-579">
<p>Le timelock utilisé dans la transaction d&#8217;engagement avec CHECK​SE⁠QUENCEVERIFY est un <em>timelock relatif</em>. Il compte les blocs écoulés depuis la confirmation de cette sortie. Cela signifie qu&#8217;elle ne sera dépensable qu&#8217;après to_self_delay bloc <em>après</em> que cette transaction d&#8217;engagement soit diffusée et confirmée.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-582">
<p>La deuxième sortie (to_remote) de la transaction d&#8217;engagement est définie dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_remote-output" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_remote-output">BOLT #3: Commitment Transaction, <code>to_remote</code> Output</a>, et dans sa forme la plus simple est un Pay-to-Witness-Public-Key-Hash (P2WPKH) pour &lt;remote_pubkey&gt; +, ce qui signifie qu'elle paie simplement le propriétaire qui peut signer pour +&lt;remote_pubkey&gt;.</p>
</div>
<div class="paragraph data-line-584">
<p>Maintenant que nous avons défini les transactions d&#8217;engagement en détail, voyons comment Alice et Bob font avancer l&#8217;état du canal, créent et signent de nouvelles transactions d&#8217;engagement et révoquent les anciennes transactions d&#8217;engagement.</p>
</div>
</div>
<div class="sect2 data-line-586">
<h3 id="_faire_avancer_létat_du_canal">Faire avancer l&#8217;état du canal</h3>
<div class="paragraph data-line-588">
<p>Pour faire avancer l&#8217;état du canal, Alice et Bob échangent deux messages : les messages commitment_signed et revoke_and_ack. Le message commitment_signed peut être envoyé par l&#8217;un ou l&#8217;autre des partenaires de canal lorsqu&#8217;ils ont une mise à jour de l&#8217;état du canal. L&#8217;autre partenaire de canal peut alors répondre par revoke_and_ack pour <em>révoquer</em> ("revoke" en anglais) l&#8217;ancien engagement et <em>accuser réception</em> ("acknowledge" en anglais) du nouvel engagement.</p>
</div>
<div class="paragraph data-line-590">
<p>Dans <a href="#commitment_message_flow">Flux de messages d&#8217;engagement et de révocation</a> nous voyons Alice et Bob échanger deux paires de commitment_signed et revoke_and_ack. Le premier flux montre une mise à jour d&#8217;état initiée par Alice (de gauche à droite commitment_signed), à laquelle Bob répond (de droite à gauche revoke_and_ack). Le deuxième flux montre une mise à jour d&#8217;état initiée par Bob et à laquelle Alice répond.</p>
</div>
<div id="commitment_message_flow" class="imageblock data-line-594">
<div class="content">
<img src="images/mtln_0711.png" alt="Flux de messages d&#8217;engagement et de révocation">
</div>
<div class="title">Figure 11. Flux de messages d&#8217;engagement et de révocation</div>
</div>
<div class="sect3 data-line-596">
<h4 id="_le_message_commitment_signed">Le message commitment_signed</h4>
<div class="paragraph data-line-598">
<p>La structure du message commitment_signed est définie dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#committing-updates-so-far-commitment_signed" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#committing-updates-so-far-commitment_signed">BOLT #2: Peer Protocol, <code>commitment_signed</code></a>, et illustré ici :</p>
</div>
<div id="commitment_signed_message" class="listingblock data-line-602">
<div class="title">Le message commitment_signed</div>
<div class="content">
<pre>[channel_id:channel_id]
[signature:signature]
[u16:num_htlcs]
[num_htlcs*signature:htlc_signature]</pre>
</div>
</div>
<div class="dlist data-line-609">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>L&#8217;identifiant du canal</p>
</dd>
<dt class="hdlist1">signature</dt>
<dd>
<p>La signature du nouvel engagement distant</p>
</dd>
<dt class="hdlist1">num_htlcs</dt>
<dd>
<p>Le nombre de HTLC mis à jour dans cet engagement</p>
</dd>
<dt class="hdlist1">htlc_signature</dt>
<dd>
<p>Les signatures pour les mises à jour</p>
</dd>
</dl>
</div>
<div class="admonitionblock note data-line-615">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-616">
<p>L&#8217;utilisation des HTLC pour valider les mises à jour sera expliquée en détail dans <a href="#htlcs">[htlcs]</a> et dans <a href="#channel_operation">[channel_operation]</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-619">
<p>Le message commitment_signed d&#8217;Alice donne à Bob la signature nécessaire (la partie d&#8217;Alice du 2-de-2) pour une nouvelle transaction d&#8217;engagement.</p>
</div>
</div>
<div class="sect3 data-line-621">
<h4 id="_le_message_revoke_and_ack">Le message revoke_and_ack</h4>
<div class="paragraph data-line-623">
<p>Maintenant que Bob a une nouvelle transaction d&#8217;engagement, il peut révoquer l&#8217;engagement précédent en donnant à Alice une clé de révocation, et construire le nouvel engagement avec la signature d&#8217;Alice.</p>
</div>
<div class="paragraph data-line-625">
<p>Le message revoke_and_ack est défini dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#completing-the-transition-to-the-updated-state-revoke_and_ack" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#completing-the-transition-to-the-updated-state-revoke_and_ack">BOLT #2: Peer Protocol, <code>revoke_and_ack</code></a>, et illustré ici :</p>
</div>
<div id="revoke_and_ack_message" class="listingblock data-line-629">
<div class="title">Le message revoke_and_ack</div>
<div class="content">
<pre>[channel_id:channel_id]
[32*byte:per_commitment_secret]
[point:next_per_commitment_point]</pre>
</div>
</div>
<div class="dlist data-line-637">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>C&#8217;est l&#8217;identifiant du canal.</p>
</dd>
<dt class="hdlist1">per_commitment_secret</dt>
<dd>
<p>Utilisé pour générer une clé de révocation pour l&#8217;engagement précédent (ancien), le révoquant effectivement.</p>
</dd>
<dt class="hdlist1">next_per_commitment_point</dt>
<dd>
<p>Utilisé pour créer une <code>revocation_pubkey</code> pour le nouvel engagement, afin qu&#8217;il puisse être révoqué ultérieurement.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-642">
<h4 id="revocation">Révocation et réengagement</h4>
<div class="paragraph data-line-644">
<p>Regardons de plus près cette interaction entre Alice et Bob.</p>
</div>
<div class="paragraph data-line-646">
<p>Alice donne à Bob les moyens de créer un nouvel engagement. En retour, Bob révoque l&#8217;ancien engagement pour assurer à Alice qu&#8217;il ne l&#8217;utilisera pas. Alice ne peut faire confiance au nouvel engagement que si elle dispose de la clé de révocation pour punir Bob d&#8217;avoir publié l&#8217;ancien engagement. Du point de vue de Bob, il peut révoquer en toute sécurité l&#8217;ancien engagement en donnant à Alice les clés pour le pénaliser, car il a une signature pour un nouvel engagement.</p>
</div>
<div class="paragraph data-line-648">
<p>Lorsque Bob répond par revoke_and_ack, il donne à Alice un per_commitment_secret. Ce secret peut être utilisé pour construire la clé de signature de révocation pour l&#8217;ancien engagement, ce qui permet à Alice de saisir tous les fonds du canal en exerçant une pénalité.</p>
</div>
<div class="paragraph data-line-650">
<p>Dès que Bob a donné ce secret à Alice, il ne doit jamais diffuser cet ancien engagement. S&#8217;il le fait, il donnera à Alice la possibilité de le pénaliser en prenant les fonds. Essentiellement, Bob donne à Alice la capacité de le tenir responsable de la diffusion d&#8217;un ancien engagement, et en fait, il a révoqué sa capacité à utiliser cet ancien engagement.</p>
</div>
<div class="paragraph data-line-652">
<p>Une fois qu&#8217;Alice a reçu le revoke_and_ack de Bob, elle peut être sûre que Bob ne peut pas diffuser l&#8217;ancien engagement sans être pénalisé. Elle a maintenant les clés nécessaires pour créer une transaction de pénalité si Bob diffuse un ancien engagement.</p>
</div>
</div>
<div class="sect3 data-line-655">
<h4 id="revocation_secret_derivation">Triche et pénalité en pratique</h4>
<div class="paragraph data-line-657">
<p>En pratique, Alice et Bob doivent surveiller les éventuelles tricheries. Ils surveillent la blockchain Bitcoin pour détecter toute transaction d&#8217;engagement liée à l&#8217;un des canaux qu&#8217;ils exploitent. S&#8217;ils voient une transaction d&#8217;engagement confirmée sur la chaîne, ils vérifieront s&#8217;il s&#8217;agit de l&#8217;engagement le plus récent. S&#8217;il s&#8217;agit d&#8217;un "ancien" engagement, ils doivent immédiatement construire et diffuser une transaction de pénalité. La transaction de pénalité dépense <em>les deux</em> sorties to_local et to_remote, fermant le canal et envoyant les deux soldes au partenaire du canal trompé.</p>
</div>
<div class="paragraph data-line-659">
<p>Pour permettre plus facilement aux deux parties de garder une trace des numéros d&#8217;engagement des engagements de révocation passés, chaque engagement <em>encode</em> en fait le numéro de l&#8217;engagement dans les champs de temps de verrouillage et de séquence dans une transaction. Dans le protocole, ce codage spécial est appelé <em>indices d&#8217;état</em> ("state hints" en anglais). En supposant qu&#8217;une partie connaît le numéro d&#8217;engagement actuel, elle peut utiliser les indices d&#8217;état pour reconnaître facilement si un engagement diffusé était révoqué, et si c&#8217;est le cas, quel numéro d&#8217;engagement a été violé, car ce numéro est utilisé pour rechercher facilement quel secret de révocation doit être utilisé dans l&#8217;arborescence des secrets de révocation (shachain).</p>
</div>
<div class="paragraph data-line-661">
<p>Plutôt que d&#8217;encoder l&#8217;indice d&#8217;état à la vue de tous, un indice d&#8217;état <em>obfusqué</em> est utilisé à sa place. Cet obfuscation est obtenu en utilisant l&#8217;opération XOR avec le numéro d&#8217;engagement actuel et un ensemble d&#8217;octets aléatoires générés de manière déterministe à l&#8217;aide des clés publiques de financement des deux côtés du canal. Un total de 6 octets sur le temps de verrouillage et la séquence (24 bits du temps de verrouillage et 24 bits de la séquence) sont utilisés pour coder l&#8217;indice d&#8217;état dans la transaction d&#8217;engagement, donc 6 octets aléatoires sont nécessairement utilisés par cette opération XOR. Pour obtenir ces 6 octets, les deux parties obtiennent le hachage SHA-256 de la clé de financement de l&#8217;initiateur concaténé à la clé de financement du répondant. Avant d&#8217;encoder la hauteur d&#8217;engagement actuelle, l&#8217;entier subit une opération XOR en utilisant cet obfuscateur d&#8217;indice d&#8217;état, puis encodé dans les 24 bits inférieurs du temps de verrouillage et les 64 bits supérieurs de la séquence.</p>
</div>
<div class="paragraph data-line-663">
<p>Passons en revue notre canal entre Alice et Bob et montrons un exemple spécifique d&#8217;une transaction avec pénalité. Dans <a href="#competing_commitments_2">Engagements révoqués et courants</a> on voit les quatre engagements sur le canal d&#8217;Alice et Bob. Alice a effectué trois paiements à Bob :</p>
</div>
<div class="ulist data-line-665">
<ul>
<li class="data-line-665">
<p>70 000 satoshis payés et engagés envers Bob avec Commitment #1</p>
</li>
<li class="data-line-666">
<p>10 000 satoshis payés et engagés envers Bob avec Commitment #2</p>
</li>
<li class="data-line-667">
<p>20 000 satoshis payés et engagés envers Bob avec Commitment #3</p>
</li>
</ul>
</div>
<div id="competing_commitments_2" class="imageblock data-line-671">
<div class="content">
<img src="images/mtln_0712.png" alt="Engagements révoqués et courants">
</div>
<div class="title">Figure 12. Engagements révoqués et courants</div>
</div>
<div class="paragraph data-line-673">
<p>Avec chaque engagement, Alice a révoqué l&#8217;engagement précédent (plus ancien). L&#8217;état actuel du canal et le solde correct sont représentés par Commitment #3. Tous les engagements précédents ont été révoqués et Bob a les clés nécessaires pour émettre des transactions de pénalité à leur encontre, au cas où Alice essaierait de diffuser l&#8217;un d&#8217;eux.</p>
</div>
<div class="paragraph data-line-675">
<p>Alice pourrait être incitée à tricher car toutes les transactions d&#8217;engagement précédentes lui donneraient une proportion plus élevée du solde du canal que celle à laquelle elle a droit. Disons par exemple qu&#8217;Alice a essayé de diffuser Commitment #1. Cette transaction d&#8217;engagement paierait Alice 70 000 satoshis et Bob 70 000 satoshis. Si Alice était capable de diffuser et de dépenser sa sortie to_local, elle volerait effectivement 30 000 satoshis à Bob en annulant ses deux derniers paiements à Bob.</p>
</div>
<div class="paragraph data-line-677">
<p>Alice décide de prendre un risque énorme et de diffuser Commitment #1 qui est révoqué, pour voler 30 000 satoshis à Bob. Dans <a href="#cheating_commitment">Alice triche</a> on voit l&#8217;ancien engagement d&#8217;Alice qu&#8217;elle diffuse sur la blockchain Bitcoin.</p>
</div>
<div id="cheating_commitment" class="imageblock data-line-681">
<div class="content">
<img src="images/mtln_0713.png" alt="Alice triche">
</div>
<div class="title">Figure 13. Alice triche</div>
</div>
<div class="paragraph data-line-683">
<p>Comme vous pouvez le voir, l&#8217;ancien engagement d&#8217;Alice a deux sorties, l&#8217;une se payant 70 000 satoshis (to_local output) et l&#8217;autre payant Bob 70 000 satoshis. Alice ne peut pas encore dépenser sa sortie 70 000 to_local car elle a un timelock de 432 blocs (3 jours). Elle espère maintenant que Bob ne le remarquera pas avant ces trois jours.</p>
</div>
<div class="paragraph data-line-685">
<p>Malheureusement pour Alice, le nœud de Bob surveille avec diligence la blockchain Bitcoin et voit une ancienne transaction d&#8217;engagement diffusée et (éventuellement) confirmée sur la chaîne.</p>
</div>
<div class="paragraph data-line-687">
<p>Le nœud de Bob diffusera immédiatement une transaction de pénalité. Depuis que cet ancien engagement a été révoqué par Alice, Bob a le per_commitment_secret qu&#8217;Alice lui a envoyé. Il utilise ce secret pour construire une signature pour la revocation_pubkey. Alors qu&#8217;Alice doit attendre 432 blocs, Bob peut dépenser <em>les deux</em> sorties immédiatement. Il peut dépenser la sortie to_remote avec ses clés privées car elle était destinée à le payer de toute façon. Il peut également dépenser la sortie destinée à Alice avec une signature de la clé de révocation. Son nœud diffuse la transaction de pénalité indiquée dans <a href="#penalty_transaction">Tricherie et pénalité</a>.</p>
</div>
<div id="penalty_transaction" class="imageblock data-line-691">
<div class="content">
<img src="images/mtln_0714.png" alt="Tricherie et pénalité">
</div>
<div class="title">Figure 14. Tricherie et pénalité</div>
</div>
<div class="paragraph data-line-693">
<p>La transaction de pénalité de Bob paie 140 000 satoshis à son propre porte-monnaie, prenant toute la capacité du canal. Non seulement Alice n&#8217;a pas réussi à tricher, mais elle a tout perdu en tentant de le faire !</p>
</div>
</div>
<div class="sect3 data-line-695">
<h4 id="_la_réserve_de_canal_sassurer_dun_enjeu_personnel">La réserve de canal : S&#8217;assurer d&#8217;un enjeu personnel</h4>
<div class="paragraph data-line-697">
<p>Vous avez peut-être remarqué qu&#8217;il y a une situation particulière qui doit être traitée. Si Alice pouvait continuer à dépenser son solde jusqu&#8217;à ce qu&#8217;il soit à zéro, elle serait en mesure de fermer le canal en diffusant une ancienne transaction d&#8217;engagement sans risquer de pénalité : soit la transaction d&#8217;engagement révoquée réussit après le délai, soit le tricheur se fait prendre, mais il n&#8217;y a pas de conséquence car la pénalité est nulle. Du point de vue de la théorie des jeux, c&#8217;est de l&#8217;argent gratuit pour tenter de tricher dans cette situation. C&#8217;est pourquoi la réserve de canal est en vigueur, de sorte qu&#8217;un tricheur potentiel risque toujours d&#8217;être sanctionné.</p>
</div>
</div>
</div>
<div class="sect2 data-line-699">
<h3 id="_fermeture_du_canal_fermeture_coopérative">Fermeture du canal (fermeture coopérative)</h3>
<div class="paragraph data-line-701">
<p>Jusqu&#8217;à présent, nous avons considéré les transactions d&#8217;engagement comme un moyen possible de fermer un canal, unilatéralement. Ce type de fermeture de canal n&#8217;est pas idéal car il force un timelock sur le partenaire de canal qui l&#8217;utilise.</p>
</div>
<div class="paragraph data-line-703">
<p>Une meilleure façon de fermer un canal est une fermeture coopérative. Dans une fermeture coopérative, les deux partenaires de canal négocient une transaction d&#8217;engagement finale appelée <em>transaction de fermeture</em> qui verse immédiatement à chaque partie son solde sur le porte-monnaie de destination de son choix. Ensuite, le partenaire qui a initié le flux de fermeture de canal diffusera la transaction de fermeture.</p>
</div>
<div class="paragraph data-line-705">
<p>Le flux de messages de fermeture est défini dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#channel-close" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#channel-close">BOLT #2: Peer Protocol, Channel Close</a>, et est illustré dans <a href="#closing_message_flow">Le flux des messages de fermeture de canal</a>.</p>
</div>
<div id="closing_message_flow" class="imageblock data-line-709">
<div class="content">
<img src="images/mtln_0715.png" alt="Le flux des messages de fermeture de canal">
</div>
<div class="title">Figure 15. Le flux des messages de fermeture de canal</div>
</div>
<div class="sect3 data-line-712">
<h4 id="theShutdownmessage">Le message d&#8217;arrêt (shutdown)</h4>
<div class="paragraph data-line-714">
<p>La fermeture du canal commence par l&#8217;envoi de l&#8217;un des deux partenaires de canal du message shutdown. Le contenu de ce message est illustré ici :</p>
</div>
<div id="shutdown_message" class="listingblock data-line-718">
<div class="title">Le message shutdown</div>
<div class="content">
<pre>[channel_id:channel_id]
[u16:len]
[len*byte:scriptpubkey]</pre>
</div>
</div>
<div class="dlist data-line-726">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>L&#8217;identifiant de canal pour le canal que nous souhaitons fermer</p>
</dd>
<dt class="hdlist1">len</dt>
<dd>
<p>La longueur du script du porte-monnaie de destination que ce partenaire de canal souhaite recevoir pour son solde</p>
</dd>
<dt class="hdlist1">scriptpubkey</dt>
<dd>
<p>Un script Bitcoin du porte-monnaie de destination, dans l&#8217;un des formats d&#8217;adresse Bitcoin "standard" (P2PKH, P2SH, P2WPKH, P2WSH, etc. ; voir le <a href="#glossary">[glossary]</a>)</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-730">
<p>Disons qu&#8217;Alice envoie le message shutdown à Bob pour fermer son canal. Alice spécifiera un Bitcoin Script qui correspond à l&#8217;adresse Bitcoin de son porte-monnaie. Elle dit à Bob : faisons une transaction de fermeture qui paie mon solde à ce porte-monnaie.</p>
</div>
<div class="paragraph data-line-732">
<p>Bob répondra avec son propre message shutdown indiquant qu&#8217;il accepte de fermer le canal de manière coopérative. Son message shutdown inclut le script de son adresse de porte-monnaie.</p>
</div>
<div class="paragraph data-line-734">
<p>Maintenant, Alice et Bob ont l&#8217;adresse de porte-monnaie souhaitée de l&#8217;autre, et ils peuvent construire des transactions de fermeture identiques pour régler le solde du canal.</p>
</div>
</div>
<div class="sect3 data-line-736">
<h4 id="_le_message_closing_signed">Le message closing_signed</h4>
<div class="paragraph data-line-738">
<p>En supposant que le canal n&#8217;a pas d&#8217;engagements ou de mises à jour en cours et que les partenaires de canal ont échangé les messages shutdown indiqués dans la section précédente, ils peuvent maintenant terminer cette fermeture de manière coopérative.</p>
</div>
<div class="paragraph data-line-740">
<p>Le <em>financeur</em> du canal (Alice dans notre exemple) commence par envoyer un message closing_signed à Bob. Ce message propose des frais de transaction pour la transaction sur la chaîne et la signature d&#8217;Alice (le multisig 2-de-2) pour la transaction de fermeture. Le message closing_signed est illustré ici :</p>
</div>
<div id="closing_signed_message" class="listingblock data-line-744">
<div class="title">Le message closing_signed</div>
<div class="content">
<pre>[channel_id:channel_id]
[u64:fee_satoshis]
[signature:signature]</pre>
</div>
</div>
<div class="dlist data-line-750">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>L&#8217;identifiant du canal</p>
</dd>
<dt class="hdlist1">fee_satoshis</dt>
<dd>
<p>Les frais proposés pour la transaction sur la chaîne, en satoshis</p>
</dd>
<dt class="hdlist1">signature</dt>
<dd>
<p>La signature de l&#8217;expéditeur pour la transaction de fermeture</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-754">
<p>Lorsque Bob le reçoit, il peut répondre avec son propre message closing_signed. S&#8217;il est d&#8217;accord avec les frais, il retourne simplement les mêmes frais proposés et sa propre signature. S&#8217;il n&#8217;est pas d&#8217;accord, il doit proposer un autre tarif avec fee_satoshis.</p>
</div>
<div class="paragraph data-line-756">
<p>Cette négociation peut se poursuivre avec des messages closing_signed en va-et-vient jusqu&#8217;à ce que les deux partenaires de canal s&#8217;entendent sur des frais.</p>
</div>
<div class="paragraph data-line-758">
<p>Une fois qu&#8217;Alice reçoit un message closing_signed avec les mêmes frais que celui qu&#8217;elle a proposé dans son dernier message, la négociation est terminée. Alice signe et diffuse la transaction de fermeture et le canal est fermé.</p>
</div>
</div>
<div class="sect3 data-line-760">
<h4 id="_la_transaction_de_fermeture_coopérative">La transaction de fermeture coopérative</h4>
<div class="paragraph data-line-762">
<p>La transaction de fermeture coopérative ressemble à la dernière transaction d&#8217;engagement sur laquelle Alice et Bob s&#8217;étaient mis d&#8217;accord. Cependant, contrairement à la dernière transaction d&#8217;engagement, elle n&#8217;a pas de timelock ou de clés de révocation de pénalité dans les sorties. Étant donné que les deux parties coopèrent pour produire cette transaction et qu&#8217;elles ne prendront aucun autre engagement, les éléments asymétriques, différés et révocables de cette transaction ne sont pas nécessaires.</p>
</div>
<div class="paragraph data-line-764">
<p>Typiquement, les adresses utilisées dans cette transaction de fermeture coopérative sont générées fraîchement pour chaque canal fermé. Cependant, il est également possible pour les deux parties de <em>verrouiller</em> une adresse de "livraison" à utiliser pour envoyer leurs fonds réglés de manière coopérative. Dans l&#8217;espace de noms TLV des messages <code>open_channel</code> et <code>accept_channel</code>, les deux parties sont libres de spécifier un "script anticipé d&#8217;arrêt". Généralement, cette adresse est dérivée de clés qui résident dans un cold storage. Cette pratique sert à augmenter la sécurité des canaux : si un partenaire de canal est piraté d&#8217;une manière ou d&#8217;une autre, le pirate ne peut pas fermer le canal de manière coopérative en utilisant une adresse qu&#8217;il contrôle. Au lieu de cela, le partenaire de canal honnête et sans compromis refusera de coopérer à la fermeture d&#8217;un canal si l&#8217;adresse de fermeture initiale spécifiée n&#8217;est pas utilisée. Cette fonctionnalité crée effectivement une "boucle fermée", limitant le flux de fonds hors d&#8217;un canal donné.</p>
</div>
<div class="paragraph data-line-766">
<p>Alice diffuse une transaction indiquée dans <a href="#closing_transaction">La transaction de fermeture coopérative</a> pour fermer le canal.</p>
</div>
<div id="closing_transaction" class="imageblock data-line-770">
<div class="content">
<img src="images/mtln_0716.png" alt="La transaction de fermeture coopérative">
</div>
<div class="title">Figure 16. La transaction de fermeture coopérative</div>
</div>
<div class="paragraph data-line-772">
<p>Dès que cette transaction de fermeture est confirmée sur la blockchain Bitcoin, le canal est fermé. Désormais, Alice et Bob peuvent dépenser leurs sorties à leur guise.</p>
</div>
</div>
</div>
<div class="sect2 data-line-774">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph data-line-776">
<p>Dans cette section, nous avons examiné les canaux de paiement de manière beaucoup plus détaillée. Nous avons examiné trois flux de messages utilisés par Alice et Bob pour négocier le financement, les engagements et la fermeture de canaux. Nous avons également expliqué la structure des transactions de financement, d&#8217;engagement et de fermeture, et examiné les mécanismes de révocation et de pénalité.</p>
</div>
<div class="paragraph data-line-778">
<p>Comme nous le verrons dans les prochains chapitres, les HTLC sont utilisés même pour les paiements locaux entre partenaires de canal. Ils ne sont pas nécessaires, mais le protocole est beaucoup plus simple si les paiements locaux (un canal) et routés (plusieurs canaux) sont effectués de la même manière.</p>
</div>
<div class="paragraph data-line-780">
<p>Dans un canal de paiement unique, le nombre de paiements par seconde n&#8217;est lié qu&#8217;à la capacité du réseau entre Alice et Bob. Tant que les partenaires de canal sont en mesure d&#8217;envoyer quelques octets de données dans les deux sens pour convenir d&#8217;une nouvelle répartition des soldes, ils ont effectivement effectué un paiement. C&#8217;est pourquoi nous pouvons atteindre un débit de paiements beaucoup plus important sur le Lightning Network (hors chaîne) que le débit de transactions pouvant être géré par la blockchain Bitcoin (sur la chaîne).</p>
</div>
<div class="paragraph data-line-782">
<p>Dans les prochains chapitres, nous discuterons du routage, des HTLC et de leur utilisation dans les opérations de canaux.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-04-28 02:37:51 -0400
</div>
</div>
</body>
</html>