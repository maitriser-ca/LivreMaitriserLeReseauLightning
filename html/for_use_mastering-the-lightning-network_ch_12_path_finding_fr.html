<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Pathfinding et livraison de paiement</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-2">
<h2 id="path_finding">Pathfinding et livraison de paiement</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>La livraison de paiements sur le Lightning Network dépend de la recherche d&#8217;un chemin de l&#8217;expéditeur au destinataire, un processus appelé <em>pathfinding</em>. Étant donné que le routage est effectué par l&#8217;expéditeur, ce dernier doit trouver un chemin approprié pour atteindre la destination. Ce chemin est ensuite encodé dans un oignon, comme nous l&#8217;avons vu dans <a href="#onion_routing">[onion_routing]</a>.</p>
</div>
<div class="paragraph data-line-6">
<p>Dans ce chapitre, nous examinerons le problème du pathfinding,  comprendrons comment l&#8217;incertitude sur les soldes des canaux complique ce problème et examinerons comment une implémentation typique du pathfinding tente de le résoudre.</p>
</div>
<div class="sect2 data-line-8">
<h3 id="_le_pathfinding_dans_la_suite_de_protocoles_lightning">Le pathfinding dans la suite de protocoles Lightning</h3>
<div class="paragraph data-line-10">
<p>Le pathfinding, la sélection de chemins, les paiements en plusieurs parties (MPP ou "multipart payments" en anglais) et les tentatives de paiement par en boucle d&#8217;essais-et-erreurs occupent la majorité de la couche de paiement au sommet de la suite de protocoles.</p>
</div>
<div class="paragraph data-line-12">
<p>Ces composants sont mis en évidence par un contour épais dans la suite de protocoles dans <a href="#LN_protocol_pathfinding_highlight">Livraison de paiements dans la suite de protocoles Lightning</a>.</p>
</div>
<div id="LN_protocol_pathfinding_highlight" class="imageblock data-line-16">
<div class="content">
<img src="images/mtln_1201.png" alt="Livraison de paiements dans la suite de protocoles Lightning">
</div>
<div class="title">Figure 1. Livraison de paiements dans la suite de protocoles Lightning</div>
</div>
<div class="sect3 data-line-18">
<h4 id="_où_est_le_bolt">Où est le BOLT ?</h4>
<div class="paragraph data-line-20">
<p>Jusqu&#8217;à présent, nous avons examiné plusieurs technologies qui font partie du Lightning Network et nous avons vu leurs spécifications exactes dans le cadre des standards BOLT. Vous pourriez être surpris de constater que le pathfinding ne fait pas partie des BOLT !</p>
</div>
<div class="paragraph data-line-22">
<p>En effet, la pathfinding n&#8217;est pas une activité qui nécessite une quelconque forme de coordination ou d&#8217;interopérabilité entre les différentes implémentations. Comme nous l&#8217;avons vu, le chemin est sélectionné par l&#8217;expéditeur. Même si les détails de routage sont spécifiés en détail dans les BOLT, la découverte et la sélection du chemin sont entièrement laissées à l&#8217;expéditeur. Ainsi, chaque implémentation de nœud peut choisir une stratégie/un algorithme différent pour trouver des chemins. En fait, les différentes implémentations de nœud/client et de porte-monnaie peuvent même rivaliser et utiliser leur algorithme de pathfinding comme point de différenciation.</p>
</div>
</div>
</div>
<div class="sect2 data-line-24">
<h3 id="_pathfinding_quel_problème_résolvons_nous">Pathfinding : Quel problème résolvons-nous ?</h3>
<div class="paragraph data-line-26">
<p>Le terme pathfinding peut être quelque peu trompeur car il implique une recherche <em>d&#8217;un seul chemin</em> reliant deux nœuds. Au début, lorsque le Lightning Network était petit et mal interconnecté, le problème était en effet de trouver un moyen de rejoindre les canaux de paiement pour atteindre le destinataire.</p>
</div>
<div class="paragraph data-line-28">
<p>Mais, à mesure que le Lightning Network s&#8217;est développé de manière explosive, la nature du problème du pathfinding a changé. À la mi-2021, alors que nous terminons ce livre, le Lightning Network se compose de 20 000 nœuds connectés par au moins 55 000 canaux publics avec une capacité totale de près de 2 000 BTC. Un nœud a en moyenne 8,8 canaux, tandis que les 10 nœuds les plus connectés ont entre 400 et 2 000 canaux <em>chacun</em>. Une visualisation d&#8217;un petit sous-ensemble du graphe des canaux LN est présentée dans <a href="#lngraph">Une visualisation d&#8217;une partie du Lightning Network en juillet 2021</a>.</p>
</div>
<div id="lngraph" class="imageblock data-line-32">
<div class="content">
<img src="images/mtln_1202.png" alt="mtln 1202">
</div>
<div class="title">Figure 2. Une visualisation d&#8217;une partie du Lightning Network en juillet 2021</div>
</div>
<div class="admonitionblock note data-line-35">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-36">
<p>La visualisation du réseau dans <a href="#lngraph">Une visualisation d&#8217;une partie du Lightning Network en juillet 2021</a> a été produit avec un simple script Python que vous pouvez trouver dans code/lngraph dans le dépôt du livre.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-39">
<p>Si l&#8217;expéditeur et le destinataire sont connectés à d&#8217;autres nœuds bien connectés et ont au moins un canal avec une capacité adéquate, il y aura des milliers de chemins. Le problème devient alors la sélection du <em>meilleur</em> chemin qui réussira la livraison du paiement, parmi une liste de milliers de chemins possibles.</p>
</div>
<div class="sect3 data-line-41">
<h4 id="_sélection_du_meilleur_chemin">Sélection du meilleur chemin</h4>
<div class="paragraph data-line-43">
<p>Pour sélectionner le meilleur chemin, nous devons d&#8217;abord définir ce que nous entendons par "meilleur". Il peut y avoir de nombreux critères différents, tels que :</p>
</div>
<div class="ulist data-line-45">
<ul>
<li class="data-line-45">
<p>Les chemins avec suffisamment de liquidités. Évidemment, si un chemin n&#8217;a pas assez de liquidités pour acheminer notre paiement, alors ce n&#8217;est pas un chemin approprié.</p>
</li>
<li class="data-line-47">
<p>Les chemins avec des frais peu élevés. Si nous avons plusieurs candidats, nous pouvons choisir ceux dont les frais sont moins élevés.</p>
</li>
<li class="data-line-49">
<p>Les chemins avec des timelocks courts. Nous pouvons vouloir éviter de bloquer nos fonds trop longtemps et donc sélectionner des chemins avec des délais plus courts.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-51">
<p>Tous ces critères peuvent être souhaitables dans une certaine mesure, et il n&#8217;est pas facile de sélectionner des chemins qui soient favorables sur plusieurs de ces aspects. Les problèmes d&#8217;optimisation comme celui-ci peuvent être trop complexes à résoudre pour la "meilleure" solution, mais peuvent souvent être résolus pour une certaine approximation de l&#8217;optimum, ce qui est une bonne nouvelle car sinon, la pathfinding serait un problème insoluble.</p>
</div>
</div>
<div class="sect3 data-line-54">
<h4 id="_le_pathfinding_en_mathématiques_et_en_informatique">Le pathfinding en mathématiques et en informatique</h4>
<div class="paragraph data-line-56">
<p>Le pathfinding dans le Lightning Network relève de la catégorie générale de la <em>théorie des graphes</em> en mathématiques et de la catégorie plus spécifique de la <em>traversée des graphes</em> en informatique.</p>
</div>
<div class="paragraph data-line-58">
<p>Un réseau tel que le Lightning Network peut être représenté comme une construction mathématique appelée <em>graphe</em>, dans laquelle des <em>nœuds</em> sont connectés les uns aux autres par des <em>arêtes</em> (équivalentes aux canaux de paiement). Le Lightning Network forme un <em>graphe orienté</em> car les nœuds sont liés de manière <em>asymétrique</em>, puisque le solde du canal est réparti entre les deux partenaires de canal et la liquidité de paiement est différente dans chaque direction. Un graphe orienté avec des contraintes de capacité numériques sur ses arêtes est appelé un <em>réseau de flot</em>, une construction mathématique utilisée pour optimiser le transport et d&#8217;autres réseaux similaires. Les réseaux de flots peuvent être utilisés comme cadre lorsque les solutions doivent atteindre un flux spécifique tout en minimisant les coûts, connu sous le nom de problème de flot à coût minimum ("Minimum Cost Flow Problem" ou "MCFP" en anglais).</p>
</div>
</div>
<div class="sect3 data-line-60">
<h4 id="_capacité_solde_liquidité">Capacité, Solde, Liquidité</h4>
<div class="paragraph data-line-62">
<p>Pour mieux comprendre le problème du transport des satoshis d&#8217;un point A à un point B, nous devons mieux définir trois termes importants : capacité, solde et liquidité. Nous utilisons ces termes pour décrire la compétence d&#8217;un canal de paiement à router un paiement.</p>
</div>
<div class="paragraph data-line-64">
<p>Dans un canal de paiement reliant A&#8592;&#8594;B :</p>
</div>
<div class="dlist data-line-66">
<dl>
<dt class="hdlist1">Capacité</dt>
<dd>
<p>Il s&#8217;agit du montant total en satoshis qui ont été financés dans le multisig 2-de-2 avec la transaction de financement. Cela représente la quantité maximale de valeur détenue dans le canal. La capacité du canal est annoncée par le protocole de bavardage et est connue des nœuds.</p>
</dd>
<dt class="hdlist1">Solde</dt>
<dd>
<p>Il s&#8217;agit du montant en satoshis détenu par chaque partenaire de canal qui peut être envoyé à l&#8217;autre partenaire de canal. Un sous-ensemble du solde de A peut être envoyé dans le sens (A&#8594;B) vers le nœud B. Un sous-ensemble du solde de B peut être envoyé dans le sens opposé (A&#8592;B).</p>
</dd>
<dt class="hdlist1">Liquidité</dt>
<dd>
<p>Le solde disponible (sous-ensemble) qui peut réellement être envoyé à travers le canal dans une direction. La liquidité de A est égale au solde de A moins la réserve de canal et tous les HTLC en attente engagés par A.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-72">
<p>La seule valeur connue du réseau (via les annonces de bavardage) est la capacité globale du canal. Une partie inconnue de cette capacité est distribuée en tant que solde de chaque partenaire. Un sous-ensemble de ce solde est disponible pour être envoyé sur le canal dans une direction :</p>
</div>
<ul class="simplelist">
<li>capacité = solde(A) + solde(B)</li>
<li>liquidité(A) = solde(A) – réserve_canal(A) – HTLC_en_attente(A)</li>
</ul>
</div>
<div class="sect3 data-line-81">
<h4 id="_incertitude_quant_aux_soldes">Incertitude quant aux soldes</h4>
<div class="paragraph data-line-83">
<p>Si nous connaissions les soldes exacts de chaque canal, nous pourrions calculer un ou plusieurs chemins de paiement en utilisant l&#8217;un des algorithmes de pathfinding standard enseignés dans les bons cours d&#8217;informatiques. Mais nous ne connaissons pas les soldes des canaux ; nous ne connaissons que la capacité de canal agrégée, qui est annoncée par les nœuds dans les annonces de canal. Pour qu&#8217;un paiement réussisse, il doit y avoir un solde adéquat du côté expéditeur du canal. Si nous ne savons pas comment la capacité est répartie entre les partenaires de canal, nous ne savons pas s&#8217;il y a suffisamment de solde dans la direction dans laquelle nous essayons d&#8217;envoyer le paiement.</p>
</div>
<div class="paragraph data-line-85">
<p>Les soldes ne sont pas annoncés dans les mises à jour des canaux pour deux raisons : la confidentialité et l&#8217;évolutivité. Premièrement, l&#8217;annonce des soldes réduirait la confidentialité du Lightning Network car elle permettrait une surveillance des paiements par une analyse statistique de l&#8217;évolution des soldes. Deuxièmement, si les nœuds annonçaient des soldes (globalement) à chaque paiement, l&#8217;évolutivité du Lightning Network serait aussi mauvaise que celle des transactions Bitcoin sur la chaîne qui sont diffusées à tous les participants. Par conséquent, les soldes ne sont pas annoncés. Pour résoudre le problème du pathfinding face à l&#8217;incertitude des soldes, nous avons besoin de stratégies innovantes de pathfinding. Ces stratégies doivent être étroitement liées à l&#8217;algorithme de routage utilisé, qui est un routage en oignon basé sur la source, où il incombe à l&#8217;expéditeur de trouver un chemin à travers le réseau.</p>
</div>
<div class="paragraph data-line-87">
<p>Le problème d&#8217;incertitude peut être décrit mathématiquement comme une <em>gamme de liquidité</em>, indiquant les limites inférieure et supérieure de la liquidité sur la base des informations connues. Puisque nous connaissons la capacité du canal et que nous connaissons le solde de réserve du canal (le solde minimum autorisé à chaque extrémité), la liquidité peut être définie comme :</p>
</div>
<ul class="simplelist">
<li>min(liquidité) = réserve_canal</li>
<li>max(liquidité) = capacité – réserve_canal</li>
</ul>
<div class="paragraph pagebreak-before data-line-97">
<p>ou sous forme d&#8217;une plage :</p>
</div>
<ul class="simplelist">
<li>réserve_canal <= liquidité <= (capacité – réserve_canal)</li>
</ul>
<div class="paragraph data-line-105">
<p>Notre plage d&#8217;incertitude de liquidités de canal est la plage entre la liquidité minimale et maximale possible. Ceci est inconnu du réseau, à l&#8217;exception des deux partenaires de canal. Cependant, comme nous le verrons, nous pouvons utiliser les HTLC échoués renvoyés par nos tentatives de paiement pour mettre à jour notre estimation de liquidité et réduire l&#8217;incertitude. Si, par exemple, nous obtenons un code d&#8217;échec HTLC qui nous indique qu&#8217;un canal ne peut pas remplir un HTLC inférieur à notre estimation de liquidité maximale, cela signifie que la liquidité maximale peut être mise à jour au montant du HTLC ayant échoué. En termes plus simples, si nous pensons que la liquidité peut gérer un HTLC de <em>N</em> satoshis et que nous découvrons qu&#8217;elle ne parvient pas à fournir <em>M</em> satoshis (où <em>M</em> est plus petit), alors nous pouvons mettre à jour notre estimation à <em>M</em>–1 comme limite supérieure. On a essayé de trouver le plafond et on s&#8217;y est cogné, donc c&#8217;est plus bas qu&#8217;on ne le pensait !</p>
</div>
</div>
<div class="sect3 data-line-107">
<h4 id="_complexité_du_pathfinding">Complexité du pathfinding</h4>
<div class="paragraph data-line-109">
<p>Trouver un chemin à travers un graphe est un problème que les ordinateurs modernes peuvent résoudre assez efficacement.
Les développeurs choisissent principalement le parcours en largeur ("Breadth-First Search" ou "BFS" en anglais) d&#8217;abord si les arêtes ont toutes le même poids.
Dans les cas où les arêtes ne sont pas de poids égal, un algorithme basé sur l&#8217;algorithme de Dijkstra est utilisé, tel que <a href="https://fr.wikipedia.org/wiki/Algorithme_A*" data-href="https://fr.wikipedia.org/wiki/Algorithme_A*">A* (prononcé "A étoile")</a>.
Dans notre cas, les poids des arêtes peuvent représenter les frais de routage.
Seules les arêtes dont la capacité est supérieure à la quantité à envoyer seront inclues dans la recherche.
Dans cette forme de base, la pathfinding sur le Lightning Network est très simple et directe.</p>
</div>
<div class="paragraph data-line-116">
<p>Cependant, la liquidité du canal est inconnue de l&#8217;expéditeur. Cela transforme notre problème informatique théorique simple en un problème du monde réel plutôt complexe.
Nous devons maintenant résoudre un problème de pathfinding avec seulement des connaissances partielles.
Par exemple, nous soupçonnons quelles arêtes pourraient être en mesure de transférer un paiement car leur capacité semble suffisamment grande.
Mais nous ne pouvons pas être certains à moins de l&#8217;essayer ou de demander directement aux propriétaires du canal.
Même si nous pouvions demander directement aux propriétaires du canal, leur solde pourrait changer avant que nous ayons interrogé d&#8217;autres personnes, calculé un chemin, construit un oignon et l&#8217;ayons envoyé.
Non seulement nous disposons d&#8217;informations limitées, mais les informations dont nous disposons sont très dynamiques et peuvent changer à tout moment à notre insu.</p>
</div>
</div>
<div class="sect3 data-line-123">
<h4 id="_faire_simple">Faire simple</h4>
<div class="paragraph data-line-125">
<p>Le mécanisme de pathfinding implémenté dans les nœuds Lightning consiste à créer d&#8217;abord une liste de chemins candidats, filtrés et triés par une fonction. Ensuite, le nœud ou le porte-monnaie sondera les chemins (en tentant de livrer un paiement) dans une boucle d&#8217;essais-et-d&#8217;erreurs jusqu&#8217;à ce qu&#8217;un chemin qui livre avec succès le paiement soit trouvé.</p>
</div>
<div class="admonitionblock note data-line-128">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-129">
<p>Ce sondage est effectué par le nœud Lightning ou le porte-monnaie et n&#8217;est pas directement observé par l&#8217;utilisateur du logiciel.
Cependant, l&#8217;utilisateur peut soupçonner qu&#8217;un sondage est en cours si le paiement n&#8217;est pas effectué instantanément.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-133">
<p>Bien que le sondage à l&#8217;aveugle ne soit pas optimal et laisse une grande marge d&#8217;amélioration, il convient de noter que même cette stratégie simpliste fonctionne étonnamment bien pour les petits paiements et les nœuds bien connectés.</p>
</div>
<div class="paragraph data-line-135">
<p>La plupart des implémentations de nœuds et de porte-monnaie Lightning améliorent cette approche en ordonnant/pondérant la liste des chemins candidats. Certaines implémentations classent les chemins candidats par coût (frais) ou une combinaison de coût et de capacité.</p>
</div>
</div>
</div>
<div class="sect2 data-line-137">
<h3 id="_pathfinding_et_processus_de_livraison_de_paiement">Pathfinding et processus de livraison de paiement</h3>
<div class="paragraph data-line-139">
<p>Le pathfinding et la livraison de paiement impliquent plusieurs étapes, que nous énumérons ici. Différentes implémentations peuvent utiliser différents algorithmes et stratégies, mais les étapes de base sont susceptibles d&#8217;être très similaires :</p>
</div>
<div class="olist arabic data-line-141">
<ol class="arabic">
<li class="data-line-141">
<p>Créer un <em>graphe des canaux</em> à partir des annonces et des mises à jour contenant la capacité de chaque canal, et filtrez le graphe, en ignorant tous les canaux dont la capacité est insuffisante pour le montant que nous voulons envoyer.</p>
</li>
<li class="data-line-143">
<p>Trouver des chemins reliant l&#8217;expéditeur au destinataire.</p>
</li>
<li class="data-line-145">
<p>Trier les chemins selon une certaine pondération (cela peut faire partie de <span class="keep-together">l'algorithme</span> de l&#8217;étape précédente).</p>
</li>
<li class="data-line-147">
<p>Essayer chaque chemin dans l&#8217;ordre jusqu&#8217;à ce que le paiement réussisse (la boucle d&#8217;essais-et-d&#8217;erreurs).</p>
</li>
<li class="data-line-149">
<p>Utiliser potentiellement les retours en cas d&#8217;échec de HTLC pour mettre à jour notre graphe, en réduisant <span class="keep-together">l'incertitude</span>.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-151">
<p>Nous pouvons regrouper ces étapes en trois activités principales :</p>
</div>
<div class="ulist data-line-153">
<ul>
<li class="data-line-153">
<p>Construction du graphe des canaux</p>
</li>
<li class="data-line-154">
<p>Pathfinding (filtré et ordonné selon certaines heuristiques)</p>
</li>
<li class="data-line-155">
<p>Tentative(s) de paiement</p>
</li>
</ul>
</div>
<div class="paragraph data-line-157">
<p>Ces trois activités peuvent être répétées dans un <em>tour de paiement</em> si nous utilisons les retours en cas d&#8217;échec pour mettre à jour le graphe, ou si nous faisons des paiements en plusieurs parties (voir <a href="#mpp">Paiements en plusieurs parties</a>).</p>
</div>
<div class="paragraph data-line-159">
<p>Dans les sections suivantes, nous examinerons chacune de ces étapes plus en détail, ainsi que des stratégies de paiement plus avancées.</p>
</div>
</div>
<div class="sect2 data-line-161">
<h3 id="_construction_du_graphe_des_canaux">Construction du graphe des canaux</h3>
<div class="paragraph data-line-163">
<p>Dans <a href="#gossip">[gossip]</a> nous avons couvert les trois principaux messages que les nœuds utilisent dans leurs bavardages : node_announcement, channel_announcement et channel_update. Ces trois messages permettent à n&#8217;importe quel nœud de construire progressivement une "carte" du Lightning Network sous la forme d&#8217;un <em>graphe des canaux</em>. Chacun de ces messages fournit une information essentielle pour le graphe des canaux :</p>
</div>
<div class="dlist data-line-165">
<dl>
<dt class="hdlist1">node_announcement</dt>
<dd>
<p>Ceci contient les informations sur un nœud sur le Lightning Network, telles que son ID de nœud (clé publique), son adresse réseau (par exemple, IPv4/6 ou Tor), ses capacités/ fonctionnalités, etc.</p>
</dd>
<dt class="hdlist1">channel_announcement</dt>
<dd>
<p>Ceci contient la capacité et l&#8217;ID de canal d&#8217;un canal public (annoncé) entre deux nœuds et une preuve de l&#8217;existence et la propriété du canal.</p>
</dd>
<dt class="hdlist1">channel_update</dt>
<dd>
<p>Cela contient les attentes de frais et de timelock (CLTV) d&#8217;un nœud pour acheminer un paiement sortant (du point de vue de ce nœud) sur un canal spécifié.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-171">
<p>En termes de graphe mathématique, le node_announcement est l&#8217;information nécessaire pour créer les nœuds ou <em>sommets</em> du graphe. Le channel_announcement nous permet de créer les <em>arêtes</em> du graphe représentant les canaux de paiement. Étant donné que chaque direction du canal de paiement a son propre solde, nous créons un graphe orienté. Le channel_update nous permet d&#8217;incorporer des frais et des timelocks pour définir le <em>coût</em> ou <em>poids</em> des arêtes du graphe.</p>
</div>
<div class="paragraph data-line-173">
<p>Selon l&#8217;algorithme que nous utiliserons pour le pathfinding, nous pouvons établir un certain nombre de fonctions de coût différentes pour les arêtes du graphe.</p>
</div>
<div class="paragraph data-line-175">
<p>Pour l&#8217;instant, ignorons la fonction de coût et établissons simplement un graphe des canaux affichant les nœuds et les canaux, en utilisant les messages node_announcement et channel_announcement.</p>
</div>
<div class="paragraph data-line-177">
<p>Dans ce chapitre, nous verrons comment Selena tente de trouver un moyen de payer Rashid un million de satoshis. Pour commencer, Selena construit un graphe des canaux en utilisant les informations des bavardages du Lightning Network pour découvrir les nœuds et les canaux. Selena explorera ensuite son graphe des canaux pour trouver un chemin pour envoyer un paiement à Rashid.</p>
</div>
<div class="paragraph data-line-179">
<p>Il s&#8217;agit du graphe des canaux <em>de Selena</em>. L&#8217;expression <em>le</em> graphe des canaux n&#8217;existe pas vraiment, il n&#8217;y a <em>qu&#8217;un graphe des canaux</em> et c&#8217;est toujours celui du point de vue du nœud qui l&#8217;a construit (voir <a href="#map_territory_relation">La relation carte-territoire</a>).</p>
</div>
<div class="admonitionblock tip data-line-182">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-183">
<p>Selena ne construit pas de graphe des canaux uniquement lors de l&#8217;envoi d&#8217;un paiement. Au lieu de cela, le nœud de Selena construit et met à jour <em>continuellement</em> un graphe des canaux. À partir du moment où le nœud de Selena démarre et se connecte à n&#8217;importe quel pair du réseau, il participera aux bavardages et utilisera chaque message pour en apprendre le plus possible sur le réseau.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="map_territory_relation" class="sidebarblock data-line-188">
<div class="content">
<div class="title">La relation carte-territoire</div>
<div class="paragraph data-line-189">
<p>De Wikipédia <a href="https://en.wikipedia.org/wiki/Map%E2%80%93territory_relation" data-href="https://en.wikipedia.org/wiki/Map%E2%80%93territory_relation">page sur la relation carte-territoire (en anglais)</a>, "La relation carte-territoire décrit la relation entre un objet et une représentation de cet objet, comme dans la relation entre un territoire géographique et une carte de celui-ci."</p>
</div>
<div class="paragraph data-line-191">
<p>La relation carte-territoire est mieux illustrée dans "Sylvie et Bruno", une nouvelle de Lewis Carroll qui décrit une carte fictive à l&#8217;échelle 1:1 du territoire qu&#8217;elle cartographie, ayant donc une précision parfaite mais devenant complètement inutile car elle couvrirait tout le territoire si elle était déployée.</p>
</div>
<div class="paragraph data-line-193">
<p>Qu&#8217;est-ce que cela signifie pour le Lightning Network ? Le Lightning Network est le territoire et un graphe des canaux est une carte de ce territoire.</p>
</div>
<div class="paragraph data-line-195">
<p>Alors que nous pourrions imaginer un graphe des canaux théorique (idéal platonicien) qui représente la carte complète et à jour du Lightning Network, une telle carte est simplement le Lightning Network lui-même. Chaque nœud a son propre graphe des canaux qui est construit à partir d&#8217;annonces et qui est nécessairement incomplet, incorrect et obsolète !</p>
</div>
<div class="paragraph data-line-197">
<p>La carte ne peut jamais décrire complètement et précisément le territoire.</p>
</div>
</div>
</div>
<div class="paragraph data-line-200">
<p>Selena écoute les messages node_announcement et découvre quatre autres nœuds (en plus de Rashid, le destinataire prévu). Le graphe résultant représente un réseau de six nœuds : Selena et Rashid sont respectivement l&#8217;expéditeur et le destinataire ; Alice, Bob, Xavier et Yan sont des nœuds intermédiaires. Le graphe initial de Selena n&#8217;est qu&#8217;une liste de nœuds, comme illustrée dans <a href="#channel_graph_nodes">Annonces de nœuds</a>.</p>
</div>
<div id="channel_graph_nodes" class="imageblock data-line-204">
<div class="content">
<img src="images/mtln_1203.png" alt="mtln 1203">
</div>
<div class="title">Figure 3. Annonces de nœuds</div>
</div>
<div class="paragraph data-line-206">
<p>Selena reçoit également sept messages channel_announcement avec les capacités de canal correspondantes, lui permettant de construire une "carte" de base du réseau, illustrée dans <a href="#channel_graph_1">Le graphe des canaux</a>. (Les noms Alice, Bob, Selena, Xavier, Yan et Rashid ont été remplacés par leurs initiales : A, B, S, X et R, respectivement.)</p>
</div>
<div id="channel_graph_1" class="imageblock data-line-210">
<div class="content">
<img src="images/mtln_1204.png" alt="mtln 1204">
</div>
<div class="title">Figure 4. Le graphe des canaux</div>
</div>
<div class="sect4 data-line-212">
<h5 id="_incertitude_dans_le_graphe_des_canaux">Incertitude dans le graphe des canaux</h5>
<div class="paragraph data-line-214">
<p>Comme vous pouvez le voir sur <a href="#channel_graph_1">Le graphe des canaux</a>, Selena ne connaît aucun des soldes des canaux. Son graphe initial des canaux contient le niveau d&#8217;incertitude le plus élevé.</p>
</div>
<div class="paragraph data-line-216">
<p>Mais attendez : Selena connaît les soldes de <em>certains</em> canaux ! Elle connaît les soldes des canaux que son propre nœud a connectés avec d&#8217;autres nœuds. Bien que cela ne semble pas grand-chose, il s&#8217;agit en fait d&#8217;informations très importantes pour construire un chemin — Selena connaît la liquidité réelle de ses propres canaux. Mettons à jour le graphe des canaux pour afficher ces informations. Nous utiliserons un symbole "?" pour représenter les soldes inconnus, comme illustré dans <a href="#channel_graph_2">Graphe des canaux avec soldes connus et inconnus</a>.</p>
</div>
<div id="channel_graph_2" class="imageblock data-line-220">
<div class="content">
<img src="images/mtln_1205.png" alt="mtln 1205">
</div>
<div class="title">Figure 5. Graphe des canaux avec soldes connus et inconnus</div>
</div>
<div class="paragraph data-line-222">
<p>Bien que le symbole "?" puisse sembler inquiétant, un manque de certitude n&#8217;est pas la même chose qu&#8217;une ignorance complète. Nous pouvons <em>quantifier</em> l&#8217;incertitude et la <em>réduire</em> en mettant à jour le graphe avec les HTLC réussis/échoués que nous tentons.</p>
</div>
<div class="paragraph data-line-224">
<p>L&#8217;incertitude peut être quantifiée, car nous connaissons la liquidité maximale et minimale possible et pouvons calculer des probabilités pour des plages plus petites (plus précises).</p>
</div>
<div class="paragraph data-line-226">
<p>Lorsque nous tentons d&#8217;envoyer un HTLC, nous pouvons en savoir plus sur les soldes des canaux : si nous réussissons, alors le solde était <em>au moins</em> suffisant pour transporter le montant spécifique. Alors que si nous obtenons une erreur "défaillance temporaire du canal", la raison la plus probable est un manque de liquidité pour le montant spécifique.</p>
</div>
<div class="admonitionblock tip data-line-229">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-230">
<p>Vous pensez peut-être : "Quel est l&#8217;intérêt d&#8217;apprendre d&#8217;un HTLC réussi ?" Après tout, si cela réussit, nous en avons "terminé". Mais considérez que nous pouvons envoyer une partie d&#8217;un paiement en plusieurs parties. Nous pouvons également envoyer d&#8217;autres paiements en une partie dans un court laps de temps. Tout ce que nous apprenons sur la liquidité est utile pour la prochaine tentative !</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-233">
<h4 id="_incertitude_et_probabilité_de_liquidité">Incertitude et probabilité de liquidité</h4>
<div class="paragraph data-line-235">
<p>Pour quantifier l&#8217;incertitude de la liquidité d&#8217;un canal, nous pouvons appliquer la théorie des probabilités. Un modèle de base de la probabilité de livraison des paiements conduira à des conclusions plutôt évidentes, mais importantes :</p>
</div>
<div class="ulist data-line-237">
<ul>
<li class="data-line-237">
<p>Les petits paiements ont de meilleures chances d&#8217;être livrés avec succès sur un chemin.</p>
</li>
<li class="data-line-239">
<p>Des canaux de plus grande capacité nous donneront une meilleure chance de livraison de paiement pour un montant spécifique.</p>
</li>
<li class="data-line-241">
<p>Plus il y a de canaux (sauts), plus les chances de succès sont faibles.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-243">
<p>Bien que celles-ci puissent paraître évidentes, elles ont des implications importantes, en particulier pour l&#8217;utilisation des paiements en plusieurs parties (voir <a href="#mpp">Paiements en plusieurs parties</a>). Le calcul n&#8217;est pas difficile à suivre.</p>
</div>
<div class="paragraph data-line-245">
<p>Utilisons la théorie des probabilités pour voir comment nous sommes arrivés à ces conclusions.</p>
</div>
<div class="paragraph data-line-247">
<p>Tout d&#8217;abord, supposons qu&#8217;un canal avec une capacité <em>c</em> a une liquidité d&#8217;un côté avec une valeur inconnue dans la plage de (0, <em>c</em>) ou une "plage entre 0 et <em>c</em>". Par exemple, si la capacité est de 5, alors la liquidité sera dans la plage (0, 5). Maintenant, à partir de cela, nous voyons que si nous voulons envoyer 5 satoshis, notre chance de succès n&#8217;est que de 1 sur 6 (16,66%), car nous ne réussirons que si la liquidité est exactement de 5.</p>
</div>
<div class="paragraph data-line-249">
<p>Plus simplement, si les valeurs possibles pour la liquidité sont 0, 1, 2, 3, 4 et 5, une seule de ces six valeurs possibles sera suffisante pour envoyer notre paiement. Pour continuer cet exemple, si notre montant de paiement était de 3, alors nous réussirions si la liquidité était de 3, 4 ou 5. Nos chances de succès sont donc de 3 sur 6 (50%). Exprimée en mathématiques, la fonction de probabilité de succès pour un seul canal est :</p>
</div>
<div class="stemblock data-line-252">
<div class="content">
\[$P_c(a) = (c + 1 - a) / (c + 1)$\]
</div>
</div>
<div class="paragraph data-line-256">
<p>où <em>a</em> est le montant et <em>c</em> est la capacité.</p>
</div>
<div class="paragraph data-line-258">
<p>De l&#8217;équation, nous voyons que si le montant est proche de 0, la probabilité est proche de 1, alors que si le montant dépasse la capacité, la probabilité est nulle.</p>
</div>
<div class="paragraph data-line-260">
<p>En d&#8217;autres termes : "Les petits paiements ont de meilleures chances d&#8217;être livrés avec succès" ou "Les canaux de plus grande capacité nous donnent de meilleures chances de livraison pour un montant spécifique" et "Vous ne pouvez pas envoyer un paiement sur un canal dont la capacité est insuffisante".</p>
</div>
<div class="paragraph data-line-262">
<p>Réfléchissons maintenant à la probabilité de succès sur un chemin composé de plusieurs canaux. Supposons que notre premier canal ait 50% de chances de succès (<em>P</em> = 0,5). Ensuite, si notre deuxième canal a 50% de chances de succès (<em>P</em> = 0,5), il est intuitif que notre chance globale soit de 25% (<em>P</em> = 0,25).</p>
</div>
<div class="paragraph data-line-264">
<p>Nous pouvons exprimer cela sous la forme d&#8217;une équation qui calcule la probabilité de succès d&#8217;un paiement en tant que produit des probabilités pour chaque canal dans le(s) chemin(s) :</p>
</div>
<div class="stemblock data-line-267">
<div class="content">
\[$P_{paiement} = \prod_{i=1}^n P_i$\]
</div>
</div>
<div class="paragraph data-line-271">
<p>Où <em>P</em><sub><em>i</em></sub> est la probabilité de succès sur un chemin ou un canal, et <em>P</em><sub><em>paiement</em></sub> est la probabilité globale d&#8217;un paiement réussi sur tous les chemins/canaux.</p>
</div>
<div class="paragraph data-line-273">
<p>À partir de l&#8217;équation, nous voyons que puisque la probabilité de succès sur un seul canal est toujours inférieure ou égale à 1, la probabilité sur de nombreux canaux chutera de manière exponentielle.</p>
</div>
<div class="paragraph data-line-275">
<p>En d&#8217;autres termes, "Plus vous utilisez de canaux (sauts), plus les chances de succès sont faibles."</p>
</div>
<div class="admonitionblock note data-line-278">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-279">
<p>Il y a beaucoup de théorie mathématique et de modélisation derrière l&#8217;incertitude de la liquidité dans les canaux. Des travaux fondamentaux sur la modélisation des intervalles d&#8217;incertitude de la liquidité du canal peuvent être trouvés dans l&#8217;article <a href="https://arxiv.org/abs/2103.08576" data-href="https://arxiv.org/abs/2103.08576">"Security and Privacy of Lightning Network Payments with Uncertain Channel Balances"</a> de Pickhardt (co-auteur de ce livre) <span class="keep-together">et al</span>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-282">
<h4 id="_frais_et_autres_métriques_de_canal">Frais et autres métriques de canal</h4>
<div class="paragraph data-line-284">
<p>Par la suite, notre expéditeur ajoutera des informations au graphe à partir des messages channel_update reçus des nœuds intermédiaires. Pour rappel, le channel_update contient une mine d&#8217;informations sur un canal et les attentes d&#8217;un des partenaires de canal.</p>
</div>
<div class="paragraph data-line-286">
<p>Dans <a href="#channel_graph_3">Graphe des canaux : Frais et autres métriques de canal</a> nous voyons comment Selena peut mettre à jour le graphe des canaux en fonction des messages channel_update de A, B, X et Y. Notez que l&#8217;ID du canal et la direction du canal (inclus dans channel_flags) indiquent à Selena à quel canal et à quelle direction cette mise à jour fait référence. Chaque partenaire de canal publie un ou plusieurs messages channel_update pour annoncer ses prévisions de frais et d&#8217;autres informations à propos du canal. Par exemple, en haut à gauche, nous voyons le channel_update envoyé par Alice pour le canal A&#8212;&#8203;B et le sens A-vers-B. Avec cette mise à jour, Alice indique au réseau combien elle facturera en frais pour acheminer un HTLC vers Bob sur ce canal spécifique. Bob peut annoncer une mise à jour de canal (non illustrée dans ce diagramme) pour la direction opposée avec des attentes de frais complètement différentes. N&#8217;importe quel nœud peut envoyer un nouveau channel_update pour modifier les frais ou les timelock attendus à tout moment.</p>
</div>
<div id="channel_graph_3" class="imageblock data-line-290">
<div class="content">
<img src="images/mtln_1206.png" alt="mtln 1206">
</div>
<div class="title">Figure 6. Graphe des canaux : Frais et autres métriques de canal</div>
</div>
<div class="paragraph data-line-292">
<p>Les informations sur les frais et les timelocks sont très importantes, et pas seulement en tant que métriques de sélection de chemin. Comme nous l&#8217;avons vu dans <a href="#onion_routing">[onion_routing]</a>, l&#8217;expéditeur doit additionner les frais et les timelocks (cltv_expiry_delta) à chaque saut pour créer l&#8217;oignon. Le processus de calcul des frais se déroule du destinataire à l&#8217;expéditeur <em>à reculons</em> le long du chemin, car chaque saut intermédiaire attend un HTLC entrant avec un montant et un délai d&#8217;expiration plus élevés que le HTLC sortant qu&#8217;il enverra au prochain saut. Ainsi, par exemple, si Bob veut 1 000 satoshis de frais et 30 blocs de delta de délai d&#8217;expiration pour envoyer un paiement à Rashid, alors ce montant et ce delta d&#8217;expiration doivent être ajoutés au HTLC <em>provenant d&#8217;Alice</em>.</p>
</div>
<div class="paragraph data-line-294">
<p>Il est également important de noter qu&#8217;un canal doit avoir une liquidité suffisante non seulement pour le montant du paiement, mais également pour les frais cumulés de tous les sauts suivants. Même si le canal de Selena vers Xavier (S&#8594;X) a suffisamment de liquidités pour un paiement de 1 million de satoshis, il <em>n&#8217;a pas</em> assez de liquidités une fois que l&#8217;on considère les frais. Nous devons connaître les frais, car seuls les chemins qui ont une liquidité suffisante pour <em>à la fois le paiement et tous les frais</em> seront pris en compte.</p>
</div>
</div>
</div>
<div class="sect2 data-line-296">
<h3 id="_trouver_des_chemins_candidats">Trouver des chemins candidats</h3>
<div class="paragraph data-line-298">
<p>Trouver un chemin approprié à travers un graphe orienté comme celui-ci est un problème informatique bien étudié (connu sous le nom de <em>problème de plus court chemin</em>), qui peut être résolu par une variété d&#8217;algorithmes en fonction de l&#8217;optimisation souhaitée et des contraintes de ressources.</p>
</div>
<div class="paragraph data-line-300">
<p>L&#8217;algorithme le plus célèbre résolvant ce problème a été inventé par le mathématicien néerlandais E. W. Dijkstra en 1956, connu simplement sous le nom de <a href="https://fr.wikipedia.org/wiki/Algorithme_de_Dijkstra" data-href="https://fr.wikipedia.org/wiki/Algorithme_de_Dijkstra"><em>Algorithme de Dijkstra</em></a>. En plus de l&#8217;algorithme original de Dijkstra, il existe de nombreuses variantes et optimisations, telles que <a href="https://fr.wikipedia.org/wiki/Algorithme_A*" data-href="https://fr.wikipedia.org/wiki/Algorithme_A*">A* ("A étoile")</a>, qui est un algorithme basé sur l&#8217;heuristique.</p>
</div>
<div class="paragraph data-line-302">
<p>Comme mentionné précédemment, la "recherche" doit être appliquée <em>vers l&#8217;arrière</em> pour tenir compte des frais accumulés du destinataire à l&#8217;expéditeur. Ainsi, Dijkstra, A* ou un autre algorithme rechercherait un chemin du destinataire à l&#8217;expéditeur, en utilisant les frais, la liquidité estimée et le delta de timelock (ou une autre combinaison) comme fonction de coût pour chaque saut.</p>
</div>
<div class="paragraph data-line-304">
<p>À l&#8217;aide d&#8217;un tel algorithme, Selena calcule plusieurs chemins possibles vers Rashid, triés par chemin le plus court :</p>
</div>
<div class="olist arabic data-line-306">
<ol class="arabic">
<li class="data-line-306">
<p>S&#8594;A&#8594;B&#8594;R</p>
</li>
<li class="data-line-308">
<p>S&#8594;X&#8594;Y&#8594;R</p>
</li>
<li class="data-line-310">
<p>S&#8594;X&#8594;B&#8594;R</p>
</li>
<li class="data-line-312">
<p>S&#8594;A&#8594;B&#8594;X&#8594;Y&#8594;R</p>
</li>
</ol>
</div>
<div class="paragraph data-line-315">
<p>Mais, comme nous l&#8217;avons vu précédemment, le canal S&#8594;X n&#8217;a pas assez de liquidités pour un paiement de 1M satoshis une fois les frais pris en compte. Les voies 2 et 3 ne sont donc pas viables. Cela laisse les chemins 1 et 4 comme chemins possibles pour le paiement.</p>
</div>
<div class="paragraph data-line-317">
<p>Avec deux chemins possibles, Selena est prête à tenter la livraison !</p>
</div>
</div>
<div class="sect2 data-line-319">
<h3 id="_livraison_de_paiement_boucle_dessais_et_derreurs">Livraison de paiement (boucle d&#8217;essais-et-d&#8217;erreurs)</h3>
<div class="paragraph data-line-321">
<p>Le nœud de Selena démarre la boucle d&#8217;essais-et-d&#8217;erreurs en construisant les HTLC, en construisant l&#8217;oignon et en tentant de livrer le paiement. Pour chaque tentative, il y a trois résultats possibles :</p>
</div>
<div class="ulist pagebreak-before data-line-324">
<ul>
<li class="data-line-324">
<p>Un résultat réussi (update_fulfill_htlc)</p>
</li>
<li class="data-line-325">
<p>Une erreur (update_fail_htlc)</p>
</li>
<li class="data-line-326">
<p>Un paiement "bloqué" sans réponse (ni succès ni échec)</p>
</li>
</ul>
</div>
<div class="paragraph data-line-328">
<p>Si le paiement échoue, il peut être réessayé via un chemin différent en mettant à jour le graphe (modifiant les métriques des canaux) et en recalculant un chemin alternatif.</p>
</div>
<div class="paragraph data-line-330">
<p>Nous avons examiné ce qui se passe si le paiement est "bloqué" dans <a href="#stuck_payments">[stuck_payments]</a>. Le détail important est qu&#8217;un paiement bloqué est le pire résultat car nous ne pouvons pas réessayer avec un autre HTLC car les deux (celui bloqué et celui de la nouvelle tentative) pourraient éventuellement fonctionner et entraîner un double paiement.</p>
</div>
<div class="sect3 data-line-332">
<h4 id="_première_tentative_chemin_1">Première tentative (Chemin #1)</h4>
<div class="paragraph data-line-334">
<p>Selena tente le premier chemin (S&#8594;A&#8594;B&#8594;R). Elle construit l&#8217;oignon et l&#8217;envoie, mais reçoit un code d&#8217;échec du nœud de Bob. Bob signale une défaillance de canal temporaire avec un channel_update identifiant le canal B&#8594;R comme celui qui ne peut pas livrer. Cette tentative est illustrée dans <a href="#path_1_fail">La tentative du Chemin #1 échoue</a>.</p>
</div>
<div id="path_1_fail" class="imageblock data-line-338">
<div class="content">
<img src="images/mtln_1207.png" alt="mtln 1207">
</div>
<div class="title">Figure 7. La tentative du Chemin #1 échoue</div>
</div>
<div class="sect4 data-line-340">
<h5 id="_apprendre_dun_échec">Apprendre d&#8217;un échec</h5>
<div class="paragraph data-line-342">
<p>De ce code d&#8217;échec, Selena déduira que Bob n&#8217;a pas assez de liquidités pour effectuer le paiement à Rashid sur ce canal. Surtout, cet échec réduit l&#8217;incertitude de la liquidité de ce canal ! Auparavant, le nœud de Selena supposait que la liquidité du côté de Bob du canal se situait quelque part dans la plage (0, 4M). Maintenant, elle peut supposer que la liquidité est dans la plage (0, 999999). De même, Selena peut désormais supposer que la liquidité de ce canal du côté de Rashid est dans la plage (1M, 4M), au lieu de (0, 4M). Selena a beaucoup appris de cet échec.</p>
</div>
</div>
</div>
<div class="sect3 data-line-344">
<h4 id="_deuxième_tentative_chemin_4">Deuxième tentative (Chemin #4)</h4>
<div class="paragraph data-line-346">
<p>Maintenant, Selena tente le quatrième chemin candidat (S&#8594;A&#8594;B&#8594;X&#8594;Y&#8594;R). C&#8217;est un chemin plus long et cela entraînera plus de frais, mais c&#8217;est maintenant la meilleure option pour la livraison du paiement.</p>
</div>
<div class="paragraph data-line-348">
<p>Heureusement, Selena reçoit un message update_fulfill_htlc d&#8217;Alice, indiquant que le paiement a réussi, comme illustré dans <a href="#path_4_success">La tentative du Chemin #4 réussit</a>.</p>
</div>
<div id="path_4_success" class="imageblock data-line-352">
<div class="content">
<img src="images/mtln_1208.png" alt="mtln 1208">
</div>
<div class="title">Figure 8. La tentative du Chemin #4 réussit</div>
</div>
<div class="sect4 data-line-354">
<h5 id="_apprendre_dun_succès">Apprendre d&#8217;un succès</h5>
<div class="paragraph data-line-356">
<p>Selena a également beaucoup appris de ce paiement réussi. Elle sait maintenant que tous les canaux sur le chemin S&#8594;A&#8594;B&#8594;X&#8594;Y&#8594;R avaient suffisamment de liquidités pour effectuer le paiement. De plus, elle sait maintenant que chacun de ces canaux a déplacé le montant des HTLC (1M &#x2b; frais) à l&#8217;autre bout des canaux. Cela permet à Selena de recalculer la plage de liquidité du côté récepteur de tous les canaux de ce chemin, en remplaçant la liquidité minimale par 1M &#x2b; frais.</p>
</div>
</div>
<div class="sect4 data-line-358">
<h5 id="_connaissances_obsolètes">Connaissances obsolètes ?</h5>
<div class="paragraph data-line-360">
<p>Selena a maintenant une bien meilleure "carte" du Lightning Network (au moins en ce qui concerne ces sept canaux). Cette connaissance sera utile pour tout paiement ultérieur que Selena tentera d&#8217;effectuer.</p>
</div>
<div class="paragraph data-line-362">
<p>Cependant, ces connaissances deviennent quelque peu "obsolètes" lorsque les autres nœuds envoient ou acheminent des paiements. Selena ne verra jamais aucun de ces paiements (sauf si elle est l&#8217;expéditeur). Même si elle est impliquée dans le routage des paiements, le mécanisme de routage en oignon signifie qu&#8217;elle ne peut voir les changements que pour un saut (ses propres canaux).</p>
</div>
<div class="paragraph data-line-364">
<p>Par conséquent, le nœud de Selena doit considérer combien de temps conserver ces connaissances avant de supposer qu&#8217;elles sont obsolètes et ne sont plus utiles.</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-367">
<h3 id="mpp">Paiements en plusieurs parties</h3>
<div class="paragraph data-line-369">
<p><em>Les paiements en plusieurs parties ("Multipart payments" ou "MPP" en anglais)</em> sont une fonctionnalité qui a été introduite dans le Lightning Network en 2020 et qui est déjà très largement disponible. Les paiements en plusieurs parties permettent à un paiement d&#8217;être divisé en plusieurs <em>parties</em> qui sont envoyées sous forme de HTLC sur plusieurs chemins différents au destinataire prévu, en préservant <em>l&#8217;atomicité</em> du paiement global. Dans ce contexte, l&#8217;atomicité signifie que soit toutes les parties HTLC d&#8217;un paiement sont finalement exécutées, soit l&#8217;intégralité du paiement échoue et toutes les parties HTLC échouent. Il n&#8217;y a aucune possibilité d&#8217;un paiement partiellement réussi.</p>
</div>
<div class="paragraph data-line-371">
<p>Les paiements en plusieurs parties constituent une amélioration significative du Lightning Network, car ils permettent d&#8217;envoyer des montants qui ne "tiendraient" dans aucun canal en les divisant en montants plus petits pour lesquels il existe une liquidité suffisante. De plus, il a été démontré que les paiements en plusieurs parties augmentent la probabilité d&#8217;un paiement réussi, par rapport à un paiement à chemin unique.</p>
</div>
<div class="admonitionblock tip data-line-374">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-375">
<p>Maintenant que le MPP est disponible, il est préférable de considérer un paiement à chemin unique comme une sous-catégorie d&#8217;un MPP. Essentiellement, un chemin unique n&#8217;est qu&#8217;un multi-parties de taille un. Tous les paiements peuvent être considérés comme des paiements en plusieurs parties à moins que la taille du paiement et la liquidité disponible ne permettent de livrer en une seule partie.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-378">
<h4 id="_utiliser_mpp">Utiliser MPP</h4>
<div class="paragraph data-line-380">
<p>MPP n&#8217;est pas quelque chose qu&#8217;un utilisateur sélectionnera, mais plutôt une stratégie de pathfinding de nœud et de livraison de paiement. Les mêmes étapes de base sont implémentées : créer un graphe, sélectionner des chemins et la boucle d&#8217;essais-et-d&#8217;erreurs. La différence est que lors de la sélection du chemin, nous devons également considérer comment fractionner le paiement pour optimiser la livraison.</p>
</div>
<div class="paragraph data-line-382">
<p>Dans notre exemple, nous pouvons voir des améliorations immédiates à notre problème de pathfinding qui deviennent possibles avec MPP. Premièrement, nous pouvons utiliser le canal S&#8594;X qui a connu une liquidité insuffisante pour transporter 1 million de satoshis plus les frais. En envoyant une plus petite partie dans de ce canal, nous pouvons utiliser des chemins qui n&#8217;étaient pas disponibles auparavant. Deuxièmement, nous avons la liquidité inconnue du canal B&#8594;R, qui est insuffisante pour transporter le montant 1M, mais pourrait être suffisante pour transporter un montant plus petit.</p>
</div>
<div class="sect4 data-line-384">
<h5 id="_fractionnement_des_paiements">Fractionnement des paiements</h5>
<div class="paragraph data-line-386">
<p>La question fondamentale est de savoir comment répartir les paiements. Plus précisément, quels sont les nombres optimaux de fractionnements et les montants optimaux pour chaque fractionnement ?</p>
</div>
<div class="paragraph data-line-388">
<p>Il s&#8217;agit d&#8217;un domaine de recherche en cours où de nouvelles stratégies émergent. Les paiements en plusieurs parties conduisent à une approche algorithmique différente des paiements à chemin unique, même si des solutions à chemin unique peuvent émerger d&#8217;une optimisation en plusieurs parties (c&#8217;est-à-dire qu&#8217;un chemin unique peut être la solution optimale suggérée par un algorithme de pathfinding en plusieurs parties).</p>
</div>
<div class="paragraph data-line-390">
<p>Si vous vous souvenez, nous avons constaté que l&#8217;incertitude de la liquidité/des soldes conduit à certaines conclusions (quelque peu évidentes) que nous pouvons appliquer dans le pathfinding MPP, à savoir :</p>
</div>
<div class="ulist data-line-392">
<ul>
<li class="data-line-392">
<p>Les petits paiements ont plus de chance de réussir.</p>
</li>
<li class="data-line-394">
<p>Plus vous utilisez de canaux, plus les chances de succès diminuent (exponentiellement).</p>
</li>
</ul>
</div>
<div class="paragraph data-line-396">
<p>À partir de la première de ces idées, nous pourrions conclure que le fractionnement d&#8217;un paiement important (par exemple, 1 million de satoshis) en paiements minuscules augmente les chances que chacun de ces paiements plus petits réussisse. Le nombre de chemins possibles avec une liquidité suffisante sera plus grand si nous envoyons des montants plus petits.</p>
</div>
<div class="paragraph data-line-398">
<p>Pour pousser cette idée à l&#8217;extrême, pourquoi ne pas diviser le paiement de 1 million de satoshis en un million de parties distinctes d&#8217;un satoshi ? Eh bien, la réponse réside dans notre deuxième idée : puisque nous utiliserions plus de canaux/chemins pour envoyer notre million de HTLC mono-satoshi, nos chances de succès chuteraient de façon exponentielle.</p>
</div>
<div class="paragraph data-line-400">
<p>Si ce n&#8217;est pas évident, les deux aperçus précédents créent un "sweet spot" où nous pouvons maximiser nos chances de succès : fractionner en plus petits paiements mais pas trop de fractionnements !</p>
</div>
<div class="paragraph data-line-402">
<p>La quantification de cet équilibre optimal taille/nombre de divisions pour un graphe donné des canaux sort du cadre de ce livre, mais c&#8217;est un domaine de recherche actif. Certaines implémentations actuelles utilisent une stratégie très simple consistant à diviser le paiement en deux moitiés, quatre quarts, etc.</p>
</div>
<div class="admonitionblock note data-line-405">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-406">
<p>Pour en savoir plus sur le problème d&#8217;optimisation connu sous le nom de flot de coût minimum impliqués lors du fractionnement des paiements en différentes tailles et de leur affectation à des chemins, consultez l&#8217;article <a href="https://arxiv.org/abs/2107.05322" data-href="https://arxiv.org/abs/2107.05322">"Optimally Reliable &amp; Cheap Payment Flows on the Lightning Network"</a> par René Pickhardt (co-auteur de ce livre) et Stefan Richter.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-409">
<p>Dans notre exemple, le nœud de Selena tentera de diviser le paiement d'1M de satoshi en 2 parties de 600k et 400k satoshis, respectivement, et les enverra sur 2 chemins différents. Ceci est illustré dans <a href="#mpp_paths">Envoi de deux parties d&#8217;un paiement en plusieurs parties</a>.</p>
</div>
<div class="paragraph data-line-411">
<p>Parce que le canal S&#8594;X peut maintenant être utilisé et (heureusement pour Selena), le canal B&#8594; R a une liquidité suffisante pour 600 000 satoshis, les 2 parties réussissent sur des chemins qui n&#8217;étaient auparavant pas possibles.</p>
</div>
<div id="mpp_paths" class="imageblock data-line-415">
<div class="content">
<img src="images/mtln_1209.png" alt="mtln 1209">
</div>
<div class="title">Figure 9. Envoi de deux parties d&#8217;un paiement en plusieurs parties</div>
</div>
</div>
</div>
<div class="sect3 data-line-417">
<h4 id="_essais_et_erreurs_sur_plusieurs_tours">Essais-et-erreurs sur plusieurs "tours"</h4>
<div class="paragraph data-line-419">
<p>Les paiements en plusieurs parties entraînent une boucle d&#8217;essais-et-d&#8217;erreurs quelque peu modifiée pour la livraison des paiements. Étant donné que nous essayons plusieurs chemins à chaque tentative, nous avons quatre résultats possibles :</p>
</div>
<div class="ulist data-line-421">
<ul>
<li class="data-line-421">
<p>Toutes les parties réussissent, le paiement a réussi</p>
</li>
<li class="data-line-422">
<p>Certaines parties réussissent, d&#8217;autres échouent avec des erreurs renvoyées</p>
</li>
<li class="data-line-423">
<p>Toutes les pièces échouent avec des erreurs renvoyées</p>
</li>
<li class="data-line-424">
<p>Certaines parties sont "bloquées", aucune erreur n&#8217;est renvoyée</p>
</li>
</ul>
</div>
<div class="paragraph data-line-426">
<p>Dans le second cas, où certaines parties échouent avec des erreurs renvoyées et certaines parties réussissent, nous pouvons maintenant <em>répéter</em> la boucle d&#8217;essais-et-d&#8217;erreurs, mais <em>uniquement pour le montant résiduel</em>.</p>
</div>
<div class="paragraph data-line-428">
<p>Supposons par exemple que Selena ait un graphe des canaux beaucoup plus grand avec des centaines de chemins possibles pour atteindre Rashid. Son algorithme de pathfinding pourrait trouver une répartition optimale des paiements composée de 26 parties de tailles différentes. Après avoir tenté d&#8217;envoyer les 26 pièces au premier tour, 3 de ces pièces ont échoué avec des erreurs.</p>
</div>
<div class="paragraph data-line-430">
<p>Si ces 3 parties consistaient en, disons, 155 000 satoshis, alors Selena redémarrerait l&#8217;effort de pathfinding, uniquement pour 155 000 satoshis. Le prochain tour pourrait trouver des chemins complètement différents (optimisés pour le montant résiduel de 155 000) et diviser le montant de 155 000 en fragments complètement différents !</p>
</div>
<div class="admonitionblock tip data-line-433">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-434">
<p>Bien qu&#8217;il semble que 26 fragments représentent soit un nombre élevé, les tests sur le Lightning Network ont réussi à fournir un paiement de 0,3679 BTC en le divisant en 345 parties.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-437">
<p>De plus, le nœud de Selena mettrait à jour le graphe des canaux en utilisant les informations tirées des succès et des erreurs du premier tour pour trouver les chemins et les divisions les plus optimaux pour le second tour.</p>
</div>
<div class="paragraph data-line-439">
<p>Disons que le nœud de Selena calcule que la meilleure façon d&#8217;envoyer le reste des 155 000 est de 6 parties réparties en 80k, 42k, 15k, 11k, 6,5k et 500 satoshis. Au tour suivant, Selena n&#8217;obtient qu&#8217;une seule erreur, indiquant que la partie de 11k satoshis a échoué. Encore une fois, Selena met à jour le graphe des canaux en fonction des informations glanées et exécute à nouveau le pathfinding pour envoyer le reste des 11k. Cette fois, elle réussit avec 2 parties de de 6k et 5k satoshis, respectivement.</p>
</div>
<div class="paragraph data-line-441">
<p>Cet exemple multi-tours d&#8217;envoi d&#8217;un paiement à l&#8217;aide de MPP est illustré dans <a href="#mpp_rounds">Envoi d&#8217;un paiement en plusieurs tours avec MPP</a>.</p>
</div>
<div id="mpp_rounds" class="imageblock data-line-445">
<div class="content">
<img src="images/mtln_1210.png" alt="mtln 1210">
</div>
<div class="title">Figure 10. Envoi d&#8217;un paiement en plusieurs tours avec MPP</div>
</div>
<div class="paragraph data-line-447">
<p>En fin de compte, le nœud de Selena a utilisé 3 tours de pathfinding pour envoyer les 1M de satoshis en 30 parties.</p>
</div>
</div>
</div>
<div class="sect2 data-line-449">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph data-line-451">
<p>Dans ce chapitre, nous avons examiné le pathfinding et la livraison des paiements. Nous avons vu comment utiliser le graphe des canaux pour trouver des chemins d&#8217;un expéditeur à un destinataire. Nous avons également vu comment l&#8217;expéditeur tentera de livrer des paiements sur un chemin candidat et de répéter dans une boucle d&#8217;essais-et-d&#8217;erreurs.</p>
</div>
<div class="paragraph data-line-453">
<p>Nous avons également examiné l&#8217;incertitude de la liquidité du canal (du point de vue de l&#8217;expéditeur) et les implications que cela a pour le pathfinding. Nous avons vu comment quantifier l&#8217;incertitude et utiliser la théorie des probabilités pour tirer des conclusions utiles. Nous avons également vu comment nous pouvons réduire l&#8217;incertitude en apprenant des paiements réussis et échoués.</p>
</div>
<div class="paragraph data-line-455">
<p>Enfin, nous avons vu comment la fonctionnalité de paiements en plusieurs parties nouvellement déployée nous permet de diviser les paiements en plusieurs fragments, augmentant ainsi la probabilité de succès même pour les paiements plus importants.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-04-28 02:39:34 -0400
</div>
</div>
</body>
</html>