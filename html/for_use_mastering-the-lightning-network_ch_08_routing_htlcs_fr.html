<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Routage sur un réseau de canaux de paiement</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-2">
<h2 id="routing">Routage sur un réseau de <span class="keep-together">canaux de paiement</span></h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>Dans ce chapitre, nous détaillerons enfin comment les canaux de paiement peuvent être connectés pour former un réseau de canaux de paiement via un processus appelé <em>routage</em>. Plus précisément, nous nous intéresserons à la première partie de la couche de routage, le protocole de "Contrats multi-sauts atomiques et sans confiance". Il est mis en évidence avec contour épais dans la suite de protocoles illustrée dans <a href="#LN_protocol_routing_highlight">Routage de paiements atomiques dans la suite de protocoles Lightning</a>.</p>
</div>
<div id="LN_protocol_routing_highlight" class="imageblock data-line-8">
<div class="content">
<img src="images/mtln_0801.png" alt="Routage de paiements atomiques dans la suite de protocoles Lightning">
</div>
<div class="title">Figure 1. Routage de paiements atomiques dans la suite de protocoles Lightning</div>
</div>
<div class="sect2 data-line-10">
<h3 id="_routage_dun_paiement">Routage d&#8217;un paiement</h3>
<div class="paragraph data-line-12">
<p>Dans cette section, nous examinerons le routage du point de vue de Dina, une joueuse qui reçoit des dons de ses fans pendant qu&#8217;elle diffuse ses sessions de jeu.</p>
</div>
<div class="paragraph data-line-14">
<p>L&#8217;innovation des canaux de paiement routés permet à Dina de recevoir des pourboires sans maintenir un canal séparé avec chacun de ses fans qui veulent lui donner un pourboire.
Tant qu&#8217;il existe un chemin de canaux bien financées de ce téléspectateur à Dina, elle pourra recevoir un paiement de ce fan.</p>
</div>
<div class="paragraph data-line-17">
<p>Dans <a href="#dina_routing_diagram">Fans connectés (in)directement à Dina sur le Lightning Network</a> nous voyons une disposition de réseau possible créée par divers canaux de paiement entre les nœuds Lightning. Tout le monde dans ce diagramme peut envoyer un paiement à Dina en construisant un chemin. Imaginez que Fan 4 veuille envoyer un paiement à Dina. Voyez-vous le chemin qui pourrait permettre que cela se produise ? Fan 4 pourrait acheminer un paiement à Dina via Fan 3, Bob et Chan. De même, Alice pourrait acheminer un paiement à Dina via Bob et Chan.</p>
</div>
<div id="dina_routing_diagram" class="imageblock data-line-21">
<div class="content">
<img src="images/mtln_0802.png" alt="Fans connectés (in)directement à Dina sur le Lightning Network">
</div>
<div class="title">Figure 2. Fans connectés (in)directement à Dina sur le Lightning Network</div>
</div>
<div class="paragraph data-line-23">
<p>Les nœuds le long du chemin allant du fan à Dina sont des intermédiaires appelés <em>nœuds de routage</em> dans le cadre de l&#8217;acheminement d&#8217;un paiement. Il n&#8217;y a pas de différence fonctionnelle entre les nœuds de routage et les nœuds exploités par les fans de Dina. Tout nœud Lightning est capable d&#8217;acheminer les paiements sur ses canaux de paiement.</p>
</div>
<div class="paragraph data-line-25">
<p>Il est important de noter que les nœuds de routage ne sont pas en mesure de voler les fonds lors du routage d&#8217;un paiement d&#8217;un fan vers Dina.
De plus, les nœuds de routage ne peuvent pas perdre d&#8217;argent en participant au processus de routage.
Les nœuds de routage peuvent facturer des frais de routage pour agir en tant qu&#8217;intermédiaire, bien qu&#8217;ils n&#8217;y soient pas obligés et qu&#8217;ils puissent choisir d&#8217;acheminer les paiements gratuitement.</p>
</div>
<div class="paragraph data-line-29">
<p>Un autre détail important est qu&#8217;en raison de l&#8217;utilisation du routage en oignon, les nœuds intermédiaires ne sont explicitement conscients que du nœud qui les précède et du nœud qui les suit dans la route.
Ils ne sauront pas nécessairement qui est l&#8217;expéditeur et le destinataire du paiement.
Cela permet aux fans d&#8217;utiliser des nœuds intermédiaires pour payer Dina, sans divulguer d&#8217;informations privées et sans risquer de vol.</p>
</div>
<div class="paragraph data-line-33">
<p>Ce processus de connexion d&#8217;une série de canaux de paiement avec une sécurité de bout en bout, et la structure d&#8217;incitation pour les nœuds de <em>transférer</em> les paiements, est l&#8217;une des principales innovations du Lightning Network.</p>
</div>
<div class="paragraph data-line-35">
<p>Dans ce chapitre, nous allons plonger dans le mécanisme de routage sur le Lightning Network, en détaillant la manière précise dont les paiements transitent par le réseau. Tout d&#8217;abord, nous allons clarifier le concept de routage et le comparer à celui de pathfinding, car ceux-ci sont souvent confondus et utilisés de manière interchangeable. Ensuite, nous allons construire un protocole d&#8217;équité : un protocole atomique, sans confiance et multi-sauts utilisé pour acheminer les paiements. Pour démontrer le fonctionnement de ce protocole d&#8217;équité, nous utiliserons un équivalent physique du transfert de pièces d&#8217;or entre quatre personnes. Enfin, nous examinerons l&#8217;implémentation du protocole atomique, sans confiance et multi-sauts actuellement utilisé sur le Lightning Network qui est appelé contrat Hash Time-Locked (HTLC).</p>
</div>
</div>
<div class="sect2 data-line-37">
<h3 id="_routage_versus_pathfinding">Routage versus Pathfinding</h3>
<div class="paragraph data-line-39">
<p>Il est important de noter que nous séparons le concept de <em>routage</em> du concept de <em>pathfinding</em>. Ces deux concepts sont souvent confondus, et le terme <em>routage</em> est souvent utilisé pour décrire les deux concepts. Levons l&#8217;ambiguïté avant d&#8217;aller plus loin.</p>
</div>
<div class="paragraph data-line-41">
<p>Le pathfinding, qui est couvert dans <a href="#path_finding">[path_finding]</a>, est le processus de recherche et de choix d&#8217;un chemin contigu composé de canaux de paiement qui relient l&#8217;expéditeur A au destinataire B. L&#8217;expéditeur d&#8217;un paiement effectue le pathfinding en examinant le <em>graphe des canaux</em> qu&#8217;il a assemblé à partir des annonces de canaux colportées par d&#8217;autres nœuds.</p>
</div>
<div class="paragraph data-line-43">
<p>Le routage fait référence à la série d&#8217;interactions à travers le réseau qui tentent de transférer un paiement d&#8217;un point A à un autre point B, à travers le chemin précédemment sélectionné par pathfinding. Le routage est le processus actif d&#8217;envoi d&#8217;un paiement sur un chemin, qui implique la coopération de tous les nœuds intermédiaires le long de ce chemin.</p>
</div>
<div class="paragraph data-line-45">
<p>Une règle empirique importante est qu&#8217;il est possible qu&#8217;un <em>chemin</em> existe entre Alice et Bob (peut-être même plus d&#8217;un), et toutefois il se peut qu&#8217;il n&#8217;y ait pas de <em>route</em> active sur laquelle envoyer le paiement. Un exemple est le scénario dans lequel tous les nœuds reliant Alice et Bob sont actuellement hors ligne. Dans cet exemple, on peut examiner le graphe des canaux et connecter une série de canaux de paiement d&#8217;Alice à Bob, donc un <em>chemin</em> existe. Cependant, comme les nœuds intermédiaires sont hors ligne, le paiement ne peut pas être envoyé et il n&#8217;existe donc pas de <em>route</em>.</p>
</div>
</div>
<div class="sect2 data-line-47">
<h3 id="_création_dun_réseau_de_canaux_de_paiement">Création d&#8217;un réseau de canaux de paiement</h3>
<div class="paragraph data-line-49">
<p>Avant de nous plonger dans le concept d&#8217;un paiement multi-saut atomique sans confiance, examinons un exemple.
Revenons à Alice qui, dans les chapitres précédents, a acheté un café à Bob avec qui elle a un canal ouvert.
Maintenant, Alice regarde une diffusion en direct de Dina, la joueuse, et souhaite envoyer à Dina un pourboire de 50 000 satoshis via le Lightning Network. Mais Alice n&#8217;a pas de canal direct avec Dina. Que peut faire Alice ?</p>
</div>
<div class="paragraph data-line-53">
<p>Alice pourrait ouvrir un canal direct avec Dina, cependant, cela nécessiterait des liquidités et des frais sur la chaîne qui pourraient être supérieurs à la valeur du pourboire lui-même. Au lieu de cela, Alice peut utiliser ses canaux ouverts existants pour envoyer un pourboire à Dina <em>sans</em> avoir besoin d&#8217;ouvrir un canal directement avec Dina. Ceci est possible, tant qu&#8217;il existe un chemin de canaux d&#8217;Alice à Dina avec une capacité suffisante pour acheminer le pourboire.</p>
</div>
<div class="paragraph data-line-55">
<p>Comme vous pouvez le voir dans <a href="#routing_network">Un réseau de canaux de paiement entre Alice et Dina</a>, Alice a un canal ouvert avec Bob, le propriétaire du café. Bob, à son tour, a un canal ouvert avec le développeur de logiciels Chan qui l&#8217;aide avec le système de point de vente qu&#8217;il utilise dans son café. Chan est également propriétaire d&#8217;une grande société de logiciels qui développe le jeu auquel Dina joue, et ils ont déjà un canal ouvert que Dina utilise pour payer la licence du jeu et les éléments du jeu.</p>
</div>
<div id="routing_network" class="imageblock data-line-59">
<div class="content">
<img src="images/mtln_0803.png" alt="Un réseau de canaux de paiement entre Alice et Dina">
</div>
<div class="title">Figure 3. Un réseau de canaux de paiement entre Alice et Dina</div>
</div>
<div class="paragraph data-line-61">
<p>Il est possible de tracer un <em>chemin</em> d&#8217;Alice à Dina qui utilise Bob et Chan comme nœuds de routage intermédiaires.
Alice peut alors créer une <em>route</em> à partir de ce chemin décrit et l&#8217;utiliser pour envoyer un pourboire de quelques milliers de satoshis à Dina, le paiement étant <em>transféré</em> par Bob et Chan.
Essentiellement, Alice paiera Bob, qui paiera Chan, qui paiera Dina. Aucun canal direct d&#8217;Alice à Dina n&#8217;est requis.</p>
</div>
<div class="paragraph data-line-65">
<p>Le principal défi est de faire cela d&#8217;une manière qui empêche Bob et Chan de voler l&#8217;argent qu&#8217;Alice veut livrer à Dina.</p>
</div>
</div>
<div class="sect2 data-line-67">
<h3 id="_un_exemple_physique_de_routage">Un exemple physique de "routage"</h3>
<div class="paragraph data-line-69">
<p>Pour comprendre comment le Lightning Network protège le paiement lors de son acheminement, nous pouvons le comparer à un exemple d&#8217;acheminement de paiements physiques avec des pièces d&#8217;or dans le monde réel.</p>
</div>
<div class="paragraph data-line-71">
<p>Supposons qu&#8217;Alice veut donner 10 pièces d&#8217;or à Dina, mais n&#8217;ait pas un accès direct à Dina. Cependant, Alice connaît Bob, qui connaît Chan, qui connaît Dina, alors elle décide de demander de l&#8217;aide à Bob et Chan. Ceci est illustré dans <a href="#alice_dina_routing_1">Alice veut payer 10 pièces d&#8217;or à Dina</a>.</p>
</div>
<div id="alice_dina_routing_1" class="imageblock data-line-75">
<div class="content">
<img src="images/mtln_0804.png" alt="mtln 0804">
</div>
<div class="title">Figure 4. Alice veut payer 10 pièces d&#8217;or à Dina</div>
</div>
<div class="paragraph data-line-77">
<p>Alice peut payer Bob pour payer Chan pour payer Dina, mais comment s&#8217;assure-t-elle que Bob ou Chan ne s&#8217;enfuient pas avec les pièces après les avoir reçues ?
Dans le monde physique, les contrats pourraient être utilisés pour effectuer en toute sécurité une série de paiements.</p>
</div>
<div class="paragraph data-line-80">
<p>Alice pourrait négocier un contrat avec Bob, qui se lit comme suit :</p>
</div>
<div class="quoteblock data-line-82">
<blockquote>
<div class="paragraph data-line-83">
<p><em>Moi, Alice, je te donnerai, Bob, 10 pièces d&#8217;or si tu les donnes à Chan.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-86">
<p>Bien que ce contrat soit agréable dans l&#8217;abstrait, dans le monde réel, Alice court le risque que Bob puisse rompre le contrat en espérant ne pas se faire prendre.
Même si Bob est arrêté et poursuivi, Alice risque de faire faillite et de ne pas pouvoir récupérer ses 10 pièces d&#8217;or.
En supposant que ces problèmes soient résolus comme par magie, on ne sait toujours pas comment tirer parti d&#8217;un tel contrat pour atteindre le résultat souhaité : faire livrer les pièces à Dina.</p>
</div>
<div class="paragraph data-line-90">
<p>Améliorons notre contrat pour intégrer ces considérations :</p>
</div>
<div class="quoteblock data-line-92">
<blockquote>
<div class="paragraph data-line-93">
<p><em>Moi, Alice, je vous rembourserai, Bob, 10 pièces d&#8217;or si vous pouvez me prouver (par exemple, via un reçu) que vous avez livré 10 pièces d&#8217;or à Chan.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-96">
<p>Vous vous demandez peut-être pourquoi Bob signerait-il un tel contrat.
Il doit payer Chan mais n&#8217;obtient finalement rien de l&#8217;échange, et il court le risque qu&#8217;Alice ne le rembourse pas. Bob pourrait offrir à Chan un contrat similaire pour payer Dina, mais de même, Chan n&#8217;a aucune raison de l&#8217;accepter non plus.</p>
</div>
<div class="paragraph data-line-99">
<p>Même en mettant de côté le risque, Bob et Chan doivent <em>déjà</em> avoir 10 pièces d&#8217;or à envoyer ; sinon, ils ne pourraient pas prendre part au contrat.</p>
</div>
<div class="paragraph data-line-101">
<p>Ainsi, Bob et Chan font face à la fois au risque et au coût d&#8217;opportunité pour accepter ce contrat, ils devraient donc être indemnisés pour les accepter.</p>
</div>
<div class="paragraph data-line-103">
<p>Alice peut alors rendre cette solution attrayante pour Bob et Chan en leur offrant une commission d&#8217;une pièce d&#8217;or chacun, s&#8217;ils transmettent son paiement à Dina.</p>
</div>
<div class="paragraph data-line-105">
<p>Le contrat se lirait ainsi :</p>
</div>
<div class="quoteblock data-line-107">
<blockquote>
<div class="paragraph data-line-108">
<p><em>Moi, Alice, je vous rembourserai, Bob, 12 pièces d&#8217;or si vous pouvez me prouver (par exemple, via un reçu) que vous avez livré 11 pièces d&#8217;or à Chan.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-111">
<p>Alice promet maintenant à Bob 12 pièces d&#8217;or. Il y en a 10 à livrer à Dina et 2 pour les frais (commission). Elle en promet 12 à Bob s&#8217;il peut prouver qu&#8217;il en a transmis 11 à Chan.
La différence d&#8217;une pièce d&#8217;or est la commission que Bob gagnera pour son aide avec ce paiement particulier. Dans <a href="#alice_dina_routing_2">Alice paie Bob, Bob paie Chan, Chan paie Dina</a> nous voyons comment cet arrangement permettrait d&#8217;apporter 10 pièces d&#8217;or à Dina via Bob et Chan.</p>
</div>
<div id="alice_dina_routing_2" class="imageblock data-line-116">
<div class="content">
<img src="images/mtln_0805.png" alt="mtln 0805">
</div>
<div class="title">Figure 5. Alice paie Bob, Bob paie Chan, Chan paie Dina</div>
</div>
<div class="paragraph data-line-118">
<p>Parce qu&#8217;il y a toujours la question de la confiance et le risque qu&#8217;Alice ou Bob n&#8217;honorent pas le contrat, toutes les parties décident d&#8217;utiliser un service d&#8217;entiercement ("escrow" en anglais).
Au début de l&#8217;échange, Alice pourrait "verrouiller" ces 12 pièces d&#8217;or auprès d&#8217;un service d&#8217;entiercement qui paiera Bob qu&#8217;une fois qu&#8217;il aura prouvé qu&#8217;il a payé 11 pièces d&#8217;or à Chan.</p>
</div>
<div class="paragraph data-line-121">
<p>Ce service d&#8217;entiercement est un service idéalisé, qui n&#8217;introduit pas d&#8217;autres risques (par exemple, le risque de contrepartie). Plus tard, nous verrons comment nous pouvons remplacer le compte séquestre par un contrat intelligent Bitcoin. Supposons pour l&#8217;instant que tout le monde fait confiance à ce service d&#8217;entiercement.</p>
</div>
<div class="paragraph data-line-123">
<p>Dans le Lightning Network, le reçu (preuve de paiement) pourrait prendre la forme d&#8217;un secret que seule Dina connaît.
En pratique, ce secret serait un nombre aléatoire suffisamment grand pour empêcher les autres de le deviner (généralement un <em>très, très</em> grand nombre, codé sur 256 bits !).</p>
</div>
<div class="paragraph data-line-126">
<p>Dina génère cette valeur secrète R à partir d&#8217;un générateur de nombres aléatoires.</p>
</div>
<div class="paragraph data-line-128">
<p>Le secret pourrait alors être engagé dans le contrat en incluant le hachage SHA-256 du secret dans le contrat lui-même, comme suit :</p>
</div>
<ul class="simplelist">
<li><em>H</em> = SHA-256(<em>R</em>)</li>
</ul>
<div class="paragraph data-line-136">
<p>Nous appelons ce hachage du secret de paiement le <em>hachage de paiement</em>.
Le secret qui "déverrouille" le paiement s&#8217;appelle le <em>secret de paiement</em>.</p>
</div>
<div class="paragraph data-line-139">
<p>Pour l&#8217;instant, nous gardons les choses simples et supposons que le secret de Dina est simplement la ligne de texte : <code>Dinas secret</code>. Ce message secret est appelé <em>secret de paiement</em> ou <em>préimage de paiement</em>.</p>
</div>
<div class="paragraph data-line-141">
<p>Pour "s&#8217;engager" avec ce secret, Dina calcule le hachage SHA-256, qui, lorsqu&#8217;il est encodé en hexadécimal, peut être illustré comme suit :</p>
</div>
<div class="listingblock data-line-143">
<div class="content">
<pre>0575965b3b44be51e8057d551c4016d83cb1fba9ea8d6e986447ba33fe69f6b3</pre>
</div>
</div>
<div class="paragraph data-line-147">
<p>Pour faciliter le paiement d&#8217;Alice, Dina créera le secret de paiement et le hachage de paiement, et enverra le hachage de paiement à Alice. Dans <a href="#alice_dina_routing_3">Dina envoie le secret haché à Alice</a> nous voyons que Dina envoie le hachage de paiement à Alice via un canal externe (ligne pointillée), comme un e-mail ou un SMS.</p>
</div>
<div id="alice_dina_routing_3" class="imageblock data-line-151">
<div class="content">
<img src="images/mtln_0806.png" alt="Dina envoie le secret haché à Alice">
</div>
<div class="title">Figure 6. Dina envoie le secret haché à Alice</div>
</div>
<div class="paragraph data-line-153">
<p>Alice ne connaît pas le secret, mais elle peut réécrire son contrat pour utiliser le hachage du secret comme preuve de paiement :</p>
</div>
<div class="quoteblock data-line-155">
<blockquote>
<div class="paragraph data-line-156">
<p><em>Moi, Alice, je vous rembourserai, Bob, avec 12 pièces d&#8217;or si vous pouvez me montrer un message valide qui a comme hachage : <code>057596</code>&#8230;&#8203;.
Vous pouvez acquérir ce message en établissant un contrat similaire avec Chan qui doit établir un contrat similaire avec Dina.
Pour vous assurer que vous serez remboursé, je fournirai les 12 pièces d&#8217;or à un service d&#8217;entiercement de confiance avant la mise en place de votre prochain contrat.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-161">
<p>Ce nouveau contrat protège désormais Alice contre la non-transmission de Bob à Chan, protège Bob contre le non-remboursement d&#8217;Alice et garantit qu&#8217;il y aura une preuve que Dina a finalement été payée via le hachage du secret de Dina.</p>
</div>
<div class="paragraph data-line-163">
<p>Une fois que Bob et Alice ont accepté le contrat et que Bob a reçu le message de l&#8217;agent d&#8217;entiercement indiquant qu&#8217;Alice a déposé les 12 pièces d&#8217;or, Bob peut maintenant négocier un contrat similaire avec Chan.</p>
</div>
<div class="paragraph data-line-165">
<p>Notez que puisque Bob prend des frais de service de 1 pièce, il n&#8217;enverra que 11 pièces d&#8217;or à Chan une fois que Chan montrera la preuve qu&#8217;il a payé Dina.
De même, Chan exigera également des frais et s&#8217;attendra à recevoir 11 pièces d&#8217;or une fois qu&#8217;il aura prouvé qu&#8217;il a payé à Dina les 10 pièces d&#8217;or promises.</p>
</div>
<div class="paragraph data-line-168">
<p>Le contrat de Bob avec Chan sera libellé comme suit :</p>
</div>
<div class="quoteblock data-line-170">
<blockquote>
<div class="paragraph data-line-171">
<p><em>Moi, Bob, je vous rembourserai, Chan, avec 11 pièces d&#8217;or si vous pouvez me montrer un message valide qui a comme hachage : <code>057596</code>&#8230;&#8203;.
Vous pouvez acquérir ce message en établissant un contrat similaire avec Dina.
Pour vous assurer que vous serez remboursé, je fournirai les 11 pièces d&#8217;or à un agent d&#8217;entiercement de confiance avant la mise en place de votre prochain contrat.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-176">
<p>Lorsque Chan reçoit le message de l&#8217;agent d&#8217;entiercement indiquant que Bob a déposé les 11 pièces d&#8217;or, Chan établit un contrat similaire avec Dina :</p>
</div>
<div class="quoteblock data-line-178">
<blockquote>
<div class="paragraph data-line-179">
<p><em>Moi, Chan, je vous rembourserai, Dina, avec 10 pièces d&#8217;or si vous pouvez me montrer un message valide qui a comme hachage : <code>057596</code>&#8230;&#8203;.
Pour vous assurer que vous serez remboursé après avoir révélé le secret, je fournirai les 10 pièces d&#8217;or à un agent d&#8217;entiercement de confiance.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-183">
<p>Tout est maintenant en place.
Alice a un contrat avec Bob et a placé 12 pièces d&#8217;or dans un service d&#8217;entiercement.
Bob a un contrat avec Chan et a placé 11 pièces d&#8217;or dans un service d&#8217;entiercement.
Chan a un contrat avec Dina et a placé 10 pièces d&#8217;or dans un service d&#8217;entiercement.
C&#8217;est maintenant à Dina de révéler le secret, qui est la préimage pour le hachage qu&#8217;elle a établi comme preuve de paiement.</p>
</div>
<div class="paragraph data-line-189">
<p>Dina envoie maintenant Dinas secret à Chan.</p>
</div>
<div class="paragraph data-line-191">
<p>Chan vérifie que Dinas secret correspond au hachage 057596&#8230;&#8203;. Chan a maintenant une preuve de paiement et demande donc au service d&#8217;entiercement de remettre les 10 pièces d&#8217;or à Dina.</p>
</div>
<div class="paragraph data-line-193">
<p>Chan fournit maintenant le secret à Bob. Bob le vérifie et demande au service d&#8217;entiercement de remettre les 11 pièces d&#8217;or à Chan.</p>
</div>
<div class="paragraph data-line-195">
<p>Bob fournit maintenant le secret à Alice.
Alice le vérifie et ordonne au service d&#8217;entiercement de remettre 12 pièces d&#8217;or à Bob.</p>
</div>
<div class="paragraph data-line-198">
<p>Tous les contrats sont maintenant réglés.
Alice a payé un total de 12 pièces d&#8217;or, dont 1 a été reçue par Bob, 1 par Chan et 10 par Dina.
Avec une chaîne de contrats comme celle-ci en place, Bob et Chan ne pouvaient pas s&#8217;enfuir avec l&#8217;argent car ils l&#8217;avaient d&#8217;abord déposé auprès d&#8217;un service d&#8217;entiercement.</p>
</div>
<div class="paragraph data-line-202">
<p>Cependant, un problème demeure.
Si Dina refusait de divulguer sa préimage secrète, alors Chan, Bob et Alice auraient tous leurs pièces sous séquestre mais ne seraient pas remboursés.
Et de même, si quelqu&#8217;un d&#8217;autre le long de la chaîne ne transmettait pas le secret, la même chose se produirait.
Ainsi, bien que personne ne puisse voler de l&#8217;argent à Alice, tout le monde aurait toujours son argent bloqué de manière permanente.</p>
</div>
<div class="paragraph data-line-207">
<p>Heureusement, cela peut être résolu en ajoutant une date limite au contrat.</p>
</div>
<div class="paragraph data-line-209">
<p>Nous pourrions modifier le contrat de sorte que s&#8217;il n&#8217;est pas réalisé dans un certain délai, le contrat expire et le service d&#8217;entiercement rend l&#8217;argent à la personne qui a effectué le dépôt initial.
Nous appelons ce délai un <em>timelock</em>.</p>
</div>
<div class="paragraph data-line-212">
<p>Le dépôt est verrouillé avec le service d&#8217;entiercement pendant un certain temps et est finalement libéré même si aucune preuve de paiement n&#8217;a été fournie.</p>
</div>
<div class="paragraph data-line-214">
<p>Pour tenir compte de cela, le contrat entre Alice et Bob est à nouveau modifié avec une nouvelle clause :</p>
</div>
<div class="quoteblock data-line-216">
<blockquote>
<div class="paragraph data-line-217">
<p><em>Bob a 24 heures pour présenter le secret après la signature du contrat.
Si Bob ne fournit pas le secret à ce moment-là, le dépôt d&#8217;Alice sera remboursé par le service d&#8217;entiercement et le contrat devient invalide.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-221">
<p>Bob, bien sûr, doit maintenant s&#8217;assurer qu&#8217;il reçoit la preuve de paiement dans les 24 heures.
Même s&#8217;il réussit à payer Chan, s&#8217;il reçoit la preuve de paiement après plus de 24 heures, il ne sera pas remboursé. Pour éliminer ce risque, Bob doit donner à Chan un délai encore plus court.</p>
</div>
<div class="paragraph data-line-224">
<p>À son tour, Bob modifiera son contrat avec Chan comme suit :</p>
</div>
<div class="quoteblock data-line-226">
<blockquote>
<div class="paragraph data-line-227">
<p><em>Chan a 22 heures pour présenter le secret après la signature du contrat.
S&#8217;il ne fournit pas le secret à ce moment-là, le dépôt de Bob sera remboursé par le service d&#8217;entiercement et le contrat devient invalide.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-231">
<p>Comme vous l&#8217;avez peut-être deviné, Chan modifiera également son contrat avec Dina :</p>
</div>
<div class="quoteblock data-line-233">
<blockquote>
<div class="paragraph data-line-234">
<p><em>Dina a 20 heures pour présenter le secret après la signature du contrat.
Si elle ne fournit pas le secret à ce moment-là, le dépôt de Chan sera remboursé par le service d&#8217;entiercement et le contrat devient invalide.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-238">
<p>Avec une telle chaîne de contrats, nous pouvons nous assurer qu&#8217;après 24 heures, le paiement passera avec succès d&#8217;Alice à Bob, à Chan et à Dina, ou il échouera et tout le monde sera remboursé.
Soit le contrat échoue, soit il réussit, il n&#8217;y a pas de juste milieu.</p>
</div>
<div class="paragraph data-line-241">
<p>Dans le contexte du Lightning Network, nous appelons cette propriété "tout ou rien" <em>l&#8217;atomicité</em>.</p>
</div>
<div class="paragraph data-line-243">
<p>Tant que le séquestre est digne de confiance et remplit fidèlement son devoir, aucune partie ne se verra voler ses pièces au cours du processus.</p>
</div>
<div class="paragraph data-line-245">
<p>La condition préalable au fonctionnement de cette <em>route</em> est que toutes les parties du chemin aient suffisamment d&#8217;argent pour satisfaire la série de dépôts requise.</p>
</div>
<div class="paragraph data-line-247">
<p>Bien que cela semble être un détail mineur, nous verrons plus loin dans ce chapitre que cette exigence est en fait l&#8217;un des problèmes les plus difficiles pour les nœuds LN.
Cela devient de plus en plus difficile au fur et à mesure que le montant du paiement augmente.
De plus, les parties ne peuvent pas utiliser leur argent tant qu&#8217;il est verrouillé auprès du service d&#8217;entiercement.</p>
</div>
<div class="paragraph data-line-251">
<p>Ainsi, les utilisateurs transférant des paiements font face à un coût d&#8217;opportunité pour verrouiller de l&#8217;argent, qui est finalement remboursé par des frais de routage, comme nous l&#8217;avons vu dans l&#8217;exemple précédent.</p>
</div>
<div class="paragraph data-line-253">
<p>Maintenant que nous avons vu un exemple de routage de paiement physique, nous verrons comment cela peut être implémenté sur la blockchain Bitcoin, sans avoir besoin d&#8217;un tiers de confiance. Pour ce faire, nous établirons les contrats entre les participants à l&#8217;aide de Bitcoin Script. Nous remplaçons le service d&#8217;entiercement par des <em>contrats intelligents</em> qui implémentent un protocole d&#8217;équité. Décomposons ce concept et implémentons-le !</p>
</div>
</div>
<div class="sect2 data-line-255">
<h3 id="_protocole_déquité">Protocole d&#8217;équité</h3>
<div class="paragraph data-line-257">
<p>Comme nous l&#8217;avons vu dans le premier chapitre de ce livre, l&#8217;innovation de Bitcoin est la possibilité d&#8217;utiliser les primitives de cryptographie pour implémenter un protocole d&#8217;équité qui remplace la confiance entre des tiers (intermédiaires) avec un protocole de confiance.</p>
</div>
<div class="paragraph data-line-259">
<p>Dans notre exemple de pièces d&#8217;or, nous avions besoin d&#8217;un service d&#8217;entiercement pour empêcher l&#8217;une des parties de manquer à ses obligations. L&#8217;innovation des protocoles d&#8217;équité cryptographiques nous permet de remplacer le service d&#8217;entiercement par un protocole.</p>
</div>
<div class="paragraph data-line-261">
<p>Les propriétés du protocole d&#8217;équité que nous souhaitons créer sont :</p>
</div>
<div class="dlist data-line-263">
<dl>
<dt class="hdlist1">Fonctionnement sans confiance</dt>
<dd>
<p>Les participants à un paiement routé n&#8217;ont pas besoin de se faire confiance, ni à aucun intermédiaire ou tiers. Au lieu de cela, ils font confiance au protocole pour les protéger de la tricherie.</p>
</dd>
<dt class="hdlist1">Atomicité</dt>
<dd>
<p>Soit le paiement est entièrement exécuté, soit il échoue et tout le monde est remboursé. Il n&#8217;y a aucune possibilité qu&#8217;un intermédiaire collecte un paiement acheminé et ne le transmette pas au saut suivant. Ainsi, les intermédiaires ne peuvent pas tricher ou voler.</p>
</dd>
<dt class="hdlist1">Multi-sauts</dt>
<dd>
<p>La sécurité du système s&#8217;étend de bout en bout pour les paiements acheminés via plusieurs canaux de paiement, tout comme elle l&#8217;est pour un paiement entre les deux extrémités d&#8217;un unique canal de paiement.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-269">
<p>Une propriété supplémentaire facultative est la possibilité de diviser les paiements en plusieurs parties tout en conservant l&#8217;atomicité pour l&#8217;ensemble du paiement. Ceux-ci sont appelés <em>paiements en plusieurs parties</em> ("multipart payments" ou "<em>MPP</em>" en anglais) et sont explorés plus en détail dans <a href="#mpp">[mpp]</a>.</p>
</div>
<div class="sect3 data-line-271">
<h4 id="_implémentation_de_paiements_multi_sauts_atomiques_sans_confiance">Implémentation de paiements multi-sauts atomiques sans confiance</h4>
<div class="paragraph data-line-273">
<p>Bitcoin Script est suffisamment flexible pour qu&#8217;il existe des dizaines de façons de mettre en œuvre un protocole d&#8217;équité qui a les propriétés d&#8217;atomicité, de fonctionnement sans confiance et de sécurité des multi-sauts. Le choix d&#8217;une implémentation spécifique dépend de certains compromis à faire entre la confidentialité, l&#8217;efficacité et la complexité.</p>
</div>
<div class="paragraph data-line-275">
<p>Le protocole d&#8217;équité pour le routage utilisé sur le Lightning Network aujourd&#8217;hui est appelé un contrat Hash Time-Locked (HTLC). Les HTLC utilisent une préimage de hachage comme secret qui déverrouille un paiement, comme nous l&#8217;avons vu dans l&#8217;exemple des pièces d&#8217;or dans ce chapitre. Le destinataire d&#8217;un paiement génère un nombre secret aléatoire et calcule son hachage. Le hachage devient la condition de paiement, et une fois le secret révélé, tous les participants peuvent réclamer leurs paiements entrants. Les HTLC offrent l&#8217;atomicité, un fonctionnement sans confiance et une sécurité des multi-sauts.</p>
</div>
<div class="paragraph data-line-277">
<p>Un autre mécanisme proposé pour la mise en œuvre du routage est un contrat <em>Point Time-Locked</em> (<em>PTLC</em>). Les PTLC permettent également d&#8217;atteindre l&#8217;atomicité, le fonctionnement sans confiance et la sécurité des multi-sauts, mais le font avec une efficacité accrue et une meilleure confidentialité. La mise en œuvre efficace des PTLC dépend d&#8217;un nouvel algorithme de signature numérique appelé <em>Schnorr signatures</em>, qui devrait être activé dans Bitcoin en 2021.</p>
</div>
</div>
</div>
<div class="sect2 data-line-279">
<h3 id="_revisiter_lexemple_du_pourboire">Revisiter l&#8217;exemple du pourboire</h3>
<div class="paragraph data-line-281">
<p>Reprenons notre exemple de la première partie de ce chapitre. Alice veut donner un pourboire à Dina avec un paiement Lightning. Disons qu&#8217;Alice veut envoyer 50 000 satoshis à Dina comme pourboire.</p>
</div>
<div class="paragraph data-line-283">
<p>Pour qu&#8217;Alice paie Dina, Alice aura besoin du nœud de Dina pour générer une facture Lightning. Nous en discuterons plus en détail dans <a href="#invoices">[invoices]</a>. Pour l&#8217;instant, supposons que Dina dispose d&#8217;un site Web capable de produire une facture Lightning pour les pourboires.</p>
</div>
<div class="admonitionblock tip data-line-286">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-287">
<p>Les paiements Lightning peuvent être envoyés sans facture à l&#8217;aide d&#8217;une fonctionnalité appelée <em>keysend</em>, dont nous discuterons plus en détail dans <a href="#keysend">[keysend]</a>. Pour l&#8217;instant, nous expliquerons le flux de paiement plus simple à l&#8217;aide d&#8217;une facture.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-290">
<p>Alice visite le site de Dina, saisit le montant de 50 000 satoshis dans un formulaire et, en réponse, le nœud Lightning de Dina génère une demande de paiement de 50 000 satoshis sous la forme d&#8217;une facture Lightning. Cette interaction a lieu sur le Web et en dehors du Lightning Network, comme indiqué dans <a href="#alice_dina_invoice_1">Alice demande une facture sur le site de Dina</a>.</p>
</div>
<div id="alice_dina_invoice_1" class="imageblock data-line-294">
<div class="content">
<img src="images/mtln_0807.png" alt="Alice demande une facture sur le site de Dina">
</div>
<div class="title">Figure 7. Alice demande une facture sur le site de Dina</div>
</div>
<div class="paragraph data-line-296">
<p>Comme nous l&#8217;avons vu dans les exemples précédents, nous supposons qu&#8217;Alice n&#8217;a pas de canal de paiement direct vers Dina. Au lieu de cela, Alice a un canal vers Bob, Bob a un canal vers Chan et Chan a un canal vers Dina. Pour payer Dina, Alice doit trouver un chemin qui la relie à Dina. Nous discuterons de cette étape plus en détail dans <a href="#path_finding">[path_finding]</a>. Pour l&#8217;instant, supposons qu&#8217;Alice est capable de recueillir des informations sur les canaux disponibles et voit qu&#8217;il existe un chemin d&#8217;elle à Dina, via Bob et Chan.</p>
</div>
<div class="admonitionblock note data-line-299">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-300">
<p>Vous rappelez-vous comment Bob et Chan pourraient s&#8217;attendre à une petite compensation pour acheminer le paiement via leurs nœuds ? Alice veut payer 50 000 satoshis à Dina, mais comme vous le verrez dans les sections suivantes, elle enverra 50 200 satoshis à Bob. Les 200 satoshis supplémentaires paieront à Bob et Chan, 100 satoshis chacun, comme frais de routage.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-303">
<p>Maintenant, le nœud d&#8217;Alice peut construire un paiement Lightning. Dans les prochaines sections, nous verrons comment le nœud d&#8217;Alice construit un HTLC pour payer Dina et comment ce HTLC est transmis le long du chemin d&#8217;Alice vers Dina.</p>
</div>
<div class="sect3 data-line-306">
<h4 id="_règlement_sur_la_chaîne_versus_règlement_hors_chaîne_des_htlc">Règlement sur la chaîne versus Règlement hors chaîne des HTLC</h4>
<div class="paragraph data-line-308">
<p>L&#8217;objectif du Lightning Network est de permettre des transactions <em>hors chaîne</em> auxquelles on peut faire confiance de la même manière que les transactions sur la chaîne parce que personne ne peut tricher. La raison pour laquelle personne ne peut tricher est qu&#8217;à tout moment, n&#8217;importe quel participant peut transférer ses transactions hors chaîne sur la chaîne. Chaque transaction hors chaîne est prête à être soumise à la blockchain Bitcoin à tout moment. Ainsi, la blockchain Bitcoin fait office de mécanisme de résolution des litiges et de règlement final si nécessaire.</p>
</div>
<div class="paragraph data-line-310">
<p>Le simple fait que toute transaction puisse être transféré sur la chaîne à tout moment est précisément la raison pour laquelle toutes ces transactions peuvent être conservées hors chaîne. Si vous savez que vous avez un recours, vous pouvez continuer à coopérer avec les autres participants et éviter le besoin d&#8217;un règlement sur la chaîne et de frais supplémentaires.</p>
</div>
<div class="paragraph data-line-312">
<p>Dans tous les exemples qui suivent, nous supposerons que chacune de ces transactions peut être effectuée sur la chaîne à tout moment. Les participants choisiront de les garder hors chaîne, mais il n&#8217;y a aucune différence dans la fonctionnalité du système autre que les frais plus élevés et les délais imposés par le minage des transactions sur la chaîne. L&#8217;exemple fonctionne de la même manière si toutes les transactions sont sur la chaîne ou hors chaîne.</p>
</div>
</div>
</div>
<div class="sect2 data-line-315">
<h3 id="htlcs">Contrats Hash Time-Locked</h3>
<div class="paragraph data-line-317">
<p>Dans cette section, nous expliquons le fonctionnement des HTLC.</p>
</div>
<div class="paragraph data-line-319">
<p>La première partie d&#8217;un HTLC est le <em>hachage</em> (hash). Cela fait référence à l&#8217;utilisation d&#8217;un algorithme de hachage cryptographique afin de s&#8217;engager pour un secret généré de manière aléatoire. La connaissance du secret permet le remboursement du paiement. La fonction de hachage cryptographique garantit que même s&#8217;il est impossible pour quiconque de deviner la préimage secrète, il est facile pour quiconque de vérifier le hachage, et il n&#8217;y a qu&#8217;une seule préimage possible qui résout la condition de paiement.</p>
</div>
<div class="paragraph data-line-321">
<p>Dans <a href="#alice_dina_invoice_2">Alice reçoit un hachage de paiement de Dina</a> nous voyons Alice recevoir une facture Lightning de Dina. À l&#8217;intérieur de cette facture Dina a encodé un <em>hachage de paiement</em>, qui est le hachage cryptographique d&#8217;un secret produit par le nœud de Dina. Le secret de Dina s&#8217;appelle <em>préimage de paiement</em>. Le hachage de paiement agit comme un identifiant qui peut être utilisé pour acheminer le paiement vers Dina. La préimage de paiement fait office de reçu et de preuve de paiement une fois le paiement effectué.</p>
</div>
<div id="alice_dina_invoice_2" class="imageblock data-line-325">
<div class="content">
<img src="images/mtln_0808.png" alt="Alice reçoit un hachage de paiement de Dina">
</div>
<div class="title">Figure 8. Alice reçoit un hachage de paiement de Dina</div>
</div>
<div class="paragraph data-line-327">
<p>Dans le Lightning Network, la préimage de paiement de Dina ne sera pas une phrase comme Dinas secret mais un nombre aléatoire généré par le nœud de Dina. Appelons ce nombre aléatoire <em>R</em>.</p>
</div>
<div class="paragraph data-line-329">
<p>Le nœud de Dina calculera un hachage cryptographique de <em>R</em>, tel que :</p>
</div>
<ul class="simplelist">
<li><em>H</em> = SHA-256(<em>R</em>)</li>
</ul>
<div class="paragraph data-line-337">
<p>Dans cette équation, <em>H</em> est le hachage, ou <em>hachage de paiement</em> et <em>R</em> est le secret ou <em>préimage de paiement</em>.</p>
</div>
<div class="paragraph data-line-339">
<p>L&#8217;utilisation d&#8217;une fonction de hachage cryptographique est un élément qui garantit un <em>fonctionnement sans confiance</em>. Les intermédiaires de paiement n&#8217;ont pas besoin de se faire confiance car ils savent que personne ne peut deviner le secret ou le falsifier.</p>
</div>
<div class="sect3 data-line-341">
<h4 id="_les_htlc_en_bitcoin_script">Les HTLC en Bitcoin Script</h4>
<div class="paragraph data-line-343">
<p>Dans notre exemple des pièces d&#8217;or, Alice avait un contrat appliqué par service d&#8217;entiercement comme ceci :</p>
</div>
<div class="quoteblock data-line-345">
<blockquote>
<div class="paragraph data-line-346">
<p><em>Alice remboursera Bob avec 12 pièces d&#8217;or si vous pouvez montrer un message valide qui correspond au hachage :</em> 0575...f6b3. <em>Bob a 24 heures pour montrer le secret après la signature du contrat. Si Bob ne fournit pas le secret à ce moment-là, le dépôt d&#8217;Alice sera remboursé par le service d&#8217;entiercement et le contrat devient invalide.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph pagebreak-before data-line-350">
<p>Voyons comment nous implémenterions cela avec des HTLC en Bitcoin Script. Dans <a href="#received_htlc">HTLC implémenté en Bitcoin Script (BOLT #3)</a> nous voyons un Bitcoin Script d&#8217;HTLC tel qu&#8217;il est actuellement utilisé dans le Lightning Network. Vous pouvez trouver cette définition dans <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#offered-htlc-outputs" data-href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#offered-htlc-outputs">BOLT #3, Transactions</a>.</p>
</div>
<div id="received_htlc" class="exampleblock data-line-355">
<div class="title">Example 1. HTLC implémenté en Bitcoin Script (BOLT #3)</div>
<div class="content">
<div class="listingblock data-line-356">
<div class="content">
<pre># To remote node with revocation key
OP_DUP OP_HASH160 &lt;RIPEMD160(SHA256(revocationpubkey))&gt; OP_EQUAL
OP_IF
    OP_CHECKSIG
OP_ELSE
    &lt;remote_htlcpubkey&gt; OP_SWAP OP_SIZE 32 OP_EQUAL
    OP_IF
        # To local node via HTLC-success transaction.
        OP_HASH160 &lt;RIPEMD160(payment_hash)&gt; OP_EQUALVERIFY
        2 OP_SWAP &lt;local_htlcpubkey&gt; 2 OP_CHECKMULTISIG
    OP_ELSE
        # To remote node after timeout.
        OP_DROP &lt;cltv_expiry&gt; OP_CHECKLOCKTIMEVERIFY OP_DROP
        OP_CHECKSIG
    OP_ENDIF
OP_ENDIF</pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-376">
<p>Wow, ça a l&#8217;air compliqué ! Ne vous inquiétez pas cependant, nous allons procéder une étape à la fois et simplifier cela.</p>
</div>
<div class="paragraph data-line-378">
<p>Le Bitcoin Script actuellement utilisé pour le Lightning Network est assez complexe car il est optimisé pour l&#8217;efficacité de l&#8217;espace utilisé sur la chaîne, ce qui le rend très compact mais difficile à lire.</p>
</div>
<div class="paragraph data-line-380">
<p>Dans les sections suivantes, nous nous concentrerons sur les principaux éléments du script et présenterons des scripts simplifiés légèrement différents de ce qui est réellement utilisé dans Lightning.</p>
</div>
<div class="paragraph data-line-382">
<p>La partie principale du HTLC est à la ligne 10 de <a href="#received_htlc">HTLC implémenté en Bitcoin Script (BOLT #3)</a>. Construisons-le à partir de zéro !</p>
</div>
</div>
<div class="sect3 data-line-384">
<h4 id="_préimage_de_paiement_et_vérification_du_hachage">Préimage de paiement et vérification du hachage</h4>
<div class="paragraph data-line-386">
<p>Le cœur d&#8217;un HTLC est le hachage, où le paiement peut être effectué si le destinataire connaît la préimage de paiement. Alice verrouille le paiement sur un hachage de paiement spécifique et Bob doit présenter une préimage de paiement pour réclamer les fonds. Le système Bitcoin peut vérifier que la préimage de paiement de Bob est correcte en la hachant et en comparant le résultat au hachage de paiement qu&#8217;Alice a utilisé pour verrouiller les fonds.</p>
</div>
<div class="paragraph data-line-388">
<p>Cette partie d&#8217;un HTLC peut être implémentée en Bitcoin Script comme suit :</p>
</div>
<div class="listingblock data-line-390">
<div class="content">
<pre>OP_SHA256 &lt;H&gt; OP_EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-394">
<p>Alice peut créer une sortie de transaction qui paie 50 200 satoshis avec un script de verrouillage ci-dessus, remplaçant <code>&lt;H&gt;</code> avec la valeur de hachage 0575...f6b3 fournie par Dina. Ensuite, Alice peut signer cette transaction et la proposer à Bob :</p>
</div>
<div class="listingblock data-line-397">
<div class="title">Celui d&#8217;Alice offre un HTLC de 50 200 satoshis à Bob</div>
<div class="content">
<pre>OP_SHA256 0575...f6b3 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-401">
<p>Bob ne peut pas dépenser ce HTLC tant qu&#8217;il ne connaît pas le secret de Dina. Dépenser le HTLC est donc conditionné à l&#8217;accomplissement du paiement par Bob tout au long du trajet jusqu&#8217;à Dina.</p>
</div>
<div class="paragraph data-line-403">
<p>Une fois que Bob a le secret de Dina, Bob peut dépenser cette sortie avec un script de déverrouillage contenant la valeur de préimage secrète <em>R</em>.</p>
</div>
<div class="paragraph data-line-405">
<p>Le script de déverrouillage combiné au script de verrouillage produirait :</p>
</div>
<div class="listingblock data-line-407">
<div class="content">
<pre>&lt;R&gt; OP_SHA256 &lt;H&gt; OP_EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-411">
<p>Le moteur Bitcoin Script évaluerait ce script comme suit :</p>
</div>
<div class="olist arabic data-line-413">
<ol class="arabic">
<li class="data-line-413">
<p>R est poussé vers la pile.</p>
</li>
<li class="data-line-414">
<p>L&#8217;opérateur <code>OP_SHA256</code> prend la valeur R de la pile et la hache, poussant le résultat H~R~ vers la pile.</p>
</li>
<li class="data-line-415">
<p>H est poussé vers la pile.</p>
</li>
<li class="data-line-416">
<p>L&#8217;opérateur <code>OP_EQUAL</code> compare H et H~R~. S&#8217;ils sont égaux, le résultat est TRUE, le script est terminé et le paiement est vérifié.</p>
</li>
</ol>
</div>
</div>
<div class="sect3 data-line-418">
<h4 id="_extension_des_htlc_dalice_vers_dina">Extension des HTLC d&#8217;Alice vers Dina</h4>
<div class="paragraph data-line-420">
<p>Alice va maintenant étendre le HTLC sur le réseau afin qu&#8217;il atteigne Dina.</p>
</div>
<div class="paragraph data-line-422">
<p>Dans <a href="#alice_dina_htlc_1">Propagation du HTLC sur le réseau</a>, nous voyons le HTLC se propager à travers le réseau d&#8217;Alice à Dina. Alice a donné à Bob un HTLC pour 50 200 satoshis. Bob peut maintenant créer un HTLC pour 50 100 satoshis et le donner à Chan.</p>
</div>
<div class="paragraph data-line-424">
<p>Bob sait que Chan ne peut pas réclamer le HTLC de Bob sans diffuser le secret, auquel cas Bob peut également utiliser le secret pour réclamer le HTLC d&#8217;Alice. C&#8217;est un point très important car il assure <em>l&#8217;atomicité</em> de bout en bout du HTLC. Pour dépenser le HTLC, il faut révéler le secret, ce qui permet ensuite aux autres de dépenser également leur HTLC. Soit tous les HTLC sont dépensables, soit aucun des HTLC n&#8217;est dépensable : l&#8217;atomicité !</p>
</div>
<div class="paragraph data-line-426">
<p>Parce que le HTLC d&#8217;Alice est supérieur de 100 satoshis au HTLC que Bob a donné à Chan, Bob gagnera 100 satoshis comme frais de routage si ce paiement est effectué.</p>
</div>
<div class="paragraph data-line-428">
<p>Bob ne prend pas de risque et ne fait pas confiance à Alice ou Chan. Au lieu de cela, Bob espère qu&#8217;une transaction signée avec le secret sera échangeable sur la blockchain Bitcoin.</p>
</div>
<div id="alice_dina_htlc_1" class="imageblock data-line-432">
<div class="content">
<img src="images/mtln_0809.png" alt="Propagation du HTLC sur le réseau">
</div>
<div class="title">Figure 9. Propagation du HTLC sur le réseau</div>
</div>
<div class="paragraph data-line-434">
<p>De même, Chan peut étendre un HTLC de 50 000 à Dina. Il ne risque rien et ne fait pas confiance à Bob ou Dina. Pour réclamer le HTLC, Dina devrait diffuser le secret, que Chan pourrait utiliser pour racheter le HTLC de Bob. Chan gagnerait également 100 satoshis comme frais de routage.</p>
</div>
</div>
<div class="sect3 data-line-436">
<h4 id="_rétropropagation_du_secret">Rétropropagation du secret</h4>
<div class="paragraph data-line-438">
<p>Une fois que Dina reçoit un HTLC de 50 000 de Chan, elle peut maintenant être payée. Dina pourrait simplement commettre ce HTLC sur la chaîne et le dépenser en révélant le secret de la transaction de dépense. Ou, à la place, Dina peut mettre à jour le solde du canal avec Chan en lui donnant le secret. Il n&#8217;y a aucune raison d&#8217;engager des frais de transaction et d&#8217;aller sur la chaîne. Ainsi, à la place, Dina envoie le secret à Chan, et ils acceptent de mettre à jour les soldes de leurs canaux pour refléter un paiement de 50 000 satoshis Lightning à Dina. Dans <a href="#alice_dina_htlc_redeem_1">Dina règle le HTLC de Chan hors chaîne</a> nous voyons Dina donner le secret à Chan, accomplissant ainsi le HTLC.</p>
</div>
<div id="alice_dina_htlc_redeem_1" class="imageblock data-line-442">
<div class="content">
<img src="images/mtln_0810.png" alt="Dina règle le HTLC de Chan hors chaîne">
</div>
<div class="title">Figure 10. Dina règle le HTLC de Chan hors chaîne</div>
</div>
<div class="paragraph data-line-444">
<p>Notez que le solde des canaux de Dina passe de 50 000 satoshis à 100 000 satoshis. Le solde des canaux de Chan est réduit de 200 000 satoshis à 150 000 satoshis. La capacité du canal n&#8217;a pas changé, mais 50 000 sont passées du côté du canal de Chan au côté du canal de Dina.</p>
</div>
<div class="paragraph data-line-446">
<p>Chan a maintenant le secret et a payé 50 000 satoshis à Dina. Il peut le faire sans aucun risque, car le secret permet à Chan de réclamer le HTLC de 50 100 de Bob. Chan a la possibilité de valider ce HTLC sur la chaîne et de le dépenser en révélant le secret sur la blockchain Bitcoin. Mais, comme Dina, il préfère éviter les frais de transaction. Donc, à la place, il envoie le secret à Bob afin qu&#8217;ils puissent mettre à jour les soldes de leurs canaux pour refléter un paiement Lightning de 50 100 satoshis de Bob à Chan. Dans <a href="#alice_dina_htlc_redeem_2">Chan règle le HTLC de Bob hors chaîne</a> nous voyons Chan envoyer le secret à Bob et recevoir un paiement en retour.</p>
</div>
<div id="alice_dina_htlc_redeem_2" class="imageblock data-line-450">
<div class="content">
<img src="images/mtln_0811.png" alt="Chan règle le HTLC de Bob hors chaîne">
</div>
<div class="title">Figure 11. Chan règle le HTLC de Bob hors chaîne</div>
</div>
<div class="paragraph data-line-452">
<p>Chan a payé 50 000 satoshis à Dina et a reçu 50 100 satoshis de Bob. Chan a donc 100 satoshi de plus dans ses soldes de canaux, qu&#8217;il a gagnés comme frais de routage.</p>
</div>
<div class="paragraph data-line-454">
<p>Bob a maintenant le secret aussi. Il peut l&#8217;utiliser pour dépenser le HTLC d&#8217;Alice sur la chaîne. Ou, il peut éviter les frais de transaction en réglant le HTLC dans le canal avec Alice. Dans <a href="#alice_dina_htlc_redeem_3">Bob règle le HTLC d&#8217;Alice hors chaîne</a> nous voyons que Bob envoie le secret à Alice et ils mettent à jour le solde du canal pour refléter un paiement Lightning de 50 200 satoshis d&#8217;Alice à Bob.</p>
</div>
<div id="alice_dina_htlc_redeem_3" class="imageblock data-line-458">
<div class="content">
<img src="images/mtln_0812.png" alt="Bob règle le HTLC d&#8217;Alice hors chaîne">
</div>
<div class="title">Figure 12. Bob règle le HTLC d&#8217;Alice hors chaîne</div>
</div>
<div class="paragraph data-line-460">
<p>Bob a reçu 50 200 satoshis d&#8217;Alice et a payé 50 100 satoshis à Chan, il a donc 100 satoshis supplémentaires dans ses soldes de canaux issus des frais de routage.</p>
</div>
<div class="paragraph data-line-462">
<p>Alice reçoit le secret et a réglé le HTLC de 50 200 satoshis. Le secret peut être utilisé comme un <em>reçu</em> pour prouver que Dina a été payée pour ce hachage de paiement spécifique.</p>
</div>
<div class="paragraph data-line-464">
<p>Les soldes finaux des canaux reflètent le paiement d&#8217;Alice à Dina et les frais de routage payés à chaque saut, comme indiqué dans <a href="#alice_dina_htlc_redeem_4">Soldes des canaux après le paiement</a>.</p>
</div>
<div id="alice_dina_htlc_redeem_4" class="imageblock data-line-468">
<div class="content">
<img src="images/mtln_0813.png" alt="Soldes des canaux après le paiement">
</div>
<div class="title">Figure 13. Soldes des canaux après le paiement</div>
</div>
</div>
<div class="sect3 data-line-471">
<h4 id="preventing_theft">Liaison de signature : Prévenir le vol des HTLC</h4>
<div class="paragraph data-line-473">
<p>Il y a un hic. L&#8217;avez-vous remarqué ?</p>
</div>
<div class="paragraph data-line-475">
<p>Si Alice, Bob et Chan créent les HTLC comme indiqué dans <a href="#alice_dina_htlc_redeem_4">Soldes des canaux après le paiement</a>, ils font face à un risque de perte faible mais non négligeable. N&#8217;importe lequel de ces HTLC peut être réclamé (dépensé) par quiconque connaît le secret. Au début, seule Dina connaît le secret. Dina est censée ne dépenser que le HTLC de Chan. Mais Dina pourrait dépenser les trois HTLC en même temps, ou même en une seule transaction de dépense ! Après tout, Dina connaît le secret avant tout le monde. De même, une fois que Chan connaît le secret, il n&#8217;est censé dépenser que le HTLC proposé par Bob. Mais que se passe-t-il si Chan dépense également le HTLC proposé par Alice ?</p>
</div>
<div class="paragraph data-line-477">
<p>Ce n&#8217;est pas <em>sans confiance</em> ! C&#8217;est l&#8217;élément de sécurité le plus important qui n&#8217;est pas respecté. Nous devons y remédier.</p>
</div>
<div class="paragraph data-line-479">
<p>Le script HTLC doit comporter une condition supplémentaire qui lie chaque HTLC à un destinataire spécifique. Pour ce faire, nous exigeons une signature numérique correspondant à la clé publique de chaque destinataire, ce qui empêche toute autre personne de dépenser ce HTLC. Étant donné que seul le destinataire désigné a la capacité de produire une signature numérique correspondant à cette clé publique, seul le destinataire désigné peut dépenser ce HTLC.</p>
</div>
<div class="paragraph data-line-481">
<p>Regardons à nouveau les scripts avec cette modification à l&#8217;esprit. Le HTLC d&#8217;Alice pour Bob est modifié pour inclure la clé publique de Bob et l&#8217;opérateur OP_CHECKSIG.</p>
</div>
<div class="paragraph data-line-483">
<p>Voici le script HTLC modifié :</p>
</div>
<div class="listingblock data-line-485">
<div class="content">
<pre>OP_SHA256 &lt;H&gt; OP_EQUALVERIFY &lt;Bob's Pub&gt; OP_CHECKSIG</pre>
</div>
</div>
<div class="admonitionblock tip data-line-490">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-491">
<p>Notez que nous avons également changé OP_EQUAL en OP_EQUALVERIFY. Lorsqu&#8217;un opérateur a le suffixe VERIFY, il ne renvoie pas TRUE ou FALSE sur la pile. Au lieu de cela, il <em>interrompt</em> l&#8217;exécution et fait échouer le script si le résultat est faux et continue sans aucune sortie de pile s&#8217;il est vrai.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-494">
<p>Pour réclamer ce HTLC, Bob doit présenter un script de déverrouillage qui inclut une signature de la clé privée de Bob ainsi que la préimage de paiement secrète, comme ceci :</p>
</div>
<div class="listingblock data-line-496">
<div class="content">
<pre>&lt;Bob's Signature&gt; &lt;R&gt;</pre>
</div>
</div>
<div class="paragraph data-line-500">
<p>Les scripts de déverrouillage et de verrouillage sont combinés et évalués par le moteur de script, comme suit :</p>
</div>
<div class="listingblock data-line-502">
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;R&gt; OP_SHA256 &lt;H&gt; OP_EQUALVERIFY &lt;Bob's Pub&gt; OP_CHECKSIG</pre>
</div>
</div>
<div class="olist arabic data-line-506">
<ol class="arabic">
<li class="data-line-506">
<p>+&lt;Bob&#8217;s Sig&gt; + est poussé vers la pile.</p>
</li>
<li class="data-line-507">
<p>R est poussé vers la pile.</p>
</li>
<li class="data-line-508">
<p>OP_SHA256 apparaît et hache R depuis le haut de la pile et pousse H~R~ vers la pile.</p>
</li>
<li class="data-line-509">
<p>H est poussé vers la pile.</p>
</li>
<li class="data-line-510">
<p>OP_EQUALVERIFY extrait H et H~R~ et les compare. S&#8217;ils ne sont pas identiques, l&#8217;exécution s&#8217;arrête. Sinon, nous continuons sans sortie vers la pile.</p>
</li>
<li class="data-line-511">
<p>La clé &lt;Bob's Pub&gt; est poussée vers la pile.</p>
</li>
<li class="data-line-512">
<p>OP_CHECKSIG extrait &lt;Bob's Sig&gt; et &lt;Bob's Pub&gt; et vérifie la signature. Le résultat (<code>TRUE/FALSE</code>) est poussé vers la pile.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-514">
<p>Comme vous pouvez le voir, c&#8217;est un peu plus compliqué, mais maintenant nous avons corrigé le HTLC et nous nous sommes assurés que seul le destinataire prévu peut le dépenser.</p>
</div>
</div>
<div class="sect3 data-line-516">
<h4 id="_optimisation_du_hachage">Optimisation du hachage</h4>
<div class="paragraph data-line-518">
<p>Examinons la première partie du script HTLC jusqu&#8217;à présent :</p>
</div>
<div class="listingblock data-line-520">
<div class="content">
<pre>OP_SHA256 &lt;H&gt; OP_EQUALVERIFY</pre>
</div>
</div>
<div class="paragraph data-line-524">
<p>Si nous regardons cela dans la représentation symbolique précédente, il semble que les opérateurs OP_ prennent le plus de place. Mais ce n&#8217;est pas le cas. Bitcoin Script est codé en binaire, chaque opérateur représentant un octet. Pendant ce temps, le &lt;H&gt; la valeur que nous utilisons comme espace réservé pour le hachage de paiement est une valeur de 32 octets (256 bits). Vous pouvez trouver une liste de tous les opérateurs Bitcoin Script et leur encodage binaire et hexadécimal dans <a href="https://en.bitcoin.it/wiki/Script" data-href="https://en.bitcoin.it/wiki/Script">Bitcoin Wiki: Script</a>, ou dans <a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/appdx-scriptops.asciidoc" data-href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/appdx-scriptops.asciidoc">Appendix D, "Transaction Script Language Operators, Constants, and Symbols," in <em>Maîtriser Bitcoin</em></a>.</p>
</div>
<div class="paragraph data-line-526">
<p>Représenté en hexadécimal, notre script HTLC ressemblerait à ceci :</p>
</div>
<div class="listingblock data-line-528">
<div class="content">
<pre>a8 0575965b3b44be51e8057d551c4016d83cb1fba9ea8d6e986447ba33fe69f6b3 88</pre>
</div>
</div>
<div class="paragraph data-line-532">
<p>En codage hexadécimal, OP_SHA256 est a8 et OP_EQUALVERIFY est 88. La longueur totale de ce script est de 34 octets, dont 32 octets sont le hachage.</p>
</div>
<div class="paragraph data-line-534">
<p>Comme nous l&#8217;avons mentionné précédemment, tout participant au Lightning Network devrait pouvoir prendre une transaction hors chaîne qu&#8217;il détient et la mettre sur la chaîne s&#8217;ils ont besoin de faire valoir leur réclamation de fonds. Pour effectuer une transaction sur la chaîne, ils devraient payer des frais de transaction aux mineurs, et ces frais sont proportionnels à la taille, en octets, de la transaction.</p>
</div>
<div class="paragraph data-line-536">
<p>Par conséquent, nous voulons trouver des moyens de minimiser le "poids" des transactions sur la chaîne en optimisant le script autant que possible. Une façon de faire est d&#8217;ajouter une autre fonction de hachage au-dessus de l&#8217;algorithme SHA-256, une qui produit des hachages plus petits. Le langage Bitcoin Script fournit l&#8217;opérateur OP_HASH160 qui opère un "double hachage" d&#8217;une préimage : d&#8217;abord la préimage est hachée avec SHA-256, puis le hachage résultant est à nouveau haché avec l&#8217;algorithme de hachage RIPEMD160. Le hachage résultant de RIPEMD160 est de 160 bits ou 20 octets - beaucoup plus compact. Dans Bitcoin Script, il s&#8217;agit d&#8217;une optimisation très courante utilisée dans de nombreux formats d&#8217;adresse courants.</p>
</div>
<div class="paragraph data-line-538">
<p>Alors, utilisons cette optimisation à la place. Notre hachage SHA-256 est 057596...69f6b3. En soumettant cela à un autre cycle de hachage avec RIPEMD160, nous obtenons le résultat :</p>
</div>
<div class="listingblock data-line-540">
<div class="content">
<pre>R = "Dinas secret"
H256 = SHA256(R)
H256 = 0575965b3b44be51e8057d551c4016d83cb1fba9ea8d6e986447ba33fe69f6b3
H160 = RIPEMD160(H256)
H160 = 9e017f6767971ed7cea17f98528d5f5c0ccb2c71</pre>
</div>
</div>
<div class="paragraph data-line-548">
<p>Alice peut calculer le hachage RIPEMD160 du hachage de paiement fourni par Dina et utiliser le hachage le plus court dans son HTLC, tout comme Bob et Chan !</p>
</div>
<div class="paragraph pagebreak-before data-line-551">
<p>Le script HTLC "optimisé" ressemblerait à ceci :</p>
</div>
<div class="listingblock data-line-553">
<div class="content">
<pre>OP_HASH160 &lt;H160&gt; OP_EQUALVERIFY</pre>
</div>
</div>
<div class="paragraph data-line-557">
<p>Encodé en hexadécimal, c&#8217;est :</p>
</div>
<div class="listingblock data-line-559">
<div class="content">
<pre>a9 9e017f6767971ed7cea17f98528d5f5c0ccb2c71 88</pre>
</div>
</div>
<div class="paragraph data-line-563">
<p>Où OP_HASH160 est a9 et OP_EQUALVERIFY est 88. Ce script ne fait que 22 octets ! Nous avons économisé 12 octets pour chaque transaction qui rachète un HTLC sur la chaîne.</p>
</div>
<div class="paragraph data-line-565">
<p>Avec cette optimisation, vous voyez maintenant comment nous arrivons au script HTLC illustré à la ligne 10 de <a href="#received_htlc">HTLC implémenté en Bitcoin Script (BOLT #3)</a> :</p>
</div>
<div class="listingblock data-line-567">
<div class="content">
<pre>...
    # To local node via HTLC-success transaction.
    OP_HASH160 &lt;RIPEMD160(payment_hash)&gt; OP_EQUALVERIFY...</pre>
</div>
</div>
</div>
<div class="sect3 data-line-573">
<h4 id="_échec_coopératif_du_htlc_et_du_délai_dattente">Échec coopératif du HTLC et du délai d&#8217;attente</h4>
<div class="paragraph data-line-575">
<p>Jusqu&#8217;à présent, nous avons examiné la partie "hachage" des HTLC et la manière dont elle fonctionnerait si tout le monde coopère et est en ligne au moment du paiement.</p>
</div>
<div class="paragraph data-line-577">
<p>Que se passe-t-il si quelqu&#8217;un se déconnecte ou ne coopère pas ? Que se passe-t-il si le paiement ne peut pas aboutir ?</p>
</div>
<div class="paragraph data-line-579">
<p>Nous devons garantir un moyen "d&#8217;échouer gracieusement", car les échecs de routage occasionnels sont inévitables. Il y a deux manières d&#8217;échouer : de manière coopérative et avec un remboursement verrouillé dans le temps.</p>
</div>
<div class="paragraph data-line-581">
<p>L&#8217;échec coopératif est relativement simple : le HTLC est défait par chaque participant de la route, supprimant la sortie HTLC de leurs transactions d&#8217;engagement sans modifier le solde. Nous verrons comment cela fonctionne en détail dans <a href="#channel_operation">[channel_operation]</a>.</p>
</div>
<div class="paragraph data-line-583">
<p>Voyons comment nous pouvons inverser un HTLC sans la coopération d&#8217;un ou plusieurs participants. Nous devons nous assurer que si l&#8217;un des participants ne coopère pas, les fonds ne sont pas simplement bloqués dans le HTLC <em>pour toujours</em>. Cela donnerait à quelqu&#8217;un la possibilité de rançonner les fonds d&#8217;un autre participant : "Je laisserai vos fonds immobilisés pour toujours si vous ne me payez pas une rançon."</p>
</div>
<div class="paragraph data-line-585">
<p>Pour éviter cela, chaque script HTLC inclut une clause de remboursement qui est connectée à un timelock. Vous souvenez-vous de notre contrat d&#8217;entiercement original ? "Bob a 24 heures pour montrer le secret après la signature du contrat. Si Bob ne fournit pas le secret à ce moment-là, le dépôt d&#8217;Alice sera remboursé."</p>
</div>
<div class="paragraph data-line-587">
<p>Le remboursement verrouillé dans le temps est une partie importante du script qui garantit <em>l&#8217;atomicité</em>, de sorte que l&#8217;ensemble du paiement de bout en bout réussisse ou échoue gracieusement. Il n&#8217;y a pas d&#8217;état "à moitié payé" à craindre. En cas d&#8217;échec, chaque participant peut soit défaire le HTLC en coopération avec son partenaire de canal, soit mettre unilatéralement la transaction de remboursement avec un timelock sur la chaîne pour récupérer leur argent.</p>
</div>
<div class="paragraph data-line-589">
<p>Pour mettre en œuvre ce remboursement dans Bitcoin Script, nous utilisons un opérateur spécial <code>O&#x2060;P&#x2060;_&#x2060;C&#x2060;H&#x2060;E&#x2060;C&#x2060;K&#x2060;L&#x2060;O&#x2060;C&#x2060;K&#x2060;T&#x2060;I&#x2060;M&#x2060;E&#x200b;V&#x2060;E&#x2060;R&#x2060;I&#x2060;F&#x2060;Y</code> également appelé OP_CLTV en abrégé. Voici le script, tel que vu précédemment à la ligne 13 de <a href="#received_htlc">HTLC implémenté en Bitcoin Script (BOLT #3)</a> :</p>
</div>
<div class="listingblock data-line-591">
<div class="content">
<pre>...
	OP_DROP &lt;cltv_expiry&gt; OP_CHECKLOCKTIMEVERIFY OP_DROP
	OP_CHECKSIG
...</pre>
</div>
</div>
<div class="paragraph data-line-598">
<p>L&#8217;opérateur OP_CLTV prend un temps d&#8217;expiration défini comme la hauteur de bloc après laquelle cette transaction est valide. Si le verrouillage de la transaction n&#8217;est pas défini de la même manière que &lt;cltv_expiry&gt;, l&#8217;évaluation du script échoue et la transaction est invalide. Sinon, le script continue sans aucune sortie vers la pile. N&#8217;oubliez pas que le suffixe VERIFY signifie que cet opérateur ne produit pas TRUE ou FALSE mais s&#8217;arrête/échoue ou continue sans sortie de pile.</p>
</div>
<div class="paragraph data-line-600">
<p>Essentiellement, le OP_CLTV agit comme un "gardien" empêchant le script d&#8217;aller plus loin si la hauteur de bloc &lt;cltv_expiry&gt; n&#8217;a pas été atteinte sur la blockchain Bitcoin.</p>
</div>
<div class="paragraph data-line-602">
<p>L&#8217;opérateur OP_DROP supprime simplement l&#8217;élément le plus haut sur la pile de script. Ceci est nécessaire au début car il subsiste un élément "restant" des lignes de script précédentes. Il faut <em>après</em> OP_CLTV supprimer l&#8217;élément &lt;cltv_expiry&gt; du haut de la pile car il n&#8217;est plus nécessaire.</p>
</div>
<div class="paragraph data-line-604">
<p>Enfin, une fois la pile nettoyée, il devrait rester une clé publique et une signature que OP_CHECKSIG peut vérifier. Comme nous l&#8217;avons vu dans <a href="#preventing_theft">Liaison de signature : Prévenir le vol des HTLC</a>, cela est nécessaire pour s&#8217;assurer que seul le propriétaire légitime des fonds peut les réclamer, en liant cette sortie à leur clé publique et en exigeant une signature.</p>
</div>
</div>
<div class="sect3 data-line-606">
<h4 id="_décrémentation_des_timelocks">Décrémentation des timelocks</h4>
<div class="paragraph data-line-608">
<p>Comme les HTLC sont étendus d&#8217;Alice à Dina, la clause de remboursement avec un timelock dans chaque HTLC a une valeur  cltv_expiry <em>différente</em>. Nous verrons cela plus en détail dans <a href="#onion_routing">[onion_routing]</a>. Mais il est suffisant de dire qu&#8217;afin d&#8217;assurer le bon dénouement d&#8217;un paiement qui échoue, chaque saut doit attendre un peu moins longtemps pour être remboursé. La différence entre les timelocks pour chaque saut est appelée cltv_expiry_delta, et est fixée par chaque nœud et annoncée au réseau, comme nous le verrons dans <a href="#gossip">[gossip]</a>.</p>
</div>
<div class="paragraph data-line-610">
<p>Par exemple, Alice définit le timelock de remboursement sur le premier HTLC à une hauteur de bloc de : courant + 500 blocs ("courant" étant la hauteur de bloc courante). Bob définirait alors le timelock cltv_expiry sur le HTLC vers Chan à : courant + 450 blocs. Chan définirait le timelock à : courant + 400 blocs depuis la hauteur de bloc courante. De cette façon, Chan peut obtenir un remboursement sur le HTLC qu&#8217;il a proposé à Dina <em>avant</em> que Bob obtienne un remboursement du HTLC qu&#8217;il a proposé à Chan. Bob peut obtenir un remboursement du HTLC qu&#8217;il a proposé à Chan avant qu&#8217;Alice ne puisse obtenir un remboursement du HTLC qu&#8217;elle a proposé à Bob. Le timelock décroissant empêche les situations de compétition et garantit que la chaîne de HTLC est dénouée en sens inverse, de la destination vers le point d&#8217;origine.</p>
</div>
</div>
</div>
<div class="sect2 data-line-612">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph data-line-614">
<p>Dans ce chapitre, nous avons vu comment Alice peut payer Dina même si elle n&#8217;a pas de canal de paiement direct. Alice peut trouver un chemin qui la relie à Dina et acheminer un paiement sur plusieurs canaux de paiement afin qu&#8217;il parvienne à Dina.</p>
</div>
<div class="paragraph data-line-616">
<p>Pour s&#8217;assurer que le paiement est atomique et sans confiance sur plusieurs sauts, Alice doit implémenter un protocole d&#8217;équité en coopération avec tous les nœuds intermédiaires du chemin. Le protocole d&#8217;équité est actuellement mis en œuvre par des HTLC qui engagent des fonds sur un hachage de paiement dérivé d&#8217;une préimage de paiement secrète.</p>
</div>
<div class="paragraph data-line-618">
<p>Chacun des participants de la route de paiement peut étendre un HTLC au participant suivant, sans se soucier des vols ou des fonds bloqués. Le HTLC peut être réclamé en révélant la préimage de paiement secrète. Lorsqu&#8217;un HTLC atteint Dina, elle révèle la pré-image, qui circule en sens inverse, résolvant ainsi toutes les HTLC proposés.</p>
</div>
<div class="paragraph data-line-620">
<p>Enfin, nous avons vu comment une clause de remboursement avec un timelock complète le HTLC, garantissant que chaque participant peut obtenir un remboursement si le paiement échoue mais que, pour une raison quelconque, l&#8217;un des participants ne coopère pas au dénouement des HTLC. En ayant toujours la possibilité d&#8217;aller sur la chaîne pour un remboursement, le HTLC atteint l&#8217;objectif d&#8217;équité de l&#8217;atomicité et du fonctionnement sans confiance.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-04-28 02:37:56 -0400
</div>
</div>
</body>
</html>